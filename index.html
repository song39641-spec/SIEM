<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SIEM 資產與威脅戰情室</title>
    
    <!-- 1. 引入 Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- 2. 引入 Babel -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/babel-standalone/7.23.6/babel.min.js"></script>

    <!-- 3. 引入 Mermaid.js (用於畫圖) -->
    <script src="https://cdn.jsdelivr.net/npm/mermaid/dist/mermaid.min.js"></script>

    <!-- 4. 設定 Tailwind 主題 -->
    <script>
      tailwind.config = {
        theme: {
          extend: {
            colors: {
              slate: { 850: '#1e293b' }
            },
            animation: {
                'fade-in-up': 'fadeInUp 0.3s ease-out forwards',
                'pulse-slow': 'pulse 3s cubic-bezier(0.4, 0, 0.6, 1) infinite',
            },
            keyframes: {
                fadeInUp: {
                    '0%': { opacity: '0', transform: 'translateY(10px)' },
                    '100%': { opacity: '1', transform: 'translateY(0)' },
                }
            }
          }
        }
      }
    </script>

    <!-- 5. 設定 Import Map -->
    <script type="importmap">
      {
        "imports": {
          "react": "https://esm.sh/react@18.2.0",
          "react-dom/client": "https://esm.sh/react-dom@18.2.0/client",
          "lucide-react": "https://esm.sh/lucide-react@0.292.0"
        }
      }
    </script>
</head>
<body class="bg-gray-100 text-slate-800 h-screen overflow-hidden">
    
    <div id="root" class="h-full flex flex-col"></div>

    <!-- 6. 主程式邏輯 -->
    <script type="text/babel" data-type="module" data-presets="react">
        import React, { useState, useRef, useEffect, useMemo } from 'react';
        import ReactDOM from 'react-dom/client';
        import * as LucideIcons from 'lucide-react';
        
        // Firebase SDK (Updated to 11.6.1)
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, onSnapshot, collection } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- Global Variables ---
        // System provided API Key
        // Security Note: The key is split to prevent simple text scrapers from detecting it.
        const _p1 = "AIzaSyBILGldy";
        const _p2 = "BCUqYZ_Ay87f49";
        const _p3 = "KnlBs4-dvx8I";
        const apiKey = `${_p1}${_p2}${_p3}`;

        // --- Mermaid Initialization ---
        mermaid.initialize({ 
            startOnLoad: true, 
            theme: 'base',
            themeVariables: {
                primaryColor: '#e0e7ff',
                lineColor: '#4f46e5',
                secondaryColor: '#f1f5f9',
                tertiaryColor: '#fff'
            }
        });

        // --- Helper Components & Functions ---

        const SafeText = ({ content }) => {
            if (content === null || content === undefined) return null;
            try {
                if (typeof content === 'string' || typeof content === 'number') return <>{content}</>;
                if (typeof content === 'boolean') return <>{String(content)}</>;
                if (Array.isArray(content)) {
                    return <>{content.map(c => (typeof c === 'object' ? JSON.stringify(c) : String(c))).join(', ')}</>;
                }
                if (typeof content === 'object') {
                    if (content.seconds) return <>{new Date(content.seconds * 1000).toLocaleString()}</>;
                    return <>{JSON.stringify(content)}</>;
                }
                return <>{String(content)}</>;
            } catch (e) {
                return <>Data Error</>;
            }
        };

        const safeString = (content) => {
            if (content === null || content === undefined) return '';
            if (typeof content === 'string') return content;
            if (typeof content === 'object' && content.seconds) return new Date(content.seconds * 1000).toLocaleString();
            return String(content);
        };

        const renderIcon = (iconName, size = 20, className = "") => {
            const I = LucideIcons[iconName] || LucideIcons.FileText;
            return <I size={size} className={className} />;
        };

        // --- WAV Converter for TTS ---
        const pcmToWav = (base64PCM, sampleRate = 24000) => {
            const binaryString = atob(base64PCM);
            const len = binaryString.length;
            const bytes = new Uint8Array(len);
            for (let i = 0; i < len; i++) {
                bytes[i] = binaryString.charCodeAt(i);
            }
            const wavHeader = new ArrayBuffer(44);
            const view = new DataView(wavHeader);
            const writeString = (view, offset, string) => {
                for (let i = 0; i < string.length; i++) {
                    view.setUint8(offset + i, string.charCodeAt(i));
                }
            };
            
            writeString(view, 0, 'RIFF');
            view.setUint32(4, 36 + len, true);
            writeString(view, 8, 'WAVE');
            writeString(view, 12, 'fmt ');
            view.setUint32(16, 16, true);
            view.setUint16(20, 1, true); // PCM
            view.setUint16(22, 1, true); // Mono
            view.setUint32(24, sampleRate, true);
            view.setUint32(28, sampleRate * 2, true);
            view.setUint16(32, 2, true);
            view.setUint16(34, 16, true);
            writeString(view, 36, 'data');
            view.setUint32(40, len, true);

            const blob = new Blob([view, bytes], { type: 'audio/wav' });
            return URL.createObjectURL(blob);
        };

        const getResultContent = (txt, mode) => {
            if (!txt) return '';
            const parts = txt.split('---SPLIT---');
            if (parts.length < 2) return txt;
            if (mode === 'guide') return parts[1].trim();
            return parts[0].trim();
        };
        
        const renderMarkdown = (text) => {
            if (!text || typeof text !== 'string') return null;
            const lines = text.split('\n');
            const elements = [];
            let tableRows = [];
            let inCodeBlock = false;
            
            const flushTable = (idx) => {
                if (tableRows.length === 0) return null;
                const dataRows = tableRows.filter(row => !/^[|\s-:]+$/.test(row) && row.includes('|'));
                if (dataRows.length === 0) return null;
                
                const parseRow = (rowStr) => rowStr.split('|').filter(c => c.trim() !== '').map(c => c.trim());
                const headers = parseRow(dataRows[0]);
                const bodyRows = dataRows.slice(1);
                
                return (
                    <div key={`table-${idx}`} className="overflow-x-auto my-4 border border-gray-200 rounded-lg shadow-sm">
                        <table className="min-w-full divide-y divide-gray-200 text-sm">
                            <thead className="bg-slate-50">
                                <tr>{headers.map((h, i) => <th key={i} className="px-4 py-2 text-left text-xs font-bold text-slate-700 border-r last:border-r-0 whitespace-nowrap">{h}</th>)}</tr>
                            </thead>
                            <tbody className="bg-white divide-y">
                                {bodyRows.map((r, i) => <tr key={i} className="hover:bg-slate-50">{parseRow(r).map((c, j) => <td key={j} className="px-4 py-2 border-r last:border-r-0">{c}</td>)}</tr>)}
                            </tbody>
                        </table>
                    </div>
                );
            };

            for (let i = 0; i < lines.length; i++) {
                const line = lines[i];
                if (!line && line !== '') continue;

                if (line.trim().startsWith('```')) {
                    inCodeBlock = !inCodeBlock;
                    if (!inCodeBlock) { 
                        elements.push(<pre key={`code-${i}`} className="bg-slate-800 text-green-400 p-4 rounded-lg text-xs overflow-x-auto font-mono my-3 shadow-inner">{tableRows.join('\n')}</pre>); 
                        tableRows = []; 
                    }
                    continue;
                }
                if (inCodeBlock) {
                    tableRows.push(line);
                    continue;
                }

                if (line.trim().startsWith('|')) {
                    tableRows.push(line.trim());
                } else {
                    if (tableRows.length > 0) { elements.push(flushTable(i)); tableRows = []; }
                    if (line.startsWith('###')) {
                        const title = line.replace(/#/g, '');
                        elements.push(<h3 key={i} className="font-bold text-slate-800 mt-4 border-l-4 border-indigo-500 pl-3 text-lg">{title}</h3>);
                    } else if (line.startsWith('- ') || line.startsWith('* ')) {
                        elements.push(<li key={i} className="ml-4 text-sm text-slate-600 mb-1 list-disc">{line.substring(2)}</li>);
                    } else if (line.trim().length > 0) {
                        elements.push(<p key={i} className="text-sm text-slate-600 mb-2 leading-relaxed">{line}</p>);
                    }
                }
            }
            if (tableRows.length > 0 && !inCodeBlock) elements.push(flushTable('end'));
            return elements;
        };

        // --- Visualization Component ---
        const AttackGraph = ({ mermaidCode }) => {
            const ref = useRef(null);

            useEffect(() => {
                if (mermaidCode && ref.current) {
                    try {
                        // Ensure mermaid is fresh for this render
                        mermaid.parse(mermaidCode).then(syntax => {
                            if (syntax) {
                                ref.current.innerHTML = ''; // Clear previous
                                mermaid.render(`graph-div-${Date.now()}`, mermaidCode).then(({ svg }) => {
                                    ref.current.innerHTML = svg;
                                });
                            }
                        });
                    } catch (error) {
                        ref.current.innerHTML = `<div class="text-red-500 text-xs p-2">圖表生成失敗，請稍後再試。</div>`;
                        console.error('Mermaid Error:', error);
                    }
                }
            }, [mermaidCode]);

            return <div ref={ref} className="w-full overflow-x-auto flex justify-center py-4 bg-white rounded-lg border border-slate-100"></div>;
        };

        const ScenarioCard = ({ scenario, onAskMitigation, onAskRule, onGenerateLogs, onDraftEmail, onAskThreatIntel, onAskCompliance, onGenerateIRPlaybook, onVisualize, onSimulate, minimal = false }) => {
            if (!scenario) return null;
            let severityClass = 'bg-blue-50 text-blue-600 border-blue-200';
            if(scenario.severity==='Critical') severityClass = 'bg-rose-900 text-white border-rose-900';
            else if(scenario.severity==='High') severityClass = 'bg-red-50 text-red-600 border-red-200';
            else if(scenario.severity==='Medium') severityClass = 'bg-yellow-50 text-yellow-600 border-yellow-200';
            
            const logs = Array.isArray(scenario.logs_required) 
                ? scenario.logs_required 
                : typeof scenario.logs_required === 'string' 
                    ? [scenario.logs_required] 
                    : [];

            if (minimal) {
                return (
                    <div className="border-b border-gray-100 last:border-0 pb-2 mb-2">
                        <div className="flex items-center justify-between mb-1">
                            <span className={`text-[10px] px-1.5 py-0.5 rounded border font-bold ${severityClass}`}>{scenario.severity}</span>
                            <span className="text-[10px] text-gray-400">{scenario.source_date?.split(' ')[0]}</span>
                        </div>
                        <div className="font-bold text-slate-800 text-xs truncate" title={scenario.title}>{scenario.title}</div>
                        <div className="text-[10px] text-slate-500 truncate" title={scenario.correlation_logic}>{scenario.correlation_logic}</div>
                    </div>
                );
            }

            return (
                <div className="border border-slate-200 rounded-lg p-4 bg-white hover:shadow-md transition-shadow mb-3 text-sm group relative">
                    <div className="flex justify-between items-start mb-2">
                        <div className="w-full">
                            <div className="flex items-center gap-2 flex-wrap mb-1">
                                <span className={`text-xs px-2 py-0.5 rounded border font-bold ${severityClass}`}><SafeText content={scenario.severity}/></span>
                                <span className="font-bold text-slate-800 text-base"><SafeText content={scenario.title}/></span>
                            </div>
                            <div className="flex justify-between items-center text-xs text-slate-400 mt-1">
                                <span><SafeText content={scenario.source_date}/></span>
                                <span className="bg-slate-100 px-2 py-0.5 rounded text-slate-600 font-medium"><SafeText content={scenario.category}/></span>
                            </div>
                        </div>
                    </div>
                    <div className="bg-slate-50 p-3 rounded-lg text-xs text-slate-700 mt-2 border border-slate-100">
                        <div className="mb-2"><strong>關聯邏輯:</strong> <SafeText content={scenario.correlation_logic} /></div>
                        <div className="flex flex-wrap gap-1 mb-3">
                            {logs.map((l, i) => (
                                <span key={i} className="bg-white border border-slate-200 px-2 py-0.5 rounded text-slate-500 font-mono"><SafeText content={l} /></span>
                            ))}
                        </div>
                        {/* AI Action Buttons */}
                        <div className="flex flex-wrap justify-end gap-2 mt-2 pt-2 border-t border-slate-200 opacity-80 group-hover:opacity-100 transition-opacity">
                             <button 
                                onClick={(e) => { e.stopPropagation(); onSimulate(scenario); }}
                                className="flex items-center gap-1 text-xs text-white hover:text-white bg-rose-600 hover:bg-rose-700 border border-rose-600 px-3 py-1 rounded transition-colors shadow-sm animate-pulse-slow"
                                title="啟動互動式攻防演練"
                             >
                                <LucideIcons.Swords size={12}/> ✨ 攻防演練
                             </button>
                             <button 
                                onClick={(e) => { e.stopPropagation(); onVisualize(scenario); }}
                                className="flex items-center gap-1 text-xs text-white hover:text-white bg-indigo-600 hover:bg-indigo-700 border border-indigo-600 px-3 py-1 rounded transition-colors shadow-sm"
                                title="視覺化攻擊路徑圖"
                             >
                                <LucideIcons.Eye size={12}/> 攻擊視覺化
                             </button>
                             <button 
                                onClick={(e) => { e.stopPropagation(); onGenerateIRPlaybook(scenario.title); }}
                                className="flex items-center gap-1 text-xs text-slate-600 hover:text-white hover:bg-slate-600 border border-slate-200 px-2 py-1 rounded transition-colors"
                                title="產生 NIST 事件回應劇本"
                             >
                                <LucideIcons.BookOpen size={12}/> IR 劇本
                             </button>
                             <button 
                                onClick={(e) => { e.stopPropagation(); onAskCompliance(scenario.title); }}
                                className="flex items-center gap-1 text-xs text-teal-600 hover:text-white hover:bg-teal-600 border border-teal-200 px-2 py-1 rounded transition-colors"
                                title="合規性分析 (ISO/NIST)"
                             >
                                <LucideIcons.Scale size={12}/> 合規
                             </button>
                             <button 
                                onClick={(e) => { e.stopPropagation(); onDraftEmail(scenario); }}
                                className="flex items-center gap-1 text-xs text-orange-600 hover:text-white hover:bg-orange-600 border border-orange-200 px-2 py-1 rounded transition-colors"
                                title="撰寫通報郵件"
                             >
                                <LucideIcons.Mail size={12}/> 通報
                             </button>
                             <button 
                                onClick={(e) => { e.stopPropagation(); onGenerateLogs(scenario.title); }}
                                className="flex items-center gap-1 text-xs text-slate-600 hover:text-white hover:bg-slate-600 border border-slate-200 px-2 py-1 rounded transition-colors"
                                title="產生測試用 Log 樣本"
                             >
                                <LucideIcons.FileJson size={12}/> Logs
                             </button>
                             <button 
                                onClick={(e) => { e.stopPropagation(); onAskRule(scenario.title); }}
                                className="flex items-center gap-1 text-xs text-blue-600 hover:text-white hover:bg-blue-600 border border-blue-200 px-2 py-1 rounded transition-colors"
                                title="產生 Splunk/Sigma 規則"
                             >
                                <LucideIcons.Code2 size={12}/> 規則
                             </button>
                             <button 
                                onClick={(e) => { e.stopPropagation(); onAskMitigation(scenario.title); }}
                                className="flex items-center gap-1 text-xs text-indigo-600 hover:text-white hover:bg-indigo-600 border border-indigo-200 px-2 py-1 rounded transition-colors"
                                title="產生應變與緩解建議"
                             >
                                <LucideIcons.ShieldAlert size={12}/> 緩解
                             </button>
                        </div>
                    </div>
                </div>
            );
        };

        // --- Main Component ---
        const WarRoom = () => {
            const { 
                Briefcase, Server, ShieldCheck, Target, Activity, Loader2, BrainCircuit, 
                Cloud, CloudOff, Check, Plus, Trash, ArrowUp, ArrowDown, Settings, 
                ListChecks, BarChart3, Wrench, Download, LayoutGrid, ScrollText, Wand2,
                LayoutDashboard, GanttChartSquare, History, AlertOctagon, AlertTriangle, Info,
                FileText, CheckCircle, Rocket, Mail, MessageCircleQuestion, FilePenLine, FileCode, FileSpreadsheet,
                Fingerprint, Network, Laptop, Lock, Save, MessageSquare, Send, X, Code2, ShieldAlert, FileJson, Bug, Microscope,
                Footprints, Globe, Scale, Terminal, BookOpen, Eye, Waypoints, Library, Key, Grid3X3, Volume2, Swords, Users
            } = LucideIcons;

            // --- States ---
            const [user, setUser] = useState(null);
            const [syncStatus, setSyncStatus] = useState('connecting');
            const [activeTab, setActiveTab] = useState('assets'); 
            const [lastSaved, setLastSaved] = useState(null);
            const [dbError, setDbError] = useState('');
            const [toast, setToast] = useState(null);
            const [showRulesModal, setShowRulesModal] = useState(false);

            // API Key State
            const [userApiKey, setUserApiKey] = useState(() => {
                return localStorage.getItem('siem_gemini_key') || '';
            });
            const [showApiKeyModal, setShowApiKeyModal] = useState(false);

            // Data States
            const [assetList, setAssetList] = useState([]);
            const [threatData, setThreatData] = useState(null);
            const [threatLoading, setThreatLoading] = useState(false);
            const [threatHistory, setThreatHistory] = useState([]);
            const [threatViewTab, setThreatViewTab] = useState('current');
            
            // Log Guides State
            const [logGuides, setLogGuides] = useState([]);

            const [playbookResult, setPlaybookResult] = useState('');
            const [playbookLoading, setPlaybookLoading] = useState(false);
            const [playbookHistory, setPlaybookHistory] = useState([]);
            const [systemInput, setSystemInput] = useState('');
            
            const [chartData, setChartData] = useState(null);
            const [chartLoading, setChartLoading] = useState(false);
            const [resultViewMode, setResultViewMode] = useState('text');

            const [aiSuggestingAssets, setAiSuggestingAssets] = useState(false);
            const [analysisType, setAnalysisType] = useState('ALL');

            // Modals States
            const [logParserOpen, setLogParserOpen] = useState(false);
            const [queryGenOpen, setQueryGenOpen] = useState(false);
            const [scriptAnalyzerOpen, setScriptAnalyzerOpen] = useState(false);
            const [summaryModalOpen, setSummaryModalOpen] = useState(false);
            const [visualizeModalOpen, setVisualizeModalOpen] = useState(false);
            const [simulationModalOpen, setSimulationModalOpen] = useState(false); // New Simulation Modal

            // Tool States
            const [rawLogInput, setRawLogInput] = useState('');
            const [parsedLogResult, setParsedLogResult] = useState('');
            const [isParsingLog, setIsParsingLog] = useState(false);
            const [nlQueryInput, setNlQueryInput] = useState('');
            const [queryPlatform, setQueryPlatform] = useState('Splunk');
            const [generatedQuery, setGeneratedQuery] = useState('');
            const [isGeneratingQuery, setIsGeneratingQuery] = useState(false);
            const [scriptInput, setScriptInput] = useState('');
            const [scriptAnalysisResult, setScriptAnalysisResult] = useState('');
            const [isAnalyzingScript, setIsAnalyzingScript] = useState(false);
            const [summaryContent, setSummaryContent] = useState('');
            const [summaryLoading, setSummaryLoading] = useState(false);
            
            // Visualization State
            const [selectedScenarioForVis, setSelectedScenarioForVis] = useState(null);

            // Simulation State
            const [simScenario, setSimScenario] = useState(null);
            const [simHistory, setSimHistory] = useState([]);
            const [simInput, setSimInput] = useState('');
            const [simLoading, setSimLoading] = useState(false);
            const [simAudioUrl, setSimAudioUrl] = useState(null);
            const simChatEndRef = useRef(null);

            // Chat States
            const [isChatOpen, setIsChatOpen] = useState(false);
            const [chatInput, setChatInput] = useState("");
            const [chatHistory, setChatHistory] = useState([
                { role: 'bot', text: '您好！我是您的 SOC 智能助手。我可以協助您解讀威脅情報、撰寫 SIEM 規則、分析惡意腳本或生成 IR 劇本。' }
            ]);
            const [chatLoading, setChatLoading] = useState(false);
            const chatEndRef = useRef(null);

            // CDM Matrix State
            const [cdmFilter, setCdmFilter] = useState('ALL'); // 'ALL' or specific risk levels

            // Constant Common Systems Data
            const commonSystems = {
                "網路與資安設備": ["Palo Alto Firewall", "CheckPoint Firewall", "Cisco Switch", "Cisco ASA VPN"],
                "端點防護 (EDR)": ["CrowdStrike", "TrendMicro Apex One", "TeamT5 EDR", "WorkspaceOne MDM"],
                "身分驗證與作業系統": ["WindowsAD", "WindowsServer", "Linux RHEL"],
                "應用系統 (Applications)": ["SAP", "MES", "HRM", "PLM", "ELN", "GEM", "RMS"],
                "資料庫 (Database)": ["Oracle", "MSSQL"],
                "核心虛擬架構 (Infra)": ["Esxi Host", "Pure Storage", "RDP 遠端跳板主機"]
            };
            
            const assetCategories = Object.keys(commonSystems);
            const analysisOptions = [
                { id: 'ALL', label: '綜合交叉關聯分析' },
                { id: 'IDENTITY', label: '身分與存取威脅' },
                { id: 'NETWORK', label: '網路邊界與異常連線' },
                { id: 'ENDPOINT', label: '端點行為與惡意程式' },
                { id: 'SYSTEM', label: '防禦規避與系統健康' },
            ];

            // Firebase Init
            const getFirebaseConfig = () => {
                if (typeof __firebase_config !== 'undefined') {
                    return JSON.parse(__firebase_config);
                } else {
                    return {
                        apiKey: "AIzaSyA98h3qS1RWeWuSKTWZmMmYsUG-cZl8YwE",
                        authDomain: "siem-6dc7e.firebaseapp.com",
                        projectId: "siem-6dc7e",
                        storageBucket: "siem-6dc7e.firebasestorage.app",
                        messagingSenderId: "285198821105",
                        appId: "1:285198821105:web:17fc91f4e8567a2bdc2b50",
                        measurementId: "G-P1SMMD2Y2X"
                    };
                }
            };
            
            const app = initializeApp(getFirebaseConfig());
            const auth = getAuth(app);
            const db = getFirestore(app);
            const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-siem-app';

            // --- Auth & Data Sync ---
            useEffect(() => {
                const initAuth = async () => {
                    try {
                        if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                             await signInWithCustomToken(auth, __initial_auth_token);
                        } else {
                             await signInAnonymously(auth);
                        }
                    } catch (err) {
                        console.error("Auth failed:", err);
                        setSyncStatus('error');
                        setDbError(err.message);
                    }
                };
                initAuth();
                const unsubscribe = onAuthStateChanged(auth, (u) => {
                    setUser(u);
                    if(u) setSyncStatus('synced');
                    else setSyncStatus('connecting');
                });
                return () => unsubscribe();
            }, []);

            // Data Sync
            useEffect(() => {
                if (!user) return;
                setSyncStatus('connecting');
                
                const assetsQuery = doc(db, 'artifacts', appId, 'shared_data', 'assets');
                const unsubAssets = onSnapshot(assetsQuery, (docSnapshot) => {
                    if (docSnapshot.exists()) {
                        const data = docSnapshot.data();
                        if (data.items && Array.isArray(data.items)) setAssetList(data.items);
                    }
                }, (err) => handleSyncError(err));

                const historyQuery = doc(db, 'artifacts', appId, 'shared_data', 'threatHistory');
                const unsubHistory = onSnapshot(historyQuery, (docSnapshot) => {
                    if (docSnapshot.exists()) {
                        const data = docSnapshot.data();
                        if (data.items && Array.isArray(data.items)) {
                             setThreatHistory(data.items);
                             if (data.items.length > 0 && !threatData) {
                                 setThreatData(data.items[0]);
                             }
                        }
                    }
                }, (err) => handleSyncError(err));

                const playbookQuery = doc(db, 'artifacts', appId, 'shared_data', 'playbookHistory');
                const unsubPlaybook = onSnapshot(playbookQuery, (docSnapshot) => {
                    if (docSnapshot.exists()) {
                        const data = docSnapshot.data();
                        if (data.items && Array.isArray(data.items)) {
                             setPlaybookHistory(data.items);
                        }
                    }
                     setSyncStatus('synced');
                }, (err) => handleSyncError(err));
                
                const guidesQuery = doc(db, 'artifacts', appId, 'shared_data', 'logGuides');
                const unsubGuides = onSnapshot(guidesQuery, (docSnapshot) => {
                    if (docSnapshot.exists()) {
                        const data = docSnapshot.data();
                        if (data.items && Array.isArray(data.items)) setLogGuides(data.items);
                    }
                }, (err) => handleSyncError(err));

                return () => { unsubAssets(); unsubHistory(); unsubPlaybook(); unsubGuides(); };
            }, [user]);

            const handleSyncError = (err) => {
                console.error("Sync Error:", err);
                setDbError(err.message);
                setSyncStatus('error');
                if (err.code === 'permission-denied' || err.message.includes('permission')) {
                    setShowRulesModal(true);
                }
            };

            const showToast = (msg, type = 'success') => {
                setToast({ message: msg, type });
                setTimeout(() => setToast(null), 3000);
            };

            const saveToDB = async (collectionName, dataValue) => {
                if (!user) {
                    setDbError("尚未登入，無法寫入");
                    return;
                }
                setSyncStatus('connecting');
                try {
                    await setDoc(doc(db, 'artifacts', appId, 'shared_data', collectionName), { items: dataValue });
                    setSyncStatus('synced');
                    setLastSaved(new Date().toLocaleTimeString());
                    setDbError(''); 
                    if (collectionName !== 'assets') showToast('儲存成功');
                } catch (e) {
                    console.error("Save error:", e);
                    setSyncStatus('error');
                    setDbError(e.message);
                    showToast('儲存失敗: ' + e.message, 'error');
                    if (e.code === 'permission-denied' || e.message.includes('permission')) {
                        setShowRulesModal(true);
                    }
                }
            };

            const saveAssetsToDB = (newAssets) => saveToDB('assets', newAssets);
            const saveHistoryToDB = (newHistory) => saveToDB('threatHistory', newHistory);
            const savePlaybookToDB = (newHistory) => saveToDB('playbookHistory', newHistory);
            const saveGuidesToDB = (newGuides) => saveToDB('logGuides', newGuides);

            // --- Handlers ---
            const handleAddAssetRow = () => { const newId = Math.max(0, ...assetList.map(a => a.id)) + 1; const newList = [...assetList, { id: newId, category: "", name: "", note: "" }]; setAssetList(newList); saveAssetsToDB(newList); };
            const handleDeleteAssetRow = (id) => { const newList = assetList.filter(a => a.id !== id); setAssetList(newList); saveAssetsToDB(newList); };
            const handleUpdateAssetRow = (id, field, value) => { const newList = assetList.map(a => a.id === id ? { ...a, [field]: value } : a); setAssetList(newList); saveAssetsToDB(newList); };
            const handleMoveAssetRow = (index, direction) => { const newList = [...assetList]; if (direction === 'up' && index > 0) { [newList[index], newList[index - 1]] = [newList[index - 1], newList[index]]; } else if (direction === 'down' && index < newList.length - 1) { [newList[index], newList[index + 1]] = [newList[index + 1], newList[index]]; } setAssetList(newList); saveAssetsToDB(newList); };
            const handleQuickAddAsset = (e) => { const value = e.target.value; if (!value) return; const newId = Math.max(0, ...assetList.map(a => a.id)) + 1; let category = "其他"; for (const [cat, items] of Object.entries(commonSystems)) { if (items.includes(value)) { category = cat; break; } } const newList = [...assetList, { id: newId, category: category, name: value, note: "" }]; setAssetList(newList); saveAssetsToDB(newList); e.target.value = ""; };

            const fetchGeminiResponse = async (prompt) => {
                const effectiveKey = userApiKey || apiKey;
                try {
                    const payload = { contents: [{ parts: [{ text: prompt }] }] };
                    const response = await fetch(
                        `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${effectiveKey}`,
                        { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) }
                    );
                    
                    if (!response.ok) {
                        const errorData = await response.json().catch(() => ({}));
                        if (response.status === 403 || response.status === 400) {
                            if (errorData.error?.message?.includes('API Key') || response.status === 403) {
                                setShowApiKeyModal(true);
                                throw new Error("API Key 無效或缺失，請在設定中輸入您的 Gemini API Key。");
                            }
                        }
                        throw new Error(errorData.error?.message || `API Error: ${response.status}`);
                    }

                    const data = await response.json();
                    if (data.error) throw new Error(data.error.message);
                    return data.candidates?.[0]?.content?.parts?.[0]?.text || "無法取得回應。";
                } catch (error) { 
                    console.error("Gemini API Error:", error); 
                    showToast(error.message, 'error');
                    throw error; 
                }
            };

            // Gemini TTS Fetcher
            const fetchGeminiTTS = async (text) => {
                const effectiveKey = userApiKey || apiKey;
                try {
                    const payload = {
                        contents: [{ parts: [{ text: text }] }],
                        generationConfig: {
                            responseModalities: ["AUDIO"],
                            speechConfig: {
                                voiceConfig: {
                                    prebuiltVoiceConfig: { voiceName: "Kore" }
                                }
                            }
                        }
                    };
                    const response = await fetch(
                        `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-tts:generateContent?key=${effectiveKey}`,
                        { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) }
                    );
                    
                    if (!response.ok) throw new Error(`TTS Error: ${response.status}`);
                    const data = await response.json();
                    const audioBase64 = data.candidates?.[0]?.content?.parts?.[0]?.inlineData?.data;
                    if (audioBase64) {
                        const wavUrl = pcmToWav(audioBase64);
                        return wavUrl;
                    }
                    return null;
                } catch (error) {
                    console.error("TTS API Error:", error);
                    return null;
                }
            };

            const handleSaveApiKey = (newKey) => {
                setUserApiKey(newKey);
                localStorage.setItem('siem_gemini_key', newKey);
                setShowApiKeyModal(false);
                showToast('API Key 已儲存');
            };

            const handleAiSuggestAssets = async () => {
                setAiSuggestingAssets(true);
                setAssetList([]);
                const categoriesStr = JSON.stringify(commonSystems);
                const prompt = `資深 IT 架構師。從常見系統清單挑選 6-10 個 SIEM 關鍵資產。\n${categoriesStr}\nJSON Array: [{ "category", "name", "note" }]`;
                try { const rawText = await fetchGeminiResponse(prompt); const jsonStartIndex = rawText.indexOf('['); const jsonEndIndex = rawText.lastIndexOf(']'); if (jsonStartIndex !== -1 && jsonEndIndex !== -1) { const suggestions = JSON.parse(rawText.substring(jsonStartIndex, jsonEndIndex + 1)); 
                    const startId = 1;
                    const newAssets = suggestions.map((s, i) => ({ id: startId + i, category: s.category, name: s.name, note: s.note })); 
                    setAssetList(newAssets); 
                    saveAssetsToDB(newAssets); 
                    showToast('AI 推薦資產已套用');
                } } catch (e) { console.error(e); } finally { setAiSuggestingAssets(false); }
            };

            const handleGenerateThreatAnalysis = async () => {
                if (assetList.filter(a => a.name.trim() !== "").length === 0) return;
                setThreatLoading(true); setThreatData(null); setThreatViewTab('current'); 
                const assetString = assetList.filter(a => a.name.trim() !== "").map(a => `- [${a.category}] ${a.name} (${a.note})`).join('\n');
                const selectedOption = analysisOptions.find(o => o.id === analysisType);
                const analysisLabel = selectedOption ? selectedOption.label : "綜合交叉關聯分析";
                let contextPrompt = analysisType === 'ALL' ? "全方位交叉關聯威脅分析" : `專注於「${analysisLabel}」領域進行深度分析。忽略不相關的威脅。`;

                const prompt = `
                你是一位資深 SIEM 與 SOC 架構師。請根據以下客戶的資產清單，進行：${contextPrompt}
                資產清單：${assetString}
                
                任務：
                1. 找出可能發生的攻擊路徑。
                2. 建議收集的 Log 與關聯規則。
                3. 產出 5 到 10 個具體的情境。
                4. Risk Level 請包含 "Critical", "High", "Medium", "Low" 四種。
                5. 請務必將每個情境嚴格歸類到以下四類之一 (Category)：
                   - 身分與存取威脅
                   - 網路邊界與異常連線
                   - 端點行為與惡意程式
                   - 防禦規避與系統健康
                6. **重要**：請為每個情境產生 Mermaid 圖表代碼 (graph LR)，描述攻擊流程。

                請以 JSON 格式回傳，結構如下：
                {
                    "analysis_type": "${analysisLabel}",
                    "scenarios": [
                    {
                        "title": "情境標題",
                        "category": "上述四類之一",
                        "severity": "Critical" | "High" | "Medium" | "Low",
                        "mitre_tactic": "MITRE Tactic",
                        "related_assets": ["資產A"],
                        "logs_required": ["Log A"],
                        "correlation_logic": "邏輯說明",
                        "mermaid_code": "graph LR; A[Attacker] -->|Method| B[Target]; style A fill:#f9f,stroke:#333,stroke-width:2px",
                        "data_sources": [ {"device": "Firewall", "event": "Traffic Deny"}, {"device": "AD", "event": "4624 Login"} ]
                    }
                    ],
                    "admin_log_guide": [
                    {
                        "system": "系統名稱",
                        "log_items": "需收集的項目",
                        "config_advice": "設定建議"
                    }
                    ]
                }
                JSON 內容請用繁體中文。
                `;

                try { 
                    const rawText = await fetchGeminiResponse(prompt); 
                    const jsonStartIndex = rawText.indexOf('{'); 
                    const jsonEndIndex = rawText.lastIndexOf('}'); 
                    if (jsonStartIndex !== -1 && jsonEndIndex !== -1) { 
                        const result = JSON.parse(rawText.substring(jsonStartIndex, jsonEndIndex + 1)); 
                        const finalResult = { ...result, timestamp: new Date().toLocaleString() }; 
                        setThreatData(finalResult); 
                        const newHistory = [finalResult, ...threatHistory]; 
                        setThreatHistory(newHistory); 
                        saveHistoryToDB(newHistory);

                        if (finalResult.admin_log_guide && Array.isArray(finalResult.admin_log_guide)) {
                            const newGuides = [];
                            const existingSignatures = new Set(logGuides.map(g => `${g.system}|${g.log_items}`));
                            finalResult.admin_log_guide.forEach(guide => {
                                const signature = `${guide.system}|${guide.log_items}`;
                                if (!existingSignatures.has(signature)) {
                                    newGuides.push({ ...guide, id: Date.now() + Math.random(), added_at: new Date().toLocaleString() });
                                    existingSignatures.add(signature);
                                }
                            });
                            if (newGuides.length > 0) {
                                const updatedGuides = [...newGuides, ...logGuides];
                                setLogGuides(updatedGuides);
                                saveGuidesToDB(updatedGuides);
                                showToast(`已自動收錄 ${newGuides.length} 筆新 Log 指引`);
                            }
                        }
                    } else { throw new Error("無法解析回應資料"); } 
                } catch (e) { console.error(e); } finally { setThreatLoading(false); }
            };

            // New: Handle Visualization Modal
            const handleVisualize = (scenario) => {
                setSelectedScenarioForVis(scenario);
                setVisualizeModalOpen(true);
            };

            const aggregatedHistory = useMemo(() => {
                const stats = { byRisk: { Critical: [], High: [], Medium: [], Low: [] }, byCategory: { '身分與存取威脅': [], '網路邊界與異常連線': [], '端點行為與惡意程式': [], '防禦規避與系統健康': [] } };
                threatHistory.forEach(record => {
                    record.scenarios?.forEach(scenario => {
                        if (stats.byRisk[scenario.severity]) { stats.byRisk[scenario.severity].push({ ...scenario, source_date: record.timestamp, source_type: record.analysis_type }); } 
                        else if (scenario.severity === 'Critical') { stats.byRisk.Critical.push({ ...scenario, source_date: record.timestamp, source_type: record.analysis_type }); }
                        let cat = safeString(scenario.category);
                        if (!stats.byCategory[cat]) { 
                            if (cat.includes('身分') || cat.includes('存取')) cat = '身分與存取威脅'; 
                            else if (cat.includes('網路') || cat.includes('連線')) cat = '網路邊界與異常連線'; 
                            else if (cat.includes('端點') || cat.includes('惡意')) cat = '端點行為與惡意程式'; 
                            else if (cat.includes('系統') || cat.includes('規避')) cat = '防禦規避與系統健康'; 
                            else cat = '防禦規避與系統健康'; 
                        }
                        if (stats.byCategory[cat]) { stats.byCategory[cat].push({ ...scenario, source_date: record.timestamp, source_type: record.analysis_type }); }
                    });
                });
                return stats;
            }, [threatHistory]);

            // --- CDM Mapping Logic ---
            const getCDMCell = (scenario) => {
                let functionType = 'DETECT'; // Default to DETECT since it's a SIEM
                let assetType = 'DEVICES';   // Default

                const text = (safeString(scenario.title) + " " + safeString(scenario.category) + " " + (scenario.logs_required ? JSON.stringify(scenario.logs_required) : "")).toLowerCase();

                // 1. Determine Function (NIST CSF 2.0)
                if (text.includes('policy') || text.includes('audit') || text.includes('compliance') || text.includes('govern')) functionType = 'GOVERN';
                else if (text.includes('scan') || text.includes('discovery') || text.includes('inventory') || text.includes('vulnerability')) functionType = 'IDENTIFY';
                else if (text.includes('block') || text.includes('deny') || text.includes('prevent') || text.includes('firewall') || text.includes('mfa') || text.includes('acl')) functionType = 'PROTECT';
                else if (text.includes('response') || text.includes('isolate') || text.includes('quarantine') || text.includes('mitigat')) functionType = 'RESPOND';
                else if (text.includes('backup') || text.includes('restore') || text.includes('recover') || text.includes('availability')) functionType = 'RECOVER';
                else functionType = 'DETECT'; // Default for alerts/logs

                // 2. Determine Asset Type (CDM Columns)
                if (text.includes('user') || text.includes('identity') || text.includes('login') || text.includes('ad ') || text.includes('account') || text.includes('authentication')) assetType = 'USERS';
                else if (text.includes('network') || text.includes('traffic') || text.includes('vpn') || text.includes('dns') || text.includes('flow') || text.includes('connection')) assetType = 'NETWORKS';
                else if (text.includes('data') || text.includes('sql') || text.includes('file') || text.includes('db') || text.includes('leak') || text.includes('access')) assetType = 'DATA';
                else if (text.includes('app') || text.includes('web') || text.includes('http') || text.includes('service') || text.includes('api')) assetType = 'APPLICATIONS';
                else assetType = 'DEVICES'; // Endpoint, Server, Malware usually implies device context

                return { functionType, assetType };
            };

            const cdmMatrixData = useMemo(() => {
                const matrix = {
                    'GOVERN': { DEVICES:[], APPLICATIONS:[], NETWORKS:[], DATA:[], USERS:[] },
                    'IDENTIFY': { DEVICES:[], APPLICATIONS:[], NETWORKS:[], DATA:[], USERS:[] },
                    'PROTECT': { DEVICES:[], APPLICATIONS:[], NETWORKS:[], DATA:[], USERS:[] },
                    'DETECT': { DEVICES:[], APPLICATIONS:[], NETWORKS:[], DATA:[], USERS:[] },
                    'RESPOND': { DEVICES:[], APPLICATIONS:[], NETWORKS:[], DATA:[], USERS:[] },
                    'RECOVER': { DEVICES:[], APPLICATIONS:[], NETWORKS:[], DATA:[], USERS:[] }
                };

                const flatScenarios = Object.values(aggregatedHistory.byRisk).flat();
                
                flatScenarios.forEach(s => {
                    if (cdmFilter !== 'ALL' && s.severity !== cdmFilter) return;
                    const { functionType, assetType } = getCDMCell(s);
                    if (matrix[functionType] && matrix[functionType][assetType]) {
                        matrix[functionType][assetType].push(s);
                    }
                });

                return matrix;
            }, [aggregatedHistory, cdmFilter]);

            // --- RACI Matrix Logic ---
            const raciMatrixData = useMemo(() => {
                const flatScenarios = Object.values(aggregatedHistory.byRisk).flat();
                // If there are many scenarios, maybe limit to top 20 or latest to avoid huge table
                const scenariosToMap = flatScenarios.slice(0, 30); 

                return scenariosToMap.map(scenario => {
                    // Simple heuristic mapping
                    return {
                        id: scenario.title, // using title as key
                        scenario: scenario.title,
                        category: scenario.category,
                        roles: {
                            analyst: { detect: 'R', triage: 'R', contain: 'C', recover: 'I', report: 'C' },
                            admin: { detect: 'I', triage: 'C', contain: 'R', recover: 'R', report: 'C' },
                            manager: { detect: 'A', triage: 'A', contain: 'A', recover: 'I', report: 'R' },
                            ciso: { detect: 'I', triage: 'I', contain: 'I', recover: 'C', report: 'A' },
                            owner: { detect: 'I', triage: 'I', contain: 'C', recover: 'A', report: 'I' }
                        }
                    };
                });
            }, [aggregatedHistory]);

            const handleGeneratePlaybook = async () => {
                let inputToUse = systemInput; if (!inputToUse.trim() && assetList.length > 0) inputToUse = assetList.map(a => a.name).join(', ');
                if (!inputToUse.trim()) return;
                setPlaybookLoading(true); setPlaybookResult(''); setResultViewMode('text'); setChartData(null);
                const prompt = `SIEM 架構師。環境：${inputToUse}。輸出兩部分(---SPLIT---)：1.策略規劃(表格), 2.技術實作(表格)。繁體中文。`;
                try { const text = await fetchGeminiResponse(prompt); setPlaybookResult(text); 
                      const newEntry = {id: Date.now(), timestamp: new Date().toLocaleString(), input: inputToUse, content: text};
                      const newHistory = [newEntry, ...playbookHistory];
                      setPlaybookHistory(newHistory); savePlaybookToDB(newHistory);
                } catch (error) { setPlaybookResult("失敗: " + error.message); } finally { setPlaybookLoading(false); }
            };

            const handleGenerateChart = async (textContent) => {
                if (!textContent) return; setResultViewMode('chart'); if (chartData) return; setChartLoading(true);
                const prompt = `分析 SIEM 指標：${textContent.split('---SPLIT---')[0]}。回傳純 JSON：{"priority_stats":{}, "source_stats":{}, "category_stats":{}}`;
                try { const raw = await fetchGeminiResponse(prompt); const jsonStr = raw.substring(raw.indexOf('{'), raw.lastIndexOf('}') + 1); setChartData(JSON.parse(jsonStr)); } catch (e) { setChartData({priority_stats:{"Error":1}, source_stats:{}, category_stats:{}}); } finally { setChartLoading(false); }
            };

            const handleExportTxt = (content) => {
                 const element = document.createElement("a");
                 const file = new Blob([content], {type: 'text/plain'});
                 element.href = URL.createObjectURL(file);
                 element.download = `SIEM_Report_${new Date().toISOString().slice(0,10)}.txt`;
                 document.body.appendChild(element); element.click(); document.body.removeChild(element);
            };

            const handleDeleteHistory = (e, id) => { 
                e.stopPropagation(); 
                const newHistory = playbookHistory.filter(x => x.id !== id);
                setPlaybookHistory(newHistory);
                savePlaybookToDB(newHistory); 
            };
            
            const handleDeleteGuide = (id) => {
                const newGuides = logGuides.filter(g => g.id !== id);
                setLogGuides(newGuides);
                saveGuidesToDB(newGuides);
            };
            
            const handleOpenImplementationGuide = () => { setActiveTab('indicators'); if (playbookResult) setResultViewMode('guide'); else if (playbookHistory.length > 0) { const latest = playbookHistory[0]; setSystemInput(latest.input); setPlaybookResult(latest.content); setResultViewMode('guide'); } };

            // --- Chat Handlers ---
            useEffect(() => {
                if (chatEndRef.current) {
                    chatEndRef.current.scrollIntoView({ behavior: "smooth" });
                }
            }, [chatHistory, isChatOpen]);

            const handleChatSubmit = async (e) => {
                e.preventDefault();
                if (!chatInput.trim()) return;
                const userMsg = chatInput;
                setChatInput("");
                setChatHistory(prev => [...prev, { role: 'user', text: userMsg }]);
                setChatLoading(true);

                const prompt = `
                Role: Senior SOC Analyst & SIEM Engineer Assistant.
                User Question: ${userMsg}
                Answer concisely in Traditional Chinese. Provide technical details, SIEM rule examples (Splunk/Sigma), or mitigation steps if asked.
                `;

                try {
                    const reply = await fetchGeminiResponse(prompt);
                    setChatHistory(prev => [...prev, { role: 'bot', text: reply }]);
                } catch (err) {
                    setChatHistory(prev => [...prev, { role: 'bot', text: "連線錯誤，請稍後再試。" }]);
                } finally {
                    setChatLoading(false);
                }
            };

            // --- Simulation Logic ---
            useEffect(() => {
                if (simChatEndRef.current) {
                    simChatEndRef.current.scrollIntoView({ behavior: "smooth" });
                }
            }, [simHistory]);

            const handleStartSimulation = async (scenario) => {
                setSimScenario(scenario);
                setSimulationModalOpen(true);
                setSimHistory([]);
                setSimLoading(true);
                
                // Initial Prompt
                const prompt = `
                Role: You are a Red Team Operator and Dungeon Master for a SOC Incident Response Simulation.
                Scenario: ${scenario.title} (${scenario.category})
                Goal: Guide the user (Blue Team) through a realistic attack simulation.
                Task:
                1. Start by describing the INITIAL INDICATOR (Inject #1) that the analyst sees in the SIEM. Be dramatic but realistic.
                2. Do NOT reveal the entire attack chain yet.
                3. Ask the user what they want to do next.
                Language: Traditional Chinese (Taiwan).
                Output: Just the initial inject text.
                `;

                try {
                    const reply = await fetchGeminiResponse(prompt);
                    setSimHistory([{ role: 'bot', text: reply }]);
                    
                    // Trigger TTS
                    const audioUrl = await fetchGeminiTTS(reply);
                    if(audioUrl) setSimAudioUrl(audioUrl);

                } catch (e) {
                    setSimHistory([{ role: 'bot', text: "模擬啟動失敗，請重試。" }]);
                } finally {
                    setSimLoading(false);
                }
            };

            const handleSimSubmit = async (e) => {
                e.preventDefault();
                if(!simInput.trim()) return;
                const userText = simInput;
                setSimInput('');
                setSimHistory(prev => [...prev, { role: 'user', text: userText }]);
                setSimLoading(true);
                setSimAudioUrl(null); // Clear previous audio

                const historyContext = simHistory.map(h => `${h.role === 'user' ? 'Blue Team' : 'Red Team'}: ${h.text}`).join('\n');
                
                const prompt = `
                Role: Red Team Operator / Dungeon Master.
                Scenario: ${simScenario.title}
                Context:
                ${historyContext}
                Blue Team Action: ${userText}
                
                Task:
                1. Evaluate the Blue Team's action. Is it effective? Does it reveal more info?
                2. Describe the result of their action AND the next step of the attack (Inject #N).
                3. Keep it tense and realistic.
                Language: Traditional Chinese.
                `;

                try {
                    const reply = await fetchGeminiResponse(prompt);
                    setSimHistory(prev => [...prev, { role: 'bot', text: reply }]);
                    
                    // Trigger TTS
                    const audioUrl = await fetchGeminiTTS(reply);
                    if(audioUrl) setSimAudioUrl(audioUrl);

                } catch (e) {
                    setSimHistory(prev => [...prev, { role: 'bot', text: "連線中斷..." }]);
                } finally {
                    setSimLoading(false);
                }
            };

            // ... Existing Handlers ...
            const handleAskMitigation = async (title) => {
                setIsChatOpen(true);
                const query = `請針對威脅情境『${title}』提供詳細的緩解措施 (Mitigation Steps)。`;
                setChatHistory(prev => [...prev, { role: 'user', text: query }]);
                setChatLoading(true);
                
                const prompt = `Role: Senior SOC Analyst. Provide step-by-step mitigation plan for: "${title}". Traditional Chinese.`;
                try {
                    const reply = await fetchGeminiResponse(prompt);
                    setChatHistory(prev => [...prev, { role: 'bot', text: reply }]);
                } catch (err) {
                    setChatHistory(prev => [...prev, { role: 'bot', text: "生成失敗，請稍後再試。" }]);
                } finally {
                    setChatLoading(false);
                }
            };

            const handleAskRule = async (title) => {
                setIsChatOpen(true);
                const query = `請針對威脅情境『${title}』生成 SIEM 關聯規則 (Splunk SPL & Sigma)。`;
                setChatHistory(prev => [...prev, { role: 'user', text: query }]);
                setChatLoading(true);
                
                const prompt = `Role: SIEM Content Engineer. Generate Splunk SPL and Sigma rule for threat: "${title}". Traditional Chinese.`;
                try {
                    const reply = await fetchGeminiResponse(prompt);
                    setChatHistory(prev => [...prev, { role: 'bot', text: reply }]);
                } catch (err) {
                    setChatHistory(prev => [...prev, { role: 'bot', text: "生成失敗，請稍後再試。" }]);
                } finally {
                    setChatLoading(false);
                }
            };

            const handleGenerateMockLog = async (title) => {
                setIsChatOpen(true);
                const query = `請針對威脅情境『${title}』產生測試用的 Log 樣本 (Syslog/JSON)。`;
                setChatHistory(prev => [...prev, { role: 'user', text: query }]);
                setChatLoading(true);
                
                const prompt = `Role: System Administrator. Generate realistic sample logs (Syslog and JSON format) for the threat scenario: "${title}". Ensure timestamps, IPs, and user fields are realistic.`;
                try {
                    const reply = await fetchGeminiResponse(prompt);
                    setChatHistory(prev => [...prev, { role: 'bot', text: reply }]);
                } catch (err) {
                    setChatHistory(prev => [...prev, { role: 'bot', text: "生成失敗，請稍後再試。" }]);
                } finally {
                    setChatLoading(false);
                }
            };

            const handleAnalyzeVulnerabilities = async (assetName, category) => {
                setIsChatOpen(true);
                const query = `請分析資產 ${assetName} (${category}) 常見的 CVE 漏洞與弱點配置。`;
                setChatHistory(prev => [...prev, { role: 'user', text: query }]);
                setChatLoading(true);
                
                const prompt = `Role: Vulnerability Analyst. List top 3 common CVEs and misconfigurations for: ${assetName} (${category}). Provide remediation advice. Traditional Chinese.`;
                try {
                    const reply = await fetchGeminiResponse(prompt);
                    setChatHistory(prev => [...prev, { role: 'bot', text: reply }]);
                } catch (err) {
                    setChatHistory(prev => [...prev, { role: 'bot', text: "分析失敗，請稍後再試。" }]);
                } finally {
                    setChatLoading(false);
                }
            };

            const handleDraftEmail = async (scenario) => {
                setIsChatOpen(true);
                const title = scenario.title || "未知威脅";
                const severity = scenario.severity || "Unknown";
                const query = `請撰寫一份關於『${title}』(等級: ${severity}) 的資安通報郵件。`;
                setChatHistory(prev => [...prev, { role: 'user', text: query }]);
                setChatLoading(true);
                
                const prompt = `Role: Incident Response Manager. Draft a formal security incident notification email for "${title}" (Severity: ${severity}). Audience: IT Management & Stakeholders. Include specific details and recommended actions. Traditional Chinese.`;
                try {
                    const reply = await fetchGeminiResponse(prompt);
                    setChatHistory(prev => [...prev, { role: 'bot', text: reply }]);
                } catch (err) {
                    setChatHistory(prev => [...prev, { role: 'bot', text: "撰寫失敗，請稍後再試。" }]);
                } finally {
                    setChatLoading(false);
                }
            };

            const handleAskThreatIntel = async (title) => {
                setIsChatOpen(true);
                const query = `請分析威脅情境『${title}』的相關情資 (APT 組織、惡意軟體、IOCs)。`;
                setChatHistory(prev => [...prev, { role: 'user', text: query }]);
                setChatLoading(true);
                
                const prompt = `Role: Threat Intelligence Analyst. Provide attribution (APT groups, malware families) and key IOC types associated with: "${title}". Traditional Chinese.`;
                try {
                    const reply = await fetchGeminiResponse(prompt);
                    setChatHistory(prev => [...prev, { role: 'bot', text: reply }]);
                } catch (err) {
                    setChatHistory(prev => [...prev, { role: 'bot', text: "分析失敗，請稍後再試。" }]);
                } finally {
                    setChatLoading(false);
                }
            };

            const handlePredictAttackPath = async (assetName, category) => {
                setIsChatOpen(true);
                const query = `如果資產 ${assetName} (${category}) 被攻陷，預測可能的攻擊路徑與橫向移動目標。`;
                setChatHistory(prev => [...prev, { role: 'user', text: query }]);
                setChatLoading(true);
                
                const prompt = `Role: Red Team Operator. Scenario: Asset "${assetName}" (${category}) is compromised. Describe the most likely lateral movement path and ultimate objective (Crown Jewels). Return a concise kill chain in Traditional Chinese.`;
                try {
                    const reply = await fetchGeminiResponse(prompt);
                    setChatHistory(prev => [...prev, { role: 'bot', text: reply }]);
                } catch (err) {
                    setChatHistory(prev => [...prev, { role: 'bot', text: "預測失敗，請稍後再試。" }]);
                } finally {
                    setChatLoading(false);
                }
            };

            // Log Parser Logic
            const handleLogParse = async () => {
                if (!rawLogInput.trim()) return;
                setIsParsingLog(true);
                const prompt = `Role: SOC Analyst. Parse the following raw log into a structured JSON object. Identify fields like timestamp, source_ip, destination_ip, event_id, user, action, etc. Log: """${rawLogInput}""" Return ONLY the JSON object.`;
                try {
                    const reply = await fetchGeminiResponse(prompt);
                    // Extract JSON if wrapped in code blocks
                    const jsonMatch = reply.match(/\{[\s\S]*\}/);
                    const jsonStr = jsonMatch ? jsonMatch[0] : reply;
                    setParsedLogResult(jsonStr);
                } catch (err) {
                    setParsedLogResult("解析失敗: " + err.message);
                } finally {
                    setIsParsingLog(false);
                }
            };
            
            // New Feature: Compliance Analysis (GRC)
            const handleComplianceAnalysis = async (title) => {
                setIsChatOpen(true);
                const query = `請分析威脅情境『${title}』違反了哪些 ISO 27001 或 NIST CSF 合規項目。`;
                setChatHistory(prev => [...prev, { role: 'user', text: query }]);
                setChatLoading(true);
                
                const prompt = `Role: GRC Consultant. Analyze threat "${title}" and map it to specific violated controls in ISO 27001:2022 and NIST CSF 2.0. Format as a table. Traditional Chinese.`;
                try {
                    const reply = await fetchGeminiResponse(prompt);
                    setChatHistory(prev => [...prev, { role: 'bot', text: reply }]);
                } catch (err) {
                    setChatHistory(prev => [...prev, { role: 'bot', text: "分析失敗，請稍後再試。" }]);
                } finally {
                    setChatLoading(false);
                }
            };

            // New Feature: Natural Language to Query (NL2Q)
            const handleGenerateQuery = async () => {
                if (!nlQueryInput.trim()) return;
                setIsGeneratingQuery(true);
                const prompt = `Role: SIEM Expert. Convert natural language "${nlQueryInput}" into a specific query for "${queryPlatform}". Output ONLY the query code block.`;
                try {
                    const reply = await fetchGeminiResponse(prompt);
                    setGeneratedQuery(reply);
                } catch (err) {
                    setGeneratedQuery("生成失敗: " + err.message);
                } finally {
                    setIsGeneratingQuery(false);
                }
            };

            // New Feature: Script Analyzer
            const handleAnalyzeScript = async () => {
                if (!scriptInput.trim()) return;
                setIsAnalyzingScript(true);
                const prompt = `Role: Malware Analyst. Analyze the following script. Explain its functionality, identify malicious intent, and extract any IOCs (IPs, URLs, file paths). Script: """${scriptInput}""" Output in Traditional Chinese.`;
                try {
                    const reply = await fetchGeminiResponse(prompt);
                    setScriptAnalysisResult(reply);
                } catch (err) {
                    setScriptAnalysisResult("分析失敗: " + err.message);
                } finally {
                    setIsAnalyzingScript(false);
                }
            };

            // New Feature: IR Playbook Generator
            const handleGenerateIRPlaybook = async (title) => {
                setIsChatOpen(true);
                setChatHistory(prev => [...prev, { role: 'user', text: `產生『${title}』的 IR 劇本。` }]);
                setChatLoading(true);
                const prompt = `Role: Incident Response Commander. Create a detailed Incident Response Playbook for the threat: '${title}'. Follow NIST SP 800-61 phases: 1. Preparation 2. Detection & Analysis 3. Containment 4. Eradication 5. Recovery 6. Post-Incident Activity. Output in Traditional Chinese.`;
                try {
                    const reply = await fetchGeminiResponse(prompt);
                    setChatHistory(prev => [...prev, { role: 'bot', text: reply }]);
                } catch (err) {
                    setChatHistory(prev => [...prev, { role: 'bot', text: "生成失敗，請稍後再試。" }]);
                } finally {
                    setChatLoading(false);
                }
            };

            // --- Executive Summary Handler ---
            const handleGenerateExecutiveSummary = async () => {
                if (!threatHistory.length) {
                    showToast('請先累積一些威脅分析歷史紀錄', 'error');
                    return;
                }
                setSummaryModalOpen(true);
                setSummaryLoading(true);
                
                const stats = aggregatedHistory;
                const criticalCount = stats.byRisk.Critical.length;
                const highCount = stats.byRisk.High.length;
                const topRisks = [...stats.byRisk.Critical, ...stats.byRisk.High].slice(0, 5).map(r => r.title).join(", ");
                
                const prompt = `
                Role: CISO.
                Context:
                - Critical Risks: ${criticalCount}
                - High Risks: ${highCount}
                - Top Threats: ${topRisks}
                
                Task: Write a concise Executive Summary (資安態勢高層匯報) in Traditional Chinese.
                Structure:
                1. Executive Summary (摘要)
                2. Key Risk Indicators (關鍵風險指標)
                3. Strategic Recommendations (策略建議)
                `;
                
                try {
                    const text = await fetchGeminiResponse(prompt);
                    setSummaryContent(text);
                } catch (e) {
                    setSummaryContent("生成失敗: " + e.message);
                } finally {
                    setSummaryLoading(false);
                }
            };

            return (
                <div className="h-full flex flex-col bg-slate-50 font-sans relative">
                    {/* Header */}
                    <header className="bg-slate-900 text-white p-4 flex justify-between items-center shadow-lg shrink-0 z-20">
                        <div className="flex items-center gap-3">
                            <div className="p-2 bg-indigo-600 rounded-lg shadow-inner"><Briefcase size={24} className="text-white"/></div>
                            <div>
                                <h1 className="text-xl font-bold tracking-wide">資產與威脅情境戰情室</h1>
                                <p className="text-slate-400 text-xs flex items-center gap-1">SIEM War Room <span className="w-1 h-1 rounded-full bg-slate-500"></span> Asset & Threat Intelligence</p>
                            </div>
                        </div>
                        <div className="flex items-center gap-4">
                             <button onClick={()=>setScriptAnalyzerOpen(true)} className="flex items-center gap-1 text-xs bg-slate-800 hover:bg-slate-700 px-3 py-1.5 rounded-lg border border-slate-700 transition-colors"><LucideIcons.FileCode2 size={14} className="text-rose-400"/> 腳本分析</button>
                             <button onClick={()=>setQueryGenOpen(true)} className="flex items-center gap-1 text-xs bg-slate-800 hover:bg-slate-700 px-3 py-1.5 rounded-lg border border-slate-700 transition-colors"><LucideIcons.Terminal size={14} className="text-emerald-400"/> 查詢生成器</button>
                             <button onClick={()=>setLogParserOpen(true)} className="flex items-center gap-1 text-xs bg-slate-800 hover:bg-slate-700 px-3 py-1.5 rounded-lg border border-slate-700 transition-colors"><Microscope size={14} className="text-indigo-400"/> Log 解析器</button>
                             
                             {/* API Key Settings Button */}
                             <button onClick={()=>setShowApiKeyModal(true)} className={`flex items-center gap-1 text-xs px-3 py-1.5 rounded-lg border transition-colors ${!userApiKey && !apiKey ? 'bg-amber-500 hover:bg-amber-600 text-white border-amber-500 animate-pulse' : 'bg-slate-800 hover:bg-slate-700 border-slate-700 text-slate-300'}`} title="設定 Gemini API Key">
                                <Key size={14}/> {userApiKey ? '已設定金鑰' : '設定金鑰'}
                             </button>

                             {syncStatus === 'connecting' && <span className="text-xs text-yellow-400 animate-pulse flex items-center gap-1 bg-yellow-400/10 px-2 py-1 rounded-full"><Cloud size={12}/> 連線中...</span>}
                             {syncStatus === 'synced' && <span className="text-xs text-green-400 flex items-center gap-1 bg-green-400/10 px-2 py-1 rounded-full"><Check size={12}/> 雲端共用中</span>}
                             {syncStatus === 'error' && (
                                <button onClick={() => setShowRulesModal(true)} className="text-xs text-red-400 flex items-center gap-1 bg-red-400/10 px-2 py-1 rounded-full hover:bg-red-400/20" title={dbError}>
                                    <CloudOff size={12}/> {dbError.includes('permission') ? '權限錯誤 (點我修復)' : '離線'}
                                </button>
                             )}
                        </div>
                    </header>

                    {/* Navigation Tabs */}
                    <div className="bg-white border-b border-gray-200 px-6 flex gap-8 shrink-0 shadow-sm z-10">
                        <button onClick={()=>setActiveTab('assets')} className={`py-4 text-sm font-bold flex items-center gap-2 border-b-2 transition-colors ${activeTab==='assets'?'border-indigo-600 text-indigo-600':'border-transparent text-gray-500 hover:text-gray-700'}`}><Server size={16}/> 系統與威脅分析</button>
                        <button onClick={()=>setActiveTab('indicators')} className={`py-4 text-sm font-bold flex items-center gap-2 border-b-2 transition-colors ${activeTab==='indicators'?'border-indigo-600 text-indigo-600':'border-transparent text-gray-500 hover:text-gray-700'}`}><Target size={16}/> 監控指標產生器</button>
                        <button onClick={()=>setActiveTab('history')} className={`py-4 text-sm font-bold flex items-center gap-2 border-b-2 transition-colors ${activeTab==='history'?'border-indigo-600 text-indigo-600':'border-transparent text-gray-500 hover:text-gray-700'}`}><LayoutDashboard size={16}/> 歷史情境戰情看板</button>
                        <button onClick={()=>setActiveTab('cdm')} className={`py-4 text-sm font-bold flex items-center gap-2 border-b-2 transition-colors ${activeTab==='cdm'?'border-indigo-600 text-indigo-600':'border-transparent text-gray-500 hover:text-gray-700'}`}><Grid3X3 size={16}/> CDM 戰情矩陣</button>
                        <button onClick={()=>setActiveTab('guides')} className={`py-4 text-sm font-bold flex items-center gap-2 border-b-2 transition-colors ${activeTab==='guides'?'border-indigo-600 text-indigo-600':'border-transparent text-gray-500 hover:text-gray-700'}`}><Library size={16}/> Log 收集指引庫</button>
                        <button onClick={()=>setActiveTab('raci')} className={`py-4 text-sm font-bold flex items-center gap-2 border-b-2 transition-colors ${activeTab==='raci'?'border-indigo-600 text-indigo-600':'border-transparent text-gray-500 hover:text-gray-700'}`}><Users size={16}/> RACI 權責矩陣</button>
                    </div>

                    {/* Content Area */}
                    <div className="flex-1 overflow-hidden relative flex flex-col">
                        {/* TAB 1: ASSETS & THREATS */}
                        {activeTab === 'assets' && (
                            <div className="flex w-full h-full">
                                {/* Left: Asset Management */}
                                <div className="w-1/3 bg-gray-50 border-r border-gray-200 flex flex-col p-6 overflow-hidden">
                                    <div className="flex justify-between items-center mb-4">
                                        <h3 className="font-bold text-gray-700 flex items-center gap-2"><Server className="text-indigo-500" size={18}/> 資產清單 (Shared Inventory)</h3>
                                        <div className="flex gap-2">
                                           <button onClick={() => saveAssetsToDB(assetList)} className="text-xs bg-green-500 hover:bg-green-600 text-white px-2 py-1 rounded shadow-sm flex items-center gap-1"><Save size={12}/> 儲存</button>
                                           <button onClick={handleAddAssetRow} className="text-xs bg-white border hover:bg-gray-50 text-gray-600 px-2 py-1 rounded shadow-sm flex items-center gap-1"><Plus size={12}/> 新增列</button>
                                        </div>
                                    </div>

                                    {/* Quick Add Section */}
                                    <div className="bg-white p-4 rounded-xl border border-indigo-100 shadow-sm mb-4">
                                        <div className="flex justify-between items-center mb-2">
                                            <label className="text-xs font-bold text-gray-500 uppercase tracking-wider">快速加入常見系統</label>
                                        </div>
                                        <div className="flex gap-2 mb-3">
                                            <select className="flex-1 p-2 text-sm border border-gray-200 rounded-lg focus:ring-2 focus:ring-indigo-500 outline-none bg-gray-50" onChange={handleQuickAddAsset}>
                                                <option value="">選擇常見系統...</option>
                                                {Object.entries(commonSystems).map(([cat, items]) => (
                                                    <optgroup key={cat} label={cat}>{items.map(s=><option key={s} value={s}>{s}</option>)}</optgroup>
                                                ))}
                                            </select>
                                            <button 
                                              onClick={handleAiSuggestAssets} 
                                              disabled={aiSuggestingAssets}
                                              className="px-3 py-2 bg-gradient-to-r from-purple-500 to-indigo-600 text-white rounded-lg shadow hover:shadow-md transition-all flex items-center gap-1 disabled:opacity-50 text-xs font-bold whitespace-nowrap"
                                              title="由 AI 根據標準架構自動推薦核心資產 (會覆蓋現有清單)"
                                            >
                                              {aiSuggestingAssets ? <Loader2 size={14} className="animate-spin"/> : <Wand2 size={14}/>} AI 推薦
                                            </button>
                                        </div>
                                        <label className="text-xs font-bold text-gray-500 uppercase tracking-wider block mb-1">分析維度 (Focus)</label>
                                        <select 
                                          className="w-full p-2 text-sm border border-gray-200 rounded-lg outline-none bg-indigo-50 text-indigo-900 font-medium" 
                                          value={analysisType}
                                          onChange={(e)=>setAnalysisType(e.target.value)}
                                        >
                                           {analysisOptions.map(opt => <option key={opt.id} value={opt.id}>{opt.label}</option>)}
                                        </select>
                                    </div>

                                    {/* Asset Table */}
                                    <div className="flex-1 overflow-y-auto bg-white rounded-xl border border-gray-200 shadow-inner">
                                        <table className="w-full text-left border-collapse">
                                            <thead className="bg-gray-50 sticky top-0 z-10 text-xs text-gray-500 uppercase">
                                                <tr>
                                                    <th className="p-3 border-b w-[30%]">分類</th>
                                                    <th className="p-3 border-b">名稱</th>
                                                    <th className="p-3 border-b w-[20%] text-center">操作</th>
                                                </tr>
                                            </thead>
                                            <tbody className="text-sm divide-y divide-gray-100">
                                                {assetList.map((asset, index) => (
                                                    <tr key={asset.id} className="hover:bg-indigo-50/30 group transition-colors">
                                                        <td className="p-2">
                                                            <select className="w-full bg-transparent outline-none text-xs text-gray-600" value={asset.category} onChange={(e)=>handleUpdateAssetRow(asset.id,'category',e.target.value)}>
                                                                <option value="" disabled>分類...</option>
                                                                {assetCategories.map(c=><option key={c} value={c}>{c}</option>)}
                                                            </select>
                                                        </td>
                                                        <td className="p-2">
                                                            <input className="w-full bg-transparent outline-none font-medium text-gray-800" value={asset.name} onChange={(e)=>handleUpdateAssetRow(asset.id,'name',e.target.value)} placeholder="輸入名稱..."/>
                                                        </td>
                                                        <td className="p-2 text-center flex justify-center gap-1">
                                                            <button 
                                                                onClick={() => handleAnalyzeVulnerabilities(asset.name, asset.category)}
                                                                className="text-amber-500 hover:text-amber-600 p-1 rounded hover:bg-amber-50 transition-colors"
                                                                title="AI 弱點分析"
                                                            >
                                                                <Bug size={14}/>
                                                            </button>
                                                            <button 
                                                                onClick={() => handlePredictAttackPath(asset.name, asset.category)}
                                                                className="text-red-500 hover:text-red-600 p-1 rounded hover:bg-red-50 transition-colors"
                                                                title="預測攻擊路徑"
                                                            >
                                                                <Footprints size={14}/>
                                                            </button>
                                                            <button onClick={()=>handleDeleteAssetRow(asset.id)} className="text-gray-300 hover:text-red-500 p-1 rounded hover:bg-red-50 transition-colors"><Trash size={14}/></button>
                                                        </td>
                                                    </tr>
                                                ))}
                                                {assetList.length === 0 && <tr><td colSpan="3" className="p-8 text-center text-gray-400 text-xs">暫無資產，請從上方新增或使用 AI 推薦</td></tr>}
                                            </tbody>
                                        </table>
                                    </div>
                                    
                                    <button onClick={handleGenerateThreatAnalysis} disabled={threatLoading} className="mt-4 w-full bg-indigo-600 hover:bg-indigo-700 text-white py-3 rounded-xl font-bold shadow-lg shadow-indigo-200 flex items-center justify-center gap-2 transition-all transform active:scale-95">
                                        {threatLoading ? <Loader2 className="animate-spin"/> : <Activity size={18}/>} 開始交叉分析
                                    </button>
                                 </div>

                                 {/* Right: Analysis Result */}
                                 <div className="w-2/3 bg-white p-6 overflow-y-auto">
                                     <div className="flex border-b border-gray-200 mb-6">
                                        <button onClick={()=>setThreatViewTab('current')} className={`pb-3 px-4 text-sm font-medium border-b-2 transition-colors ${threatViewTab==='current'?'border-indigo-600 text-indigo-600':'border-transparent text-gray-400 hover:text-gray-600'}`}>目前分析結果</button>
                                        <button onClick={()=>setThreatViewTab('history')} className={`pb-3 px-4 text-sm font-medium border-b-2 transition-colors ${threatViewTab==='history'?'border-indigo-600 text-indigo-600':'border-transparent text-gray-400 hover:text-gray-600'}`}>分析歷史紀錄 ({threatHistory.length})</button>
                                     </div>

                                     {threatViewTab === 'current' ? (
                                         <div className="animate-in fade-in duration-500">
                                            {!threatData && !threatLoading && (
                                                <div className="h-96 flex flex-col items-center justify-center text-gray-300">
                                                    <BrainCircuit size={64} className="mb-4 opacity-50"/>
                                                    <p>請在左側完善資產清單並點擊分析</p>
                                                </div>
                                            )}
                                            {threatLoading && (
                                                <div className="h-96 flex flex-col items-center justify-center text-indigo-500">
                                                    <Loader2 size={48} className="mb-4 animate-spin"/>
                                                    <p className="font-medium animate-pulse">AI 正在進行多維度關聯分析...</p>
                                                </div>
                                            )}
                                            {threatData && (
                                                <div className="space-y-6">
                                                    <div className="flex items-center justify-between">
                                                        <div className="flex items-center gap-2">
                                                            <div className="p-2 bg-indigo-100 rounded-lg"><ShieldCheck className="text-indigo-600" size={20}/></div>
                                                            <div>
                                                                <h2 className="text-lg font-bold text-slate-800"><SafeText content={threatData.analysis_type} /></h2>
                                                                <p className="text-xs text-gray-400"><SafeText content={threatData.timestamp} /></p>
                                                            </div>
                                                        </div>
                                                    </div>

                                                    {/* Admin Guide */}
                                                    <div className="bg-slate-50 border border-slate-200 rounded-xl p-5">
                                                        <h4 className="font-bold text-slate-700 mb-4 flex items-center gap-2 text-sm"><ScrollText size={16}/> 📋 系統管理員 Log 收集指引</h4>
                                                        <div className="grid gap-3">
                                                            {threatData.admin_log_guide?.map((guide, idx) => (
                                                                <div key={idx} className="bg-white p-3 rounded border border-slate-200 shadow-sm flex flex-col md:flex-row gap-4 items-start">
                                                                    <div className="md:w-1/4 font-bold text-slate-800 text-sm flex items-center gap-2"><Server size={14} className="text-gray-400"/><SafeText content={guide.system}/></div>
                                                                    <div className="md:w-3/4 text-xs space-y-2">
                                                                        <div className="flex gap-2">
                                                                            <span className="text-indigo-600 font-bold whitespace-nowrap bg-indigo-50 px-1 rounded">收集項目</span> 
                                                                            <span className="text-slate-600 leading-relaxed"><SafeText content={guide.log_items}/></span>
                                                                        </div>
                                                                        <div className="flex gap-2">
                                                                            <span className="text-emerald-600 font-bold whitespace-nowrap bg-emerald-50 px-1 rounded">設定建議</span> 
                                                                            <span className="text-slate-600 leading-relaxed"><SafeText content={guide.config_advice}/></span>
                                                                        </div>
                                                                    </div>
                                                                </div>
                                                            ))}
                                                        </div>
                                                    </div>

                                                    {/* Scenarios */}
                                                    <div>
                                                        <h4 className="font-bold text-slate-700 mb-4 text-sm flex items-center gap-2"><Activity size={16}/> 關鍵威脅情境列表</h4>
                                                        <div className="space-y-3">
                                                            {threatData.scenarios?.map((s, i) => (
                                                                <ScenarioCard 
                                                                    key={i} 
                                                                    scenario={s} 
                                                                    onAskMitigation={handleAskMitigation} 
                                                                    onAskRule={handleAskRule} 
                                                                    onGenerateLogs={handleGenerateMockLog}
                                                                    onDraftEmail={handleDraftEmail}
                                                                    onAskThreatIntel={handleAskThreatIntel}
                                                                    onAskCompliance={handleComplianceAnalysis}
                                                                    onGenerateIRPlaybook={handleGenerateIRPlaybook}
                                                                    onVisualize={handleVisualize}
                                                                    onSimulate={handleStartSimulation}
                                                                />
                                                            ))}
                                                        </div>
                                                    </div>
                                                </div>
                                            )}
                                         </div>
                                     ) : (
                                         <div className="space-y-3">
                                            {threatHistory.length === 0 && <div className="text-center text-gray-400 mt-20">尚無歷史紀錄</div>}
                                            {threatHistory.map((history, idx) => (
                                                <div key={idx} onClick={() => { setThreatData(history); setThreatViewTab('current'); }} className="p-4 border border-gray-200 rounded-xl hover:border-indigo-300 hover:shadow-md cursor-pointer transition-all bg-white group">
                                                    <div className="flex justify-between items-center mb-2">
                                                        <h5 className="font-bold text-indigo-700 flex items-center gap-2"><History size={16}/> <SafeText content={history.analysis_type}/></h5>
                                                        <span className="text-xs text-gray-400"><SafeText content={history.timestamp}/></span>
                                                    </div>
                                                    <div className="flex gap-4 text-xs text-gray-500">
                                                        <span className="bg-gray-100 px-2 py-1 rounded">情境數: {history.scenarios?.length || 0}</span>
                                                        <span className="bg-red-50 text-red-600 px-2 py-1 rounded border border-red-100">High/Crit: {history.scenarios?.filter(s=>s.severity==='High'||s.severity==='Critical').length}</span>
                                                    </div>
                                                </div>
                                            ))}
                                         </div>
                                     )}
                                 </div>
                            </div>
                        )}

                        {/* TAB 2: INDICATORS (Playbook) */}
                        {activeTab === 'indicators' && (
                             <div className="flex-1 flex overflow-hidden">
                                <div className="w-1/3 p-6 border-r border-gray-200 overflow-y-auto bg-slate-50">
                                    <h4 className="font-bold text-slate-700 mb-4 flex items-center gap-2"><Target size={18}/> 監控指標產生器</h4>
                                    <div className="bg-white p-4 rounded-xl border border-gray-200 shadow-sm mb-4">
                                        <p className="text-xs text-gray-500 mb-3 leading-relaxed">此功能將根據您的環境，自動生成 Top 30 優先級最高的監控指標與實作建議。</p>
                                        <label className="block text-xs font-bold text-gray-700 mb-2">補充環境資訊 (選填)</label>
                                        <textarea className="w-full h-32 p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 resize-none text-sm mb-3" placeholder="例如：Windows AD, Exchange, Fortigate..." value={systemInput} onChange={e=>setSystemInput(e.target.value)}/>
                                        <button className="w-full bg-purple-600 hover:bg-purple-700 text-white py-2 rounded-lg font-bold shadow flex items-center justify-center gap-2" onClick={handleGeneratePlaybook} disabled={playbookLoading}>{playbookLoading ? <Loader2 className="animate-spin"/> : <ListChecks size={18}/>} 生成 Top 30 指標</button>
                                    </div>
                                    
                                    {/* Playbook History Sidebar */}
                                    <h5 className="font-bold text-gray-500 text-xs uppercase mb-3 px-1">最近紀錄</h5>
                                    <div className="space-y-2">
                                        {playbookHistory.map(h => (
                                            <div key={h.id} onClick={()=>{setPlaybookResult(h.content); setSystemInput(h.input);}} className="p-3 bg-white border border-gray-200 rounded-lg cursor-pointer hover:border-purple-300 transition-colors text-xs shadow-sm">
                                                <div className="flex justify-between text-gray-400 mb-1"><span>{h.timestamp.split(' ')[0]}</span><button onClick={(e)=>handleDeleteHistory(e,h.id)} className="hover:text-red-500"><Trash size={12}/></button></div>
                                                <div className="font-medium text-gray-700 truncate">{h.input || '自動生成'}</div>
                                            </div>
                                        ))}
                                    </div>
                                </div>
                                <div className="w-2/3 p-8 overflow-y-auto bg-white">
                                    {playbookResult ? (
                                        <div className="max-w-4xl mx-auto">
                                            <div className="flex justify-between items-center mb-6 border-b pb-4">
                                                <h3 className="text-xl font-bold text-slate-800 flex items-center gap-2"><ListChecks className="text-purple-600"/> 生成結果</h3>
                                                <div className="flex gap-2">
                                                    <button onClick={()=>handleGenerateChart(getResultContent(playbookResult,'text'))} className={`flex items-center gap-2 text-xs font-bold px-3 py-2 rounded-lg border transition-colors ${resultViewMode==='chart'?'bg-purple-50 text-purple-700 border-purple-200':'hover:bg-gray-50'}`}><BarChart3 size={14}/> 視覺化</button>
                                                    <button onClick={()=>setResultViewMode('text')} className={`flex items-center gap-2 text-xs font-bold px-3 py-2 rounded-lg border transition-colors ${resultViewMode==='text'?'bg-purple-50 text-purple-700 border-purple-200':'hover:bg-gray-50'}`}><ShieldCheck size={14}/> 風險指標</button>
                                                    <button onClick={()=>setResultViewMode('guide')} className={`flex items-center gap-2 text-xs font-bold px-3 py-2 rounded-lg border transition-colors ${resultViewMode==='guide'?'bg-purple-50 text-purple-700 border-purple-200':'hover:bg-gray-50'}`}><Wrench size={14}/> 實作指引</button>
                                                    <button onClick={()=>handleExportTxt(playbookResult)} className="flex items-center gap-2 text-xs font-bold px-3 py-2 rounded-lg border hover:bg-gray-50"><Download size={14}/></button>
                                                </div>
                                            </div>

                                            {resultViewMode === 'chart' && chartData ? (
                                                <div className="space-y-6 animate-in fade-in">
                                                    <div className="bg-purple-50 p-6 rounded-2xl border border-purple-100">
                                                        <h5 className="font-bold text-purple-900 mb-4 flex items-center gap-2"><LayoutDashboard size={16}/> 優先級分佈</h5>
                                                        <div className="flex h-4 rounded-full overflow-hidden mb-4">
                                                            {Object.entries(chartData.priority_stats||{}).map(([k,v],i)=><div key={k} style={{width:`${(v/Object.values(chartData.priority_stats).reduce((a,b)=>a+b,0))*100}%`}} className={`h-full ${['bg-red-500','bg-amber-500','bg-blue-500'][i%3]}`}></div>)}
                                                        </div>
                                                        <div className="flex gap-4">
                                                            {Object.entries(chartData.priority_stats||{}).map(([k,v],i)=><div key={k} className="flex items-center gap-2 text-sm"><span className={`w-3 h-3 rounded-full ${['bg-red-500','bg-amber-500','bg-blue-500'][i%3]}`}></span><span className="font-medium text-slate-700">{k}: {v}</span></div>)}
                                                        </div>
                                                    </div>
                                                    <div className="grid grid-cols-2 gap-6">
                                                        <div className="bg-white p-5 rounded-2xl border border-gray-200 shadow-sm">
                                                            <h5 className="font-bold text-gray-700 mb-4 flex items-center gap-2"><Database size={16}/> Top Data Sources</h5>
                                                            {Object.entries(chartData.source_stats||{}).map(([k,v])=><div key={k} className="flex justify-between text-sm py-2 border-b last:border-0 border-gray-50"><span className="text-gray-600">{k}</span><span className="font-bold text-purple-600">{v}</span></div>)}
                                                        </div>
                                                        <div className="bg-white p-5 rounded-2xl border border-gray-200 shadow-sm">
                                                            <h5 className="font-bold text-gray-700 mb-4 flex items-center gap-2"><PieChart size={16}/> Risk Categories</h5>
                                                            {Object.entries(chartData.category_stats||{}).map(([k,v])=><div key={k} className="flex justify-between text-sm py-2 border-b last:border-0 border-gray-50"><span className="text-gray-600">{k}</span><span className="font-bold text-indigo-600">{v}</span></div>)}
                                                        </div>
                                                    </div>
                                                </div>
                                            ) : (
                                                <div className="animate-in fade-in prose prose-slate max-w-none prose-sm">
                                                    {renderMarkdown(getResultContent(playbookResult, resultViewMode))}
                                                </div>
                                            )}
                                        </div>
                                    ) : (
                                        <div className="h-full flex flex-col items-center justify-center text-gray-300">
                                            <ListChecks size={80} className="mb-4 opacity-50"/>
                                            <p>請點擊左側生成按鈕</p>
                                        </div>
                                    )}
                                </div>
                            </div>
                        )}

                        {/* TAB 3: HISTORY DASHBOARD */}
                        {activeTab === 'history' && (
                            <div className="flex-1 overflow-y-auto bg-gray-50 p-8 pb-32">
                                <div className="max-w-7xl mx-auto space-y-8">
                                    <div className="flex justify-between items-end">
                                        <div>
                                            <h2 className="text-2xl font-bold text-slate-800">歷史情境戰情看板</h2>
                                            <p className="text-slate-500 text-sm mt-1">匯總所有歷史分析結果，即時掌握威脅分佈態勢</p>
                                        </div>
                                        <div className="flex gap-2">
                                            <button 
                                                onClick={handleGenerateExecutiveSummary}
                                                disabled={summaryLoading}
                                                className="bg-indigo-600 hover:bg-indigo-700 text-white px-4 py-2 rounded-xl text-sm font-bold shadow-lg shadow-indigo-200 flex items-center gap-2 transition-all active:scale-95"
                                            >
                                                {summaryLoading ? <Loader2 size={16} className="animate-spin"/> : <FileText size={16}/>} 產出高層匯報
                                            </button>
                                            <div className="bg-white px-4 py-2 rounded-lg border border-gray-200 shadow-sm text-sm font-bold text-slate-600">
                                                總情境數: {Object.values(aggregatedHistory.byRisk).flat().length}
                                            </div>
                                        </div>
                                    </div>

                                    {/* Stats Cards */}
                                    <div className="grid grid-cols-1 md:grid-cols-4 gap-4">
                                        {[
                                            { label: 'Critical Risk', count: aggregatedHistory.byRisk.Critical?.length || 0, color: 'rose', icon: AlertOctagon },
                                            { label: 'High Risk', count: aggregatedHistory.byRisk.High?.length || 0, color: 'red', icon: AlertTriangle },
                                            { label: 'Medium Risk', count: aggregatedHistory.byRisk.Medium?.length || 0, color: 'yellow', icon: Activity },
                                            { label: 'Low Risk', count: aggregatedHistory.byRisk.Low?.length || 0, color: 'blue', icon: LucideIcons.Info }
                                        ].map((stat, i) => (
                                            <div key={i} className={`bg-white p-5 rounded-xl border-l-4 shadow-sm flex justify-between items-center border-${stat.color}-500`}>
                                                <div>
                                                    <p className={`text-xs font-bold uppercase text-${stat.color}-600 mb-1`}>{stat.label}</p>
                                                    <p className="text-3xl font-bold text-slate-800">{stat.count}</p>
                                                </div>
                                                <stat.icon className={`text-${stat.color}-200`} size={32}/>
                                            </div>
                                        ))}
                                    </div>

                                    {/* Detailed Grids */}
                                    <div className="grid grid-cols-1 lg:grid-cols-3 gap-8">
                                        {/* By Risk Column */}
                                        <div className="lg:col-span-2 space-y-6">
                                            <h4 className="font-bold text-slate-700 flex items-center gap-2"><LayoutGrid size={18}/> 依風險等級歸類 (By Risk)</h4>
                                            <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                                                {['Critical', 'High', 'Medium', 'Low'].map(level => {
                                                    let headerClass = '';
                                                    if(level==='Critical') headerClass = 'bg-rose-50 text-rose-800 border-rose-100';
                                                    else if(level==='High') headerClass = 'bg-red-50 text-red-800 border-red-100';
                                                    else if(level==='Medium') headerClass = 'bg-yellow-50 text-yellow-800 border-yellow-100';
                                                    else headerClass = 'bg-blue-50 text-blue-800 border-blue-100';

                                                    return (
                                                        <div key={level} className="bg-white rounded-xl border border-gray-200 shadow-sm flex flex-col h-full min-h-[400px]">
                                                            <div className={`p-4 border-b font-bold flex justify-between items-center ${headerClass}`}>
                                                                {level} Priority <span className="bg-white px-2 py-0.5 rounded text-xs border shadow-sm">{aggregatedHistory.byRisk[level]?.length || 0}</span>
                                                            </div>
                                                            <div className="p-3 overflow-y-auto flex-1 bg-slate-50 space-y-3">
                                                                {aggregatedHistory.byRisk[level]?.map((s, idx) => <ScenarioCard key={idx} scenario={s} onAskMitigation={handleAskMitigation} onAskRule={handleAskRule} onGenerateLogs={handleGenerateMockLog} onDraftEmail={handleDraftEmail} onAskThreatIntel={handleAskThreatIntel} onAskCompliance={handleComplianceAnalysis} onGenerateIRPlaybook={handleGenerateIRPlaybook} onVisualize={handleVisualize} onSimulate={handleStartSimulation}/>)}
                                                                {(!aggregatedHistory.byRisk[level]?.length) && <div className="text-center text-gray-400 text-xs mt-20">無資料</div>}
                                                            </div>
                                                        </div>
                                                    );
                                                })}
                                            </div>
                                        </div>

                                        {/* By Category Column */}
                                        <div className="space-y-6">
                                            <h4 className="font-bold text-slate-700 flex items-center gap-2"><LayoutDashboard size={18}/> 依威脅類別歸類</h4>
                                            <div className="space-y-4">
                                                {Object.entries(aggregatedHistory.byCategory).map(([cat, items]) => (
                                                    <div key={cat} className="bg-white rounded-xl border border-gray-200 shadow-sm overflow-hidden">
                                                        <div className="p-3 bg-slate-100 border-b border-gray-200 font-bold text-slate-700 text-sm flex justify-between cursor-pointer hover:bg-slate-200 transition-colors">
                                                            {cat} <span>{items.length}</span>
                                                        </div>
                                                        {items.length > 0 && (
                                                            <div className="p-2 max-h-[300px] overflow-y-auto bg-slate-50 space-y-2">
                                                                {items.map((s, idx) => <ScenarioCard key={idx} scenario={s} onAskMitigation={handleAskMitigation} onAskRule={handleAskRule} onGenerateLogs={handleGenerateMockLog} onDraftEmail={handleDraftEmail} onAskThreatIntel={handleAskThreatIntel} onAskCompliance={handleComplianceAnalysis} onGenerateIRPlaybook={handleGenerateIRPlaybook} onVisualize={handleVisualize} onSimulate={handleStartSimulation}/>)}
                                                            </div>
                                                        )}
                                                    </div>
                                                ))}
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        )}

                        {/* TAB 4: NEW - CDM MATRIX (NIST CSF 2.0) */}
                        {activeTab === 'cdm' && (
                            <div className="flex-1 overflow-y-auto bg-gray-50 p-8 pb-32">
                                <div className="max-w-[1600px] mx-auto space-y-6">
                                    <div className="flex justify-between items-end">
                                        <div>
                                            <h2 className="text-2xl font-bold text-slate-800 flex items-center gap-2"><Grid3X3 className="text-indigo-600"/> CDM 戰情矩陣 (NIST CSF 2.0)</h2>
                                            <p className="text-slate-500 text-sm mt-1">基於 Cyber Defense Matrix 框架，自動識別與歸類所有歷史威脅情境</p>
                                        </div>
                                        <div className="flex items-center gap-3">
                                            <div className="flex items-center bg-white border border-gray-200 rounded-lg p-1">
                                                {['ALL', 'Critical', 'High', 'Medium', 'Low'].map(f => (
                                                    <button 
                                                        key={f} 
                                                        onClick={() => setCdmFilter(f)}
                                                        className={`text-xs px-3 py-1.5 rounded font-bold transition-all ${cdmFilter === f ? 'bg-indigo-600 text-white shadow-sm' : 'text-gray-500 hover:bg-gray-50'}`}
                                                    >
                                                        {f}
                                                    </button>
                                                ))}
                                            </div>
                                            <div className="bg-white px-4 py-2 rounded-lg border border-gray-200 shadow-sm text-sm font-bold text-slate-600">
                                                情境總數: {Object.values(aggregatedHistory.byRisk).flat().length}
                                            </div>
                                        </div>
                                    </div>

                                    {/* The Matrix */}
                                    <div className="bg-white rounded-2xl border border-gray-200 shadow-xl overflow-hidden">
                                        <div className="grid grid-cols-6 divide-x divide-gray-200 border-b border-gray-200 bg-slate-50 text-sm font-bold text-slate-700 uppercase tracking-wider">
                                            <div className="p-4 flex items-center justify-center bg-slate-100 text-slate-500">Functions / Assets</div>
                                            <div className="p-4 text-center">Devices</div>
                                            <div className="p-4 text-center">Applications</div>
                                            <div className="p-4 text-center">Networks</div>
                                            <div className="p-4 text-center">Data</div>
                                            <div className="p-4 text-center">Users</div>
                                        </div>
                                        
                                        <div className="divide-y divide-gray-200">
                                            {['GOVERN', 'IDENTIFY', 'PROTECT', 'DETECT', 'RESPOND', 'RECOVER'].map((func) => {
                                                const rowData = cdmMatrixData[func];
                                                let funcColor = 'text-gray-500';
                                                let funcIcon = <LayoutGrid size={16}/>;
                                                
                                                if(func==='GOVERN') { funcColor='text-blue-600'; funcIcon=<Scale size={16}/>; }
                                                if(func==='IDENTIFY') { funcColor='text-indigo-600'; funcIcon=<Eye size={16}/>; }
                                                if(func==='PROTECT') { funcColor='text-emerald-600'; funcIcon=<ShieldCheck size={16}/>; }
                                                if(func==='DETECT') { funcColor='text-amber-600'; funcIcon=<Activity size={16}/>; }
                                                if(func==='RESPOND') { funcColor='text-rose-600'; funcIcon=<Rocket size={16}/>; }
                                                if(func==='RECOVER') { funcColor='text-purple-600'; funcIcon=<History size={16}/>; }

                                                return (
                                                    <div key={func} className="grid grid-cols-6 divide-x divide-gray-200 min-h-[180px]">
                                                        {/* Row Header */}
                                                        <div className="p-4 bg-slate-50 flex flex-col justify-center items-center gap-2 border-r-4 border-r-transparent hover:bg-slate-100 transition-colors">
                                                            <div className={`p-2 rounded-lg bg-white shadow-sm border border-gray-100 ${funcColor}`}>
                                                                {funcIcon}
                                                            </div>
                                                            <span className={`font-bold text-xs ${funcColor}`}>{func}</span>
                                                            <span className="text-[10px] text-gray-400">
                                                                {func === 'GOVERN' && '治理'}
                                                                {func === 'IDENTIFY' && '識別'}
                                                                {func === 'PROTECT' && '保護'}
                                                                {func === 'DETECT' && '偵測'}
                                                                {func === 'RESPOND' && '回應'}
                                                                {func === 'RECOVER' && '復原'}
                                                            </span>
                                                        </div>

                                                        {/* Cells */}
                                                        {['DEVICES', 'APPLICATIONS', 'NETWORKS', 'DATA', 'USERS'].map((asset) => {
                                                            const items = rowData[asset] || [];
                                                            return (
                                                                <div key={asset} className="p-2 relative group hover:bg-gray-50 transition-colors flex flex-col">
                                                                    <div className="absolute top-2 right-2 text-[10px] font-bold text-gray-300 group-hover:text-indigo-300">
                                                                        {items.length > 0 ? items.length : ''}
                                                                    </div>
                                                                    
                                                                    <div className="flex-1 overflow-y-auto max-h-[250px] custom-scrollbar pr-1">
                                                                        {items.length === 0 ? (
                                                                            <div className="h-full flex items-center justify-center">
                                                                                <div className="w-1 h-1 rounded-full bg-gray-200"></div>
                                                                            </div>
                                                                        ) : (
                                                                            items.map((s, idx) => (
                                                                                <ScenarioCard 
                                                                                    key={idx} 
                                                                                    scenario={s} 
                                                                                    minimal={true}
                                                                                    onAskMitigation={handleAskMitigation} 
                                                                                    onAskRule={handleAskRule} 
                                                                                    onGenerateLogs={handleGenerateMockLog} 
                                                                                    onDraftEmail={handleDraftEmail} 
                                                                                    onAskThreatIntel={handleAskThreatIntel} 
                                                                                    onAskCompliance={handleComplianceAnalysis} 
                                                                                    onGenerateIRPlaybook={handleGenerateIRPlaybook} 
                                                                                    onVisualize={handleVisualize}
                                                                                    onSimulate={handleStartSimulation}
                                                                                />
                                                                            ))
                                                                        )}
                                                                    </div>
                                                                </div>
                                                            );
                                                        })}
                                                    </div>
                                                );
                                            })}
                                        </div>
                                    </div>
                                </div>
                            </div>
                        )}
                        
                        {/* TAB 5: LOG GUIDES LIBRARY */}
                        {activeTab === 'guides' && (
                            <div className="flex-1 overflow-y-auto bg-gray-50 p-8 pb-32">
                                <div className="max-w-6xl mx-auto space-y-6">
                                    <div className="flex justify-between items-end">
                                        <div>
                                            <h2 className="text-2xl font-bold text-slate-800 flex items-center gap-2"><Library className="text-indigo-600"/> Log 收集指引庫</h2>
                                            <p className="text-slate-500 text-sm mt-1">彙整系統管理員設定建議，自動排除重複項目</p>
                                        </div>
                                        <div className="bg-white px-4 py-2 rounded-lg border border-gray-200 shadow-sm text-sm font-bold text-slate-600">
                                            已收錄指引數: {logGuides.length}
                                        </div>
                                    </div>
                                    
                                    {logGuides.length === 0 ? (
                                        <div className="flex flex-col items-center justify-center h-96 text-gray-300 border-2 border-dashed border-gray-200 rounded-xl">
                                            <Library size={64} className="mb-4 opacity-50"/>
                                            <p>尚無資料。請先到「系統與威脅分析」進行分析，AI 將自動收錄建議。</p>
                                        </div>
                                    ) : (
                                        <div className="grid gap-4">
                                            {logGuides.map((guide) => (
                                                <div key={guide.id} className="bg-white p-5 rounded-xl border border-gray-200 shadow-sm hover:shadow-md transition-shadow relative group">
                                                    <button 
                                                        onClick={() => handleDeleteGuide(guide.id)}
                                                        className="absolute top-4 right-4 text-gray-300 hover:text-red-500 transition-colors opacity-0 group-hover:opacity-100"
                                                        title="移除此指引"
                                                    >
                                                        <Trash size={16}/>
                                                    </button>
                                                    <div className="flex flex-col md:flex-row gap-6">
                                                        <div className="md:w-1/4">
                                                            <h4 className="font-bold text-lg text-slate-800 flex items-center gap-2 mb-2">
                                                                <Server size={18} className="text-indigo-500"/>
                                                                <SafeText content={guide.system}/>
                                                            </h4>
                                                            <div className="text-xs text-gray-400">收錄時間: <SafeText content={guide.added_at || 'N/A'}/></div>
                                                        </div>
                                                        <div className="md:w-3/4 space-y-3">
                                                            <div className="bg-indigo-50/50 p-3 rounded-lg border border-indigo-100">
                                                                <span className="text-indigo-700 font-bold text-xs uppercase tracking-wider block mb-1">Log 收集項目</span>
                                                                <p className="text-sm text-slate-700"><SafeText content={guide.log_items}/></p>
                                                            </div>
                                                            <div className="bg-emerald-50/50 p-3 rounded-lg border border-emerald-100">
                                                                <span className="text-emerald-700 font-bold text-xs uppercase tracking-wider block mb-1">設定與優化建議</span>
                                                                <p className="text-sm text-slate-700"><SafeText content={guide.config_advice}/></p>
                                                            </div>
                                                        </div>
                                                    </div>
                                                </div>
                                            ))}
                                        </div>
                                    )}
                                </div>
                            </div>
                        )}

                        {/* TAB 6: NEW - RACI MATRIX */}
                        {activeTab === 'raci' && (
                            <div className="flex-1 overflow-y-auto bg-gray-50 p-8 pb-32">
                                <div className="max-w-[1600px] mx-auto space-y-6">
                                    <div className="flex justify-between items-end">
                                        <div>
                                            <h2 className="text-2xl font-bold text-slate-800 flex items-center gap-2"><Users className="text-indigo-600"/> RACI 權責矩陣</h2>
                                            <p className="text-slate-500 text-sm mt-1">明確定義各角色在資安事件中的職責與分工</p>
                                        </div>
                                    </div>

                                    {/* Definitions */}
                                    <div className="bg-white p-6 rounded-xl border border-gray-200 shadow-sm grid grid-cols-1 md:grid-cols-4 gap-4">
                                        <div className="flex items-start gap-3">
                                            <div className="bg-rose-100 text-rose-700 p-2 rounded-lg font-bold">R</div>
                                            <div>
                                                <h5 className="font-bold text-slate-800 text-sm">Responsible (執行者)</h5>
                                                <p className="text-xs text-slate-500 mt-1">實際動手執行任務、完成工作的人。</p>
                                            </div>
                                        </div>
                                        <div className="flex items-start gap-3">
                                            <div className="bg-amber-100 text-amber-700 p-2 rounded-lg font-bold">A</div>
                                            <div>
                                                <h5 className="font-bold text-slate-800 text-sm">Accountable (當責者)</h5>
                                                <p className="text-xs text-slate-500 mt-1">對結果負最終責任，通常是審核或批准者。</p>
                                            </div>
                                        </div>
                                        <div className="flex items-start gap-3">
                                            <div className="bg-blue-100 text-blue-700 p-2 rounded-lg font-bold">C</div>
                                            <div>
                                                <h5 className="font-bold text-slate-800 text-sm">Consulted (諮詢者)</h5>
                                                <p className="text-xs text-slate-500 mt-1">提供專業意見或參與決策，雙向溝通。</p>
                                            </div>
                                        </div>
                                        <div className="flex items-start gap-3">
                                            <div className="bg-emerald-100 text-emerald-700 p-2 rounded-lg font-bold">I</div>
                                            <div>
                                                <h5 className="font-bold text-slate-800 text-sm">Informed (知悉者)</h5>
                                                <p className="text-xs text-slate-500 mt-1">任務完成後需被告知進展，單向溝通。</p>
                                            </div>
                                        </div>
                                    </div>

                                    {/* Matrix Table */}
                                    {raciMatrixData.length === 0 ? (
                                        <div className="flex flex-col items-center justify-center h-64 text-gray-300 border-2 border-dashed border-gray-200 rounded-xl">
                                            <Users size={64} className="mb-4 opacity-50"/>
                                            <p>尚無情境資料。請先到「系統與威脅分析」進行分析，系統將自動生成矩陣。</p>
                                        </div>
                                    ) : (
                                        <div className="bg-white rounded-xl border border-gray-200 shadow-sm overflow-hidden">
                                            <table className="min-w-full divide-y divide-gray-200 text-sm">
                                                <thead className="bg-slate-50">
                                                    <tr>
                                                        <th className="px-6 py-3 text-left text-xs font-bold text-slate-500 uppercase tracking-wider w-1/4">威脅情境 (Threat Scenario)</th>
                                                        <th className="px-6 py-3 text-left text-xs font-bold text-slate-500 uppercase tracking-wider">應變階段 (Phase)</th>
                                                        <th className="px-4 py-3 text-center text-xs font-bold text-indigo-700 uppercase tracking-wider">SOC Analyst</th>
                                                        <th className="px-4 py-3 text-center text-xs font-bold text-slate-700 uppercase tracking-wider">System Admin</th>
                                                        <th className="px-4 py-3 text-center text-xs font-bold text-slate-700 uppercase tracking-wider">SOC Manager</th>
                                                        <th className="px-4 py-3 text-center text-xs font-bold text-slate-700 uppercase tracking-wider">CISO</th>
                                                        <th className="px-4 py-3 text-center text-xs font-bold text-slate-700 uppercase tracking-wider">Asset Owner</th>
                                                    </tr>
                                                </thead>
                                                <tbody className="bg-white divide-y divide-gray-100">
                                                    {raciMatrixData.map((item, idx) => (
                                                        <React.Fragment key={idx}>
                                                            <tr className="bg-slate-50/50">
                                                                <td className="px-6 py-4 font-bold text-slate-800 border-r" rowSpan="6">
                                                                    <div className="flex items-center gap-2">
                                                                        <AlertTriangle size={16} className="text-rose-500"/>
                                                                        {item.scenario}
                                                                    </div>
                                                                    <div className="text-xs text-slate-400 mt-1 ml-6">{item.category}</div>
                                                                </td>
                                                            </tr>
                                                            {/* Phase 1: Detection */}
                                                            <tr className="hover:bg-indigo-50/30 transition-colors">
                                                                <td className="px-6 py-3 border-r text-xs font-medium text-slate-600">1. 監控與偵測 (Detect)</td>
                                                                <td className="px-4 py-3 text-center font-bold text-rose-600 bg-rose-50">R</td>
                                                                <td className="px-4 py-3 text-center text-emerald-600">I</td>
                                                                <td className="px-4 py-3 text-center text-amber-600">A</td>
                                                                <td className="px-4 py-3 text-center text-emerald-600">I</td>
                                                                <td className="px-4 py-3 text-center text-emerald-600">I</td>
                                                            </tr>
                                                            {/* Phase 2: Triage */}
                                                            <tr className="hover:bg-indigo-50/30 transition-colors">
                                                                <td className="px-6 py-3 border-r text-xs font-medium text-slate-600">2. 驗證與分析 (Triage)</td>
                                                                <td className="px-4 py-3 text-center font-bold text-rose-600 bg-rose-50">R</td>
                                                                <td className="px-4 py-3 text-center text-blue-600">C</td>
                                                                <td className="px-4 py-3 text-center text-amber-600">A</td>
                                                                <td className="px-4 py-3 text-center text-emerald-600">I</td>
                                                                <td className="px-4 py-3 text-center text-emerald-600">I</td>
                                                            </tr>
                                                            {/* Phase 3: Containment */}
                                                            <tr className="hover:bg-indigo-50/30 transition-colors">
                                                                <td className="px-6 py-3 border-r text-xs font-medium text-slate-600">3. 圍堵與根除 (Contain)</td>
                                                                <td className="px-4 py-3 text-center text-blue-600">C</td>
                                                                <td className="px-4 py-3 text-center font-bold text-rose-600 bg-rose-50">R</td>
                                                                <td className="px-4 py-3 text-center text-amber-600">A</td>
                                                                <td className="px-4 py-3 text-center text-emerald-600">I</td>
                                                                <td className="px-4 py-3 text-center text-blue-600">C</td>
                                                            </tr>
                                                            {/* Phase 4: Recovery */}
                                                            <tr className="hover:bg-indigo-50/30 transition-colors">
                                                                <td className="px-6 py-3 border-r text-xs font-medium text-slate-600">4. 復原與重啟 (Recover)</td>
                                                                <td className="px-4 py-3 text-center text-emerald-600">I</td>
                                                                <td className="px-4 py-3 text-center font-bold text-rose-600 bg-rose-50">R</td>
                                                                <td className="px-4 py-3 text-center text-emerald-600">I</td>
                                                                <td className="px-4 py-3 text-center text-blue-600">C</td>
                                                                <td className="px-4 py-3 text-center text-amber-600">A</td>
                                                            </tr>
                                                            {/* Phase 5: Reporting */}
                                                            <tr className="hover:bg-indigo-50/30 transition-colors border-b border-gray-200">
                                                                <td className="px-6 py-3 border-r text-xs font-medium text-slate-600">5. 通報與檢討 (Report)</td>
                                                                <td className="px-4 py-3 text-center text-blue-600">C</td>
                                                                <td className="px-4 py-3 text-center text-blue-600">C</td>
                                                                <td className="px-4 py-3 text-center font-bold text-rose-600 bg-rose-50">R</td>
                                                                <td className="px-4 py-3 text-center text-amber-600">A</td>
                                                                <td className="px-4 py-3 text-center text-emerald-600">I</td>
                                                            </tr>
                                                        </React.Fragment>
                                                    ))}
                                                </tbody>
                                            </table>
                                        </div>
                                    )}
                                </div>
                            </div>
                        )}
                    </div>

                     {/* Simulation Modal */}
                     {simulationModalOpen && simScenario && (
                        <div className="fixed inset-0 bg-black/80 z-50 flex items-center justify-center p-4 animate-in fade-in">
                            <div className="bg-white rounded-xl w-full max-w-4xl h-[90vh] flex flex-col shadow-2xl relative overflow-hidden">
                                <div className="bg-rose-900 text-white p-4 flex justify-between items-center rounded-t-xl shrink-0 z-10 shadow-md">
                                    <div>
                                        <h3 className="font-bold text-lg flex items-center gap-2"><Swords size={20}/> SOC 攻防演練模擬</h3>
                                        <p className="text-xs text-rose-200">情境: {simScenario.title}</p>
                                    </div>
                                    <button onClick={() => setSimulationModalOpen(false)} className="hover:text-rose-200"><X size={24}/></button>
                                </div>
                                
                                <div className="flex-1 overflow-y-auto p-6 space-y-6 bg-slate-50 relative">
                                    <div className="absolute inset-0 bg-[url('[https://www.transparenttextures.com/patterns/carbon-fibre.png](https://www.transparenttextures.com/patterns/carbon-fibre.png)')] opacity-5 pointer-events-none"></div>
                                    {simHistory.map((msg, i) => (
                                        <div key={i} className={`flex ${msg.role === 'user' ? 'justify-end' : 'justify-start'}`}>
                                            <div className={`max-w-[80%] p-4 rounded-2xl text-sm leading-relaxed shadow-sm relative ${msg.role === 'user' ? 'bg-indigo-600 text-white rounded-tr-none' : 'bg-white text-slate-800 border border-gray-200 rounded-tl-none'}`}>
                                                {msg.role === 'bot' && <div className="absolute -top-2 -left-2 bg-rose-600 text-white text-[10px] px-2 py-0.5 rounded-full font-bold">RED TEAM</div>}
                                                {msg.role === 'user' && <div className="absolute -top-2 -right-2 bg-indigo-500 text-white text-[10px] px-2 py-0.5 rounded-full font-bold">BLUE TEAM</div>}
                                                <div className="mt-1">{renderMarkdown(msg.text)}</div>
                                            </div>
                                        </div>
                                    ))}
                                    {simLoading && (
                                        <div className="flex justify-start">
                                            <div className="bg-white p-4 rounded-2xl border border-gray-200 shadow-sm flex items-center gap-2">
                                                <Loader2 className="animate-spin text-rose-600" size={16}/>
                                                <span className="text-xs text-slate-500">紅軍正在策劃下一步攻擊...</span>
                                            </div>
                                        </div>
                                    )}
                                    <div ref={simChatEndRef} />
                                </div>

                                {/* Audio Player Bar */}
                                {simAudioUrl && (
                                    <div className="bg-slate-100 border-t border-slate-200 p-2 flex justify-center items-center gap-2 shrink-0">
                                        <Volume2 size={16} className="text-rose-600 animate-pulse"/>
                                        <span className="text-xs font-bold text-slate-600 mr-2">戰情播報:</span>
                                        <audio controls autoPlay src={simAudioUrl} className="h-8 w-64"/>
                                    </div>
                                )}

                                <form onSubmit={handleSimSubmit} className="p-4 border-t bg-white rounded-b-xl shrink-0 z-10 flex gap-2">
                                    <input 
                                        className="flex-1 p-3 border border-gray-300 rounded-lg text-sm outline-none focus:border-rose-500 focus:ring-1 focus:ring-rose-500"
                                        placeholder="輸入您的應對措施 (例如: 隔離主機, 查看 Firewall Log...)"
                                        value={simInput}
                                        onChange={(e) => setSimInput(e.target.value)}
                                        disabled={simLoading}
                                        autoFocus
                                    />
                                    <button type="submit" disabled={simLoading} className="bg-rose-600 text-white px-6 rounded-lg hover:bg-rose-700 disabled:opacity-50 font-bold shadow-lg shadow-rose-200 flex items-center gap-2">
                                        {simLoading ? <Loader2 size={18} className="animate-spin"/> : <Send size={18}/>} 行動
                                    </button>
                                </form>
                            </div>
                        </div>
                     )}

                     {/* Help Modal for Permission Error */}
                     {showRulesModal && (
                        <div className="fixed inset-0 bg-black/70 z-50 flex items-center justify-center p-4 animate-in fade-in">
                            <div className="bg-white rounded-xl w-full max-w-lg shadow-2xl p-6 relative">
                                <button onClick={() => setShowRulesModal(false)} className="absolute top-4 right-4 text-gray-400 hover:text-gray-600"><X size={20}/></button>
                                <h3 className="text-lg font-bold text-red-600 mb-2 flex items-center gap-2"><AlertTriangle/> 資料庫權限不足</h3>
                                <p className="text-sm text-gray-600 mb-4">
                                    為了讓 GitHub Pages 上的戰情室能共用資料，請到 Firebase Console 修改 <strong>Firestore Database Rules</strong>：
                                </p>
                                <div className="bg-slate-900 text-gray-200 p-4 rounded-lg text-xs font-mono mb-4 overflow-x-auto">
                                    <pre>{`rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    match /{document=**} {
      allow read, write: if true;
    }
  }
}`}</pre>
                                </div>
                                <div className="text-right">
                                    <a href="[https://console.firebase.google.com/](https://console.firebase.google.com/)" target="_blank" className="text-indigo-600 text-sm font-bold hover:underline">前往 Firebase Console &rarr;</a>
                                </div>
                            </div>
                        </div>
                     )}
                     
                     {/* API Key Modal */}
                     {showApiKeyModal && (
                        <div className="fixed inset-0 bg-black/70 z-50 flex items-center justify-center p-4 animate-in fade-in">
                            <div className="bg-white rounded-xl w-full max-w-md shadow-2xl p-6 relative">
                                <button onClick={() => setShowApiKeyModal(false)} className="absolute top-4 right-4 text-gray-400 hover:text-gray-600"><X size={20}/></button>
                                <h3 className="text-lg font-bold text-slate-800 mb-2 flex items-center gap-2"><Key className="text-indigo-600"/> 設定 API Key</h3>
                                <p className="text-xs text-gray-500 mb-4">
                                    請輸入您的 Google Gemini API Key 以啟用 AI 分析功能。您的金鑰僅會儲存在本地瀏覽器中，不會傳送至其他伺服器。
                                    <br/>
                                    <a href="[https://aistudio.google.com/app/apikey](https://aistudio.google.com/app/apikey)" target="_blank" className="text-indigo-600 underline">在此取得 API Key</a>
                                </p>
                                <div className="mb-4">
                                    <input 
                                        type="password" 
                                        className="w-full p-3 border border-gray-300 rounded-lg text-sm focus:ring-2 focus:ring-indigo-500 outline-none"
                                        placeholder="AIza..."
                                        value={userApiKey}
                                        onChange={(e) => setUserApiKey(e.target.value)}
                                    />
                                </div>
                                <div className="flex justify-end gap-2">
                                    <button onClick={() => setShowApiKeyModal(false)} className="px-4 py-2 text-sm text-gray-500 hover:bg-gray-100 rounded-lg">取消</button>
                                    <button onClick={() => handleSaveApiKey(userApiKey)} className="px-4 py-2 text-sm bg-indigo-600 text-white rounded-lg hover:bg-indigo-700">儲存</button>
                                </div>
                            </div>
                        </div>
                     )}

                     {/* Summary Modal */}
                     {summaryModalOpen && (
                        <div className="fixed inset-0 bg-black/70 z-50 flex items-center justify-center p-4 animate-in fade-in">
                            <div className="bg-white rounded-xl w-full max-w-2xl h-[80vh] flex flex-col shadow-2xl">
                                <div className="bg-slate-900 text-white p-4 flex justify-between items-center rounded-t-xl">
                                    <h3 className="font-bold text-lg flex items-center gap-2"><FileText/> 資安態勢高層匯報</h3>
                                    <button onClick={() => setSummaryModalOpen(false)} className="hover:text-gray-300"><X size={20}/></button>
                                </div>
                                <div className="p-6 flex-1 overflow-y-auto">
                                    {summaryLoading ? (
                                        <div className="flex flex-col items-center justify-center h-full text-indigo-500">
                                            <Loader2 size={48} className="mb-4 animate-spin"/>
                                            <p className="font-bold">正在撰寫高層匯報...</p>
                                        </div>
                                    ) : (
                                        <div className="prose prose-sm max-w-none">
                                            {renderMarkdown(summaryContent)}
                                        </div>
                                    )}
                                </div>
                                <div className="p-4 border-t bg-gray-50 flex justify-end rounded-b-xl">
                                    <button onClick={()=>handleExportTxt(summaryContent)} className="bg-indigo-600 text-white px-4 py-2 rounded-lg text-sm font-bold hover:bg-indigo-700 flex items-center gap-2"><Download size={16}/> 下載報告</button>
                                </div>
                            </div>
                        </div>
                     )}

                     {/* Visualization Modal */}
                     {visualizeModalOpen && selectedScenarioForVis && (
                        <div className="fixed inset-0 bg-black/80 z-50 flex items-center justify-center p-4 animate-in fade-in">
                            <div className="bg-white rounded-xl w-full max-w-6xl h-[90vh] flex flex-col shadow-2xl">
                                <div className="bg-slate-900 text-white p-4 flex justify-between items-center rounded-t-xl">
                                    <div>
                                        <h3 className="font-bold text-lg flex items-center gap-2"><Eye/> 攻擊路徑視覺化</h3>
                                        <p className="text-xs text-slate-400">{selectedScenarioForVis.title}</p>
                                    </div>
                                    <button onClick={() => setVisualizeModalOpen(false)} className="hover:text-gray-300"><X size={20}/></button>
                                </div>
                                <div className="flex-1 flex overflow-hidden">
                                    {/* Main Chart Area */}
                                    <div className="w-2/3 p-6 bg-slate-50 flex flex-col overflow-y-auto border-r border-gray-200">
                                        <h4 className="text-sm font-bold text-slate-600 mb-4 uppercase tracking-wider flex items-center gap-2"><Waypoints size={16}/> 攻擊流程圖 (Attack Flow)</h4>
                                        <div className="flex-1 bg-white rounded-xl shadow-sm border border-slate-200 p-4 flex items-center justify-center min-h-[400px]">
                                            <AttackGraph mermaidCode={selectedScenarioForVis.mermaid_code || `graph LR; A[Attacker] -->|Exploit| B(${selectedScenarioForVis.category}); B -->|Lateral| C[Target]; style A fill:#f9f,stroke:#333; style B fill:#ccf,stroke:#333;`} />
                                        </div>
                                    </div>
                                    
                                    {/* Right Side: Data Source Mapping */}
                                    <div className="w-1/3 p-6 overflow-y-auto bg-white">
                                        <h4 className="text-sm font-bold text-slate-600 mb-4 uppercase tracking-wider flex items-center gap-2"><Database size={16}/> SIEM 監控數據源對照表</h4>
                                        
                                        {/* Dynamic Data Source Table from AI response */}
                                        <div className="space-y-4">
                                            {(selectedScenarioForVis.data_sources || []).map((ds, idx) => (
                                                <div key={idx} className="p-3 border border-slate-100 rounded-lg hover:bg-slate-50 transition-colors">
                                                    <div className="flex justify-between items-center mb-1">
                                                        <span className="text-xs font-bold text-indigo-600 bg-indigo-50 px-2 py-0.5 rounded">{ds.device}</span>
                                                        <span className="text-[10px] text-slate-400">Step {idx + 1}</span>
                                                    </div>
                                                    <div className="text-sm text-slate-700 font-mono bg-slate-100 p-2 rounded mt-2">{ds.event}</div>
                                                </div>
                                            ))}
                                            
                                            {/* Fallback if no specific data sources parsed */}
                                            {(!selectedScenarioForVis.data_sources || selectedScenarioForVis.data_sources.length === 0) && (
                                                <div className="text-center text-gray-400 text-xs py-10">
                                                    <p>AI 未提供詳細數據源對照。</p>
                                                    <button 
                                                        onClick={() => {
                                                            setVisualizeModalOpen(false);
                                                            handleGenerateMockLog(selectedScenarioForVis.title);
                                                        }}
                                                        className="mt-2 text-indigo-600 hover:underline"
                                                    >
                                                        點此生成 Log 樣本
                                                    </button>
                                                </div>
                                            )}
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                     )}

                     {/* Log Parser Modal */}
                     {logParserOpen && (
                        <div className="fixed inset-0 bg-black/70 z-50 flex items-center justify-center p-4 animate-in fade-in">
                            <div className="bg-white rounded-xl w-full max-w-3xl h-[80vh] flex flex-col shadow-2xl">
                                <div className="bg-slate-900 text-white p-4 flex justify-between items-center rounded-t-xl">
                                    <h3 className="font-bold text-lg flex items-center gap-2"><Microscope/> Log 智能解析器</h3>
                                    <button onClick={() => setLogParserOpen(false)} className="hover:text-gray-300"><X size={20}/></button>
                                </div>
                                <div className="p-6 flex-1 flex flex-col overflow-hidden">
                                    <div className="flex-1 flex flex-col gap-2 mb-4">
                                        <label className="text-xs font-bold text-gray-500 uppercase">原始 Log 內容 (Raw Log)</label>
                                        <textarea 
                                            className="w-full h-32 p-3 border border-gray-300 rounded-lg font-mono text-xs focus:ring-2 focus:ring-indigo-500 resize-none" 
                                            placeholder="請貼上 Syslog, CEF, JSON 或其他格式的 Log..."
                                            value={rawLogInput}
                                            onChange={(e) => setRawLogInput(e.target.value)}
                                        />
                                    </div>
                                    <button 
                                        onClick={handleLogParse} 
                                        disabled={isParsingLog || !rawLogInput}
                                        className="bg-indigo-600 text-white py-2 rounded-lg font-bold shadow-md hover:bg-indigo-700 disabled:opacity-50 mb-4 flex items-center justify-center gap-2"
                                    >
                                        {isParsingLog ? <Loader2 size={16} className="animate-spin"/> : <Wand2 size={16}/>} 開始解析
                                    </button>
                                    <div className="flex-1 border border-gray-200 rounded-lg bg-slate-50 p-4 overflow-y-auto">
                                        {parsedLogResult ? (
                                            <pre className="text-xs font-mono text-slate-700 whitespace-pre-wrap">{parsedLogResult}</pre>
                                        ) : (
                                            <div className="h-full flex items-center justify-center text-gray-400 text-xs">解析結果將顯示於此...</div>
                                        )}
                                    </div>
                                </div>
                            </div>
                        </div>
                     )}

                     {/* Query Generator Modal */}
                     {queryGenOpen && (
                        <div className="fixed inset-0 bg-black/70 z-50 flex items-center justify-center p-4 animate-in fade-in">
                            <div className="bg-white rounded-xl w-full max-w-lg h-[600px] flex flex-col shadow-2xl">
                                <div className="bg-slate-900 text-white p-4 flex justify-between items-center rounded-t-xl">
                                    <h3 className="font-bold text-lg flex items-center gap-2"><LucideIcons.Terminal/> 查詢語法生成器</h3>
                                    <button onClick={() => setQueryGenOpen(false)} className="hover:text-gray-300"><X size={20}/></button>
                                </div>
                                <div className="p-6 flex-1 flex flex-col overflow-hidden">
                                    <div className="mb-4">
                                        <label className="text-xs font-bold text-gray-500 uppercase block mb-1">目標平台</label>
                                        <select 
                                            className="w-full p-2 border border-gray-300 rounded-lg text-sm bg-white"
                                            value={queryPlatform}
                                            onChange={(e) => setQueryPlatform(e.target.value)}
                                        >
                                            <option value="Splunk">Splunk (SPL)</option>
                                            <option value="Elasticsearch">Elasticsearch (KQL)</option>
                                            <option value="SQL">SQL (Standard)</option>
                                            <option value="Graylog">Graylog</option>
                                        </select>
                                    </div>
                                    <div className="mb-4 flex-1 flex flex-col">
                                        <label className="text-xs font-bold text-gray-500 uppercase block mb-1">自然語言描述</label>
                                        <textarea 
                                            className="w-full h-24 p-3 border border-gray-300 rounded-lg text-sm resize-none focus:ring-2 focus:ring-indigo-500"
                                            placeholder="例如：找出過去 24 小時內登入失敗超過 10 次的來源 IP..."
                                            value={nlQueryInput}
                                            onChange={(e) => setNlQueryInput(e.target.value)}
                                        />
                                    </div>
                                    <button 
                                        onClick={handleGenerateQuery} 
                                        disabled={isGeneratingQuery || !nlQueryInput}
                                        className="bg-indigo-600 text-white py-2 rounded-lg font-bold shadow-md hover:bg-indigo-700 disabled:opacity-50 mb-4 flex items-center justify-center gap-2"
                                    >
                                        {isGeneratingQuery ? <Loader2 size={16} className="animate-spin"/> : <Code2 size={16}/>} 生成查詢語法
                                    </button>
                                    <div className="flex-1 border border-gray-200 rounded-lg bg-slate-900 p-4 overflow-y-auto">
                                        {generatedQuery ? (
                                            <pre className="text-xs font-mono text-green-400 whitespace-pre-wrap">{generatedQuery}</pre>
                                        ) : (
                                            <div className="h-full flex items-center justify-center text-gray-500 text-xs">語法將顯示於此...</div>
                                        )}
                                    </div>
                                </div>
                            </div>
                        </div>
                     )}

                     {/* Script Analyzer Modal */}
                     {scriptAnalyzerOpen && (
                        <div className="fixed inset-0 bg-black/70 z-50 flex items-center justify-center p-4 animate-in fade-in">
                            <div className="bg-white rounded-xl w-full max-w-3xl h-[80vh] flex flex-col shadow-2xl">
                                <div className="bg-slate-900 text-white p-4 flex justify-between items-center rounded-t-xl">
                                    <h3 className="font-bold text-lg flex items-center gap-2"><LucideIcons.FileCode2/> 惡意腳本分析器</h3>
                                    <button onClick={() => setScriptAnalyzerOpen(false)} className="hover:text-gray-300"><X size={20}/></button>
                                </div>
                                <div className="p-6 flex-1 flex flex-col overflow-hidden">
                                    <div className="flex-1 flex flex-col gap-2 mb-4">
                                        <label className="text-xs font-bold text-gray-500 uppercase">可疑腳本內容 (PowerShell/Bash/Python)</label>
                                        <textarea 
                                            className="w-full h-32 p-3 border border-gray-300 rounded-lg font-mono text-xs focus:ring-2 focus:ring-rose-500 resize-none" 
                                            placeholder="請貼上混淆或可疑的腳本代碼..."
                                            value={scriptInput}
                                            onChange={(e) => setScriptInput(e.target.value)}
                                        />
                                    </div>
                                    <button 
                                        onClick={handleAnalyzeScript} 
                                        disabled={isAnalyzingScript || !scriptInput}
                                        className="bg-rose-600 text-white py-2 rounded-lg font-bold shadow-md hover:bg-rose-700 disabled:opacity-50 mb-4 flex items-center justify-center gap-2"
                                    >
                                        {isAnalyzingScript ? <Loader2 size={16} className="animate-spin"/> : <Wand2 size={16}/>} 開始分析
                                    </button>
                                    <div className="flex-1 border border-gray-200 rounded-lg bg-slate-50 p-4 overflow-y-auto prose prose-sm max-w-none">
                                        {scriptAnalysisResult ? (
                                            renderMarkdown(scriptAnalysisResult)
                                        ) : (
                                            <div className="h-full flex items-center justify-center text-gray-400 text-xs">分析結果將顯示於此...</div>
                                        )}
                                    </div>
                                </div>
                            </div>
                        </div>
                     )}

                     {/* SOC Copilot Chat Window */}
                     {isChatOpen && (
                        <div className="fixed bottom-6 right-6 w-[600px] h-[80vh] bg-white rounded-2xl shadow-2xl flex flex-col border border-gray-200 z-50 animate-in slide-in-from-bottom-10 fade-in">
                            <div className="bg-slate-900 text-white p-4 rounded-t-2xl flex justify-between items-center shadow-md">
                                <h3 className="font-bold flex items-center gap-2"><MessageSquare size={18}/> SOC Copilot</h3>
                                <div className="flex gap-2">
                                    <button onClick={() => setIsChatOpen(false)} className="hover:text-gray-300"><X size={18}/></button>
                                </div>
                            </div>
                            <div className="flex-1 overflow-y-auto p-4 space-y-4 bg-slate-50 chat-scroll">
                                {chatHistory.map((msg, i) => (
                                    <div key={i} className={`flex ${msg.role === 'user' ? 'justify-end' : 'justify-start'}`}>
                                        <div className={`max-w-[85%] p-3 rounded-2xl text-sm leading-relaxed shadow-sm ${msg.role === 'user' ? 'bg-indigo-600 text-white rounded-tr-none' : 'bg-white text-slate-700 border border-gray-200 rounded-tl-none'}`}>
                                            {msg.role === 'bot' ? renderMarkdown(msg.text) : msg.text}
                                        </div>
                                    </div>
                                ))}
                                <div ref={chatEndRef} />
                            </div>
                            <form onSubmit={handleChatSubmit} className="p-3 border-t bg-white rounded-b-2xl flex gap-2">
                                <input 
                                    className="flex-1 p-2 border border-gray-300 rounded-lg text-sm outline-none focus:border-indigo-500 focus:ring-1 focus:ring-indigo-500"
                                    placeholder="輸入問題..."
                                    value={chatInput}
                                    onChange={(e) => setChatInput(e.target.value)}
                                    disabled={chatLoading}
                                />
                                <button type="submit" disabled={chatLoading} className="bg-indigo-600 text-white p-2 rounded-lg hover:bg-indigo-700 disabled:opacity-50">
                                    {chatLoading ? <Loader2 size={18} className="animate-spin"/> : <Send size={18}/>}
                                </button>
                            </form>
                        </div>
                     )}

                     {/* Floating Chat Button (When closed) */}
                     {!isChatOpen && (
                        <button 
                            onClick={() => setIsChatOpen(true)}
                            className="fixed bottom-6 right-6 bg-indigo-600 text-white p-4 rounded-full shadow-2xl hover:bg-indigo-700 hover:scale-110 transition-all z-40 flex items-center justify-center group"
                            title="開啟 SOC 智能助手"
                        >
                            <MessageSquare size={24} />
                            <span className="absolute right-full mr-2 bg-slate-800 text-white text-xs px-2 py-1 rounded opacity-0 group-hover:opacity-100 transition-opacity whitespace-nowrap">AI 助手</span>
                        </button>
                     )}

                     {/* Toast Notification */}
                     {toast && (
                        <div className={`fixed bottom-4 left-1/2 -translate-x-1/2 px-6 py-3 rounded-full text-white text-sm font-bold shadow-2xl animate-fade-in-up z-50 flex items-center gap-2 ${toast.type==='error'?'bg-red-500':'bg-emerald-600'}`}>
                            {toast.type==='success' && <CheckCircle size={16}/>}
                            {toast.type==='error' && <AlertTriangle size={16}/>}
                            {toast.message}
                        </div>
                    )}
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(React.createElement(WarRoom));
    </script>
</body>
</html>