<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SIEM 資產與威脅戰情室</title>
    
    <!-- 1. 引入 Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- 2. 引入 Babel -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/babel-standalone/7.23.6/babel.min.js"></script>

    <!-- 3. 引入 Mermaid.js (用於畫圖) -->
    <script src="https://cdn.jsdelivr.net/npm/mermaid/dist/mermaid.min.js"></script>

    <!-- 4. 設定 Tailwind 主題 -->
    <script>
      tailwind.config = {
        theme: {
          extend: {
            colors: {
              slate: { 850: '#1e293b' }
            },
            animation: {
                'fade-in-up': 'fadeInUp 0.3s ease-out forwards',
                'pulse-fast': 'pulse 1.5s cubic-bezier(0.4, 0, 0.6, 1) infinite',
            },
            keyframes: {
                fadeInUp: {
                    '0%': { opacity: '0', transform: 'translateY(10px)' },
                    '100%': { opacity: '1', transform: 'translateY(0)' },
                }
            }
          }
        }
      }
    </script>

    <!-- 5. 設定 Import Map -->
    <script type="importmap">
      {
        "imports": {
          "react": "https://esm.sh/react@18.2.0",
          "react-dom/client": "https://esm.sh/react-dom@18.2.0/client",
          "lucide-react": "https://esm.sh/lucide-react@0.292.0"
        }
      }
    </script>
    <style>
        /* 捲軸美化 */
        ::-webkit-scrollbar { width: 6px; height: 6px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 10px; }
        ::-webkit-scrollbar-thumb:hover { background: #94a3b8; }

        .chat-scroll::-webkit-scrollbar { width: 5px; }
        
        /* Markdown prose 強化 */
        .prose pre { 
            background: #0f172a !important; 
            border: 1px solid #1e293b;
            color: #38bdf8 !important;
        }
        .prose code { color: #f472b6; font-weight: 600; }
    </style>
</head>
<body class="bg-gray-100 text-slate-800 h-screen w-screen overflow-hidden flex flex-col">
    
    <div id="root" class="flex-1 flex flex-col overflow-hidden"></div>

    <!-- 6. 主程式邏輯 -->
    <script type="text/babel" data-type="module" data-presets="react">
        import React, { useState, useRef, useEffect, useMemo } from 'react';
        import ReactDOM from 'react-dom/client';
        import * as LucideIcons from 'lucide-react';
        
        // Firebase SDK
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, onSnapshot, collection } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        // --- Mermaid Initialization ---
        mermaid.initialize({ 
            startOnLoad: false, 
            theme: 'base',
            securityLevel: 'loose',
            themeVariables: {
                primaryColor: '#e0e7ff',
                lineColor: '#6366f1',
                secondaryColor: '#f1f5f9',
                tertiaryColor: '#fff',
                fontSize: '14px',
                fontFamily: 'system-ui'
            }
        });

        // --- Helper: Safe String ---
        const safeString = (content) => {
            if (content === null || content === undefined) return '';
            if (typeof content === 'string') return content;
            if (typeof content === 'object' && content.seconds) return new Date(content.seconds * 1000).toLocaleString();
            try { return JSON.stringify(content); } catch(e) { return String(content); }
        };

        // --- Component: Attack Visualization Chart ---
        const AttackGraph = ({ mermaidCode }) => {
            const containerRef = useRef(null);
            const [error, setError] = useState(null);

            useEffect(() => {
                if (!mermaidCode || !containerRef.current) return;
                
                const renderChart = async () => {
                    setError(null);
                    containerRef.current.innerHTML = '<div class="flex items-center gap-2 text-slate-400 animate-pulse"><div class="w-2 h-2 rounded-full bg-indigo-500"></div>渲染圖表中...</div>';
                    try {
                        const id = `mermaid-${Math.random().toString(36).substr(2, 9)}`;
                        // Validate syntax
                        await mermaid.parse(mermaidCode);
                        const { svg } = await mermaid.render(id, mermaidCode);
                        containerRef.current.innerHTML = svg;
                    } catch (e) {
                        console.error("Mermaid Render Error:", e);
                        setError("圖表語法錯誤或無法渲染");
                        containerRef.current.innerHTML = "";
                    }
                };

                renderChart();
            }, [mermaidCode]);

            return (
                <div className="w-full h-full flex flex-col items-center justify-center min-h-[400px]">
                    <div ref={containerRef} className="w-full flex justify-center p-4"></div>
                    {error && <div className="text-red-500 text-xs mt-2 bg-red-50 px-3 py-1 rounded border border-red-100">{error}</div>}
                </div>
            );
        };

        // --- Component: Safe Markdown Renderer ---
        const RenderMarkdown = ({ text }) => {
            if (!text) return null;
            const lines = text.split('\n');
            const elements = [];
            let inCodeBlock = false;
            let codeLines = [];

            lines.forEach((line, i) => {
                if (line.trim().startsWith('```')) {
                    if (inCodeBlock) {
                        elements.push(<pre key={`code-${i}`} className="bg-slate-900 text-blue-300 p-4 rounded-lg text-xs overflow-x-auto font-mono my-3 shadow-inner"><code>{codeLines.join('\n')}</code></pre>);
                        codeLines = [];
                    }
                    inCodeBlock = !inCodeBlock;
                    return;
                }
                
                if (inCodeBlock) {
                    codeLines.push(line);
                    return;
                }

                const trimmed = line.trim();
                if (trimmed.startsWith('###')) {
                    elements.push(<h3 key={i} className="font-bold text-slate-800 mt-5 mb-2 border-l-4 border-indigo-500 pl-3 text-lg">{trimmed.replace(/#/g, '')}</h3>);
                } else if (trimmed.startsWith('- ') || trimmed.startsWith('* ')) {
                    elements.push(<li key={i} className="ml-4 text-sm text-slate-600 mb-1 list-disc">{trimmed.substring(2)}</li>);
                } else if (trimmed.length > 0) {
                    elements.push(<p key={i} className="text-sm text-slate-600 mb-2 leading-relaxed">{trimmed}</p>);
                }
            });
            return <div className="prose prose-sm max-w-none">{elements}</div>;
        };

        // --- Main App Component ---
        const WarRoom = () => {
            const { 
                Briefcase, Server, ShieldCheck, Target, Activity, Loader2, BrainCircuit, 
                Cloud, CloudOff, Check, Plus, Trash, ArrowUp, ArrowDown, Settings, 
                ListChecks, BarChart3, Wrench, Download, LayoutGrid, ScrollText, Wand2,
                LayoutDashboard, History, AlertOctagon, AlertTriangle, Info,
                Mail, MessageCircleQuestion, FileCode, FileSpreadsheet,
                Fingerprint, Network, Laptop, Lock, Save, MessageSquare, Send, X, Code2, ShieldAlert, FileJson, Bug, Microscope,
                Footprints, Globe, Scale, Terminal, BookOpen, Eye, Waypoints, Maximize2, Minimize2
            } = LucideIcons;

            // API Key Protection
            const _p1 = "AIzaSyBILGldyB";
            const _p2 = "CUqYZ_Ay87f49K";
            const _p3 = "nlBs4-dvx8I";
            const apiKey = _p1 + _p2 + _p3;

            // Firebase Config
            const getFirebaseConfig = () => {
                if (typeof __firebase_config !== 'undefined') return JSON.parse(__firebase_config);
                return {
                    apiKey: "AIzaSyA98h3qS1RWeWuSKTWZmMmYsUG-cZl8YwE",
                    authDomain: "siem-6dc7e.firebaseapp.com",
                    projectId: "siem-6dc7e",
                    storageBucket: "siem-6dc7e.firebasestorage.app",
                    messagingSenderId: "285198821105",
                    appId: "1:285198821105:web:17fc91f4e8567a2bdc2b50",
                    measurementId: "G-P1SMMD2Y2X"
                };
            };
            
            const app = initializeApp(getFirebaseConfig());
            const auth = getAuth(app);
            const db = getFirestore(app);
            const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-siem-app';

            // States
            const [user, setUser] = useState(null);
            const [syncStatus, setSyncStatus] = useState('connecting');
            const [activeTab, setActiveTab] = useState('assets'); 
            const [lastSaved, setLastSaved] = useState(null);
            const [dbError, setDbError] = useState('');
            const [toast, setToast] = useState(null);
            
            // Core Data
            const [assetList, setAssetList] = useState([]);
            const [threatData, setThreatData] = useState(null);
            const [threatLoading, setThreatLoading] = useState(false);
            const [threatHistory, setThreatHistory] = useState([]);
            const [threatViewTab, setThreatViewTab] = useState('current');

            // UI states
            const [isChatOpen, setIsChatOpen] = useState(false);
            const [isChatMaximized, setIsChatMaximized] = useState(false);
            const [chatInput, setChatInput] = useState("");
            const [chatHistory, setChatHistory] = useState([{ role: 'bot', text: '您好！我是您的 SOC 智能助手。我可以協助您分析威脅、撰寫規則或生成劇本。' }]);
            const [chatLoading, setChatLoading] = useState(false);
            const chatEndRef = useRef(null);

            const [summaryModalOpen, setSummaryModalOpen] = useState(false);
            const [summaryContent, setSummaryContent] = useState('');
            const [summaryLoading, setSummaryLoading] = useState(false);

            const [visualizeModalOpen, setVisualizeModalOpen] = useState(false);
            const [selectedScenarioForVis, setSelectedScenarioForVis] = useState(null);
            const [visLoading, setVisLoading] = useState(false);

            // Analysis Options
            const [analysisType, setAnalysisType] = useState('ALL');
            const analysisOptions = [
                { id: 'ALL', label: '綜合交叉關聯分析' },
                { id: 'IDENTITY', label: '身分與存取威脅' },
                { id: 'NETWORK', label: '網路邊界與異常連線' },
                { id: 'ENDPOINT', label: '端點行為與惡意程式' },
                { id: 'SYSTEM', label: '防禦規避與系統健康' },
            ];

            const commonSystems = {
                "網路資安": ["Palo Alto Firewall", "CheckPoint FW", "Fortigate", "Cisco ASA"],
                "端點防護": ["CrowdStrike", "SentinelOne", "TrendMicro ApexOne"],
                "身分與系統": ["Windows AD", "Azure AD", "Linux RHEL", "vCenter"],
                "關鍵應用": ["SAP", "Oracle DB", "MES", "HRM System"]
            };

            // --- Effects & Sync ---
            useEffect(() => {
                const initAuth = async () => {
                    try {
                        if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) await signInWithCustomToken(auth, __initial_auth_token);
                        else await signInAnonymously(auth);
                    } catch (err) { setSyncStatus('error'); }
                };
                initAuth();
                const unsubscribe = onAuthStateChanged(auth, (u) => {
                    setUser(u);
                    if(u) setSyncStatus('synced');
                });
                return () => unsubscribe();
            }, []);

            useEffect(() => {
                if (!user) return;
                const unsubAssets = onSnapshot(doc(db, 'artifacts', appId, 'shared_data', 'assets'), (s) => s.exists() && setAssetList(s.data().items || []), (err) => handleSyncError(err));
                const unsubHistory = onSnapshot(doc(db, 'artifacts', appId, 'shared_data', 'threatHistory'), (s) => {
                    if (s.exists()) {
                        const items = s.data().items || [];
                        setThreatHistory(items);
                        if (items.length > 0 && !threatData) setThreatData(items[0]);
                    }
                    setSyncStatus('synced');
                }, (err) => handleSyncError(err));
                return () => { unsubAssets(); unsubHistory(); };
            }, [user]);

            const handleSyncError = (err) => { setSyncStatus('error'); setDbError(err.message); };
            const showToast = (msg, type = 'success') => { setToast({ message: msg, type }); setTimeout(() => setToast(null), 3000); };
            
            const saveToDB = async (collectionName, dataValue) => {
                if (!user) return;
                try {
                    await setDoc(doc(db, 'artifacts', appId, 'shared_data', collectionName), { items: dataValue });
                    setLastSaved(new Date().toLocaleTimeString());
                } catch (e) { showToast(e.message, 'error'); }
            };

            // --- AI API Helper ---
            const fetchGemini = async (prompt) => {
                const payload = { contents: [{ parts: [{ text: prompt }] }] };
                const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`, {
                    method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload)
                });
                const data = await response.json();
                if (data.error) throw new Error(data.error.message);
                return data.candidates?.[0]?.content?.parts?.[0]?.text;
            };

            // --- Handlers ---
            const handleAddAsset = () => {
                const newList = [...assetList, { id: Date.now(), category: "", name: "", note: "" }];
                setAssetList(newList); saveToDB('assets', newList);
            };
            const handleUpdateAsset = (id, f, v) => {
                const newList = assetList.map(a => a.id === id ? { ...a, [f]: v } : a);
                setAssetList(newList); saveToDB('assets', newList);
            };
            const handleDeleteAsset = (id) => {
                const newList = assetList.filter(a => a.id !== id);
                setAssetList(newList); saveToDB('assets', newList);
            };
            const handleQuickAdd = (e) => {
                const val = e.target.value; if (!val) return;
                const newList = [...assetList, { id: Date.now(), category: "系統", name: val, note: "" }];
                setAssetList(newList); saveToDB('assets', newList); e.target.value = "";
            };

            const handleGenerateAnalysis = async () => {
                if (!assetList.length) return;
                setThreatLoading(true); setThreatData(null); setThreatViewTab('current');
                const assetStr = assetList.map(a => `- [${a.category}] ${a.name}`).join('\n');
                const focus = analysisOptions.find(o => o.id === analysisType)?.label || "全方位";
                
                const prompt = `你是一位資深 SIEM 專家。針對資產：\n${assetStr}\n進行『${focus}』分析。請提供 5-8 個威脅情境。
                格式必須是 JSON 物件：{ "analysis_type": "${focus}", "scenarios": [ { "title", "category", "severity", "correlation_logic", "logs_required": [], "mermaid_code": "graph LR;...", "data_sources": [{"device", "event"}] } ] }。
                其中 mermaid_code 是描寫攻擊流程圖的代碼。請用繁體中文。`;

                try {
                    const raw = await fetchGemini(prompt);
                    const json = JSON.parse(raw.match(/\{[\s\S]*\}/)[0]);
                    const result = { ...json, timestamp: new Date().toLocaleString() };
                    setThreatData(result);
                    const newHist = [result, ...threatHistory];
                    setThreatHistory(newHist);
                    saveToDB('threatHistory', newHist);
                } catch (e) { showToast("分析失敗", "error"); } finally { setThreatLoading(false); }
            };

            // New: handle vis generation if missing
            const handleRegenerateVis = async () => {
                if (!selectedScenarioForVis) return;
                setVisLoading(true);
                const prompt = `針對此威脅情境：『${selectedScenarioForVis.title}』，產生一個 Mermaid 圖表代碼 (graph LR) 與 SIEM 數據源對照表。
                回傳格式 JSON: { "mermaid_code": "...", "data_sources": [{"device": "...", "event": "..."}] }`;
                try {
                    const raw = await fetchGemini(prompt);
                    const data = JSON.parse(raw.match(/\{[\s\S]*\}/)[0]);
                    const updatedScenario = { ...selectedScenarioForVis, ...data };
                    setSelectedScenarioForVis(updatedScenario);
                    // Also update in history
                    const newHist = threatHistory.map(h => ({
                        ...h,
                        scenarios: h.scenarios.map(s => s.title === updatedScenario.title ? updatedScenario : s)
                    }));
                    setThreatHistory(newHist);
                    saveToDB('threatHistory', newHist);
                } catch (e) { showToast("生成失敗", "error"); } finally { setVisLoading(false); }
            };

            const handleChatAction = async (userMsg, promptTask) => {
                setIsChatOpen(true);
                setChatHistory(prev => [...prev, { role: 'user', text: userMsg }]);
                setChatLoading(true);
                try {
                    const reply = await fetchGemini(promptTask);
                    setChatHistory(prev => [...prev, { role: 'bot', text: reply }]);
                } catch (e) { setChatHistory(prev => [...prev, { role: 'bot', text: "錯誤。" }]); } finally { setChatLoading(false); }
            };

            const aggregated = useMemo(() => {
                const stats = { Critical: [], High: [], Medium: [], Low: [] };
                threatHistory.forEach(h => h.scenarios?.forEach(s => stats[s.severity]?.push({ ...s, source_date: h.timestamp })));
                return stats;
            }, [threatHistory]);

            return (
                <div className="h-full flex flex-col bg-slate-50 font-sans relative overflow-hidden">
                    {/* Header */}
                    <header className="bg-slate-900 text-white p-4 flex justify-between items-center shadow-lg shrink-0 z-20">
                        <div className="flex items-center gap-3">
                            <div className="p-2 bg-indigo-600 rounded-lg"><Briefcase size={24}/></div>
                            <div>
                                <h1 className="text-xl font-bold tracking-tight">SIEM 威脅情境戰情室</h1>
                                <p className="text-slate-400 text-[10px]">Cloud Intelligence & Asset Risk Center</p>
                            </div>
                        </div>
                        <div className="flex items-center gap-4">
                             {syncStatus === 'synced' ? <span className="text-xs text-green-400 flex items-center gap-1 bg-green-400/10 px-2 py-1 rounded-full"><Check size={12}/> 已連線</span> : <span className="text-xs text-yellow-400 flex items-center gap-1"><Loader2 size={12} className="animate-spin"/> 同步中</span>}
                             <button onClick={() => setIsChatOpen(true)} className="p-2 hover:bg-slate-800 rounded-full transition-colors"><MessageSquare size={20}/></button>
                        </div>
                    </header>

                    {/* Navbar */}
                    <div className="bg-white border-b border-gray-200 px-6 flex gap-8 shrink-0 z-10">
                        <button onClick={()=>setActiveTab('assets')} className={`py-4 text-sm font-bold border-b-2 transition-colors ${activeTab==='assets'?'border-indigo-600 text-indigo-600':'border-transparent text-gray-400 hover:text-gray-600'}`}>資產分析</button>
                        <button onClick={()=>setActiveTab('history')} className={`py-4 text-sm font-bold border-b-2 transition-colors ${activeTab==='history'?'border-indigo-600 text-indigo-600':'border-transparent text-gray-400 hover:text-gray-600'}`}>歷史看板</button>
                    </div>

                    {/* Main Area */}
                    <div className="flex-1 overflow-hidden relative">
                        {activeTab === 'assets' && (
                            <div className="flex w-full h-full">
                                <div className="w-1/3 bg-gray-50 border-r border-gray-200 flex flex-col p-6 overflow-hidden">
                                    <div className="flex justify-between items-center mb-4">
                                        <h3 className="font-bold text-gray-700 flex items-center gap-2"><Server size={18} className="text-indigo-500"/> 資產清單</h3>
                                        <button onClick={handleAddAsset} className="text-xs bg-white border px-2 py-1 rounded shadow-sm hover:bg-gray-100 flex items-center gap-1"><Plus size={12}/> 新增</button>
                                    </div>
                                    <select className="w-full p-2 mb-4 border rounded bg-white text-sm outline-none" onChange={handleQuickAdd}>
                                        <option value="">快速加入系統...</option>
                                        {Object.entries(commonSystems).map(([k,v]) => <optgroup key={k} label={k}>{v.map(s => <option key={s} value={s}>{s}</option>)}</optgroup>)}
                                    </select>
                                    <div className="flex-1 overflow-y-auto mb-4 border rounded-xl bg-white shadow-inner">
                                        <table className="w-full text-left">
                                            <tbody className="text-xs divide-y">
                                                {assetList.map((a,i) => (
                                                    <tr key={a.id} className="group hover:bg-slate-50">
                                                        <td className="p-2"><input className="w-full bg-transparent outline-none font-bold" value={a.name} onChange={e=>handleUpdateAsset(a.id,'name',e.target.value)}/></td>
                                                        <td className="p-2"><button onClick={()=>handleDeleteAsset(a.id)} className="text-red-300 hover:text-red-500 opacity-0 group-hover:opacity-100"><Trash size={14}/></button></td>
                                                    </tr>
                                                ))}
                                            </tbody>
                                        </table>
                                    </div>
                                    <select className="w-full p-2 mb-4 border-2 border-indigo-100 rounded-lg text-sm bg-indigo-50 font-bold" value={analysisType} onChange={e=>setAnalysisType(e.target.value)}>
                                        {analysisOptions.map(o => <option key={o.id} value={o.id}>{o.label}</option>)}
                                    </select>
                                    <button onClick={handleGenerateAnalysis} disabled={threatLoading} className="w-full bg-indigo-600 text-white py-3 rounded-xl font-bold shadow-lg flex items-center justify-center gap-2 hover:bg-indigo-700 transition-all disabled:opacity-50">
                                        {threatLoading ? <Loader2 className="animate-spin"/> : <Activity size={18}/>} 開始關聯分析
                                    </button>
                                </div>
                                <div className="w-2/3 p-6 overflow-y-auto bg-white">
                                    {threatData ? (
                                        <div className="space-y-6 animate-in fade-in duration-500">
                                            <div className="flex justify-between items-center pb-2 border-b">
                                                <h2 className="text-xl font-black text-slate-800 flex items-center gap-2"><ShieldCheck className="text-green-500"/> {threatData.analysis_type} 分析報表</h2>
                                                <span className="text-xs text-slate-400">{threatData.timestamp}</span>
                                            </div>
                                            <div className="grid gap-4">
                                                {threatData.scenarios?.map((s,i) => (
                                                    <ScenarioCard 
                                                        key={i} 
                                                        scenario={s} 
                                                        onVisualize={handleVisualize}
                                                        onAskMitigation={(t) => handleChatAction(`請針對『${t}』情境提供緩解措施。`, `Role: Senior Analyst. Mitigation for: ${t}`)}
                                                        onAskRule={(t) => handleChatAction(`產生『${t}』的 SIEM 規則。`, `Role: Engineer. Rules for: ${t}`)}
                                                    />
                                                ))}
                                            </div>
                                        </div>
                                    ) : (
                                        <div className="h-full flex flex-col items-center justify-center text-slate-300 opacity-60">
                                            <BrainCircuit size={80} className="mb-4"/>
                                            <p className="font-bold text-lg">等待分析指令</p>
                                        </div>
                                    )}
                                </div>
                            </div>
                        )}

                        {activeTab === 'history' && (
                            <div className="flex-1 h-full overflow-y-auto bg-slate-50 p-8 pb-32">
                                <div className="max-w-6xl mx-auto space-y-8">
                                    <div className="flex justify-between items-end">
                                        <div><h2 className="text-2xl font-bold text-slate-800">全域威脅態勢看板</h2><p className="text-slate-400 text-sm">累積歷史情境分析統計</p></div>
                                        <div className="flex gap-2">
                                            <div className="bg-white px-4 py-2 rounded-xl shadow-sm border border-slate-200 font-bold text-slate-600">總威脅數: {Object.values(aggregated).flat().length}</div>
                                        </div>
                                    </div>
                                    <div className="grid grid-cols-4 gap-4">
                                        {['Critical', 'High', 'Medium', 'Low'].map(l => (
                                            <div key={l} className="bg-white p-4 rounded-2xl shadow-sm border-l-4 flex flex-col justify-center" style={{borderColor: l==='Critical'?'#be123c':l==='High'?'#ef4444':l==='Medium'?'#f59e0b':'#3b82f6'}}>
                                                <span className="text-[10px] font-black uppercase text-slate-400">{l} Risk</span>
                                                <span className="text-3xl font-black text-slate-800">{aggregated[l].length}</span>
                                            </div>
                                        ))}
                                    </div>
                                    <div className="grid grid-cols-2 gap-8">
                                        {['Critical', 'High'].map(l => (
                                            <div key={l} className="bg-white rounded-2xl shadow-sm border border-slate-200 overflow-hidden flex flex-col h-[600px]">
                                                <div className="p-4 border-b font-black text-slate-700 bg-slate-50 flex justify-between"><span>{l} Priority Tasks</span><span className="bg-indigo-600 text-white px-2 rounded-full text-xs">{aggregated[l].length}</span></div>
                                                <div className="p-4 overflow-y-auto flex-1 space-y-2">
                                                    {aggregated[l].map((s,i) => <ScenarioCard key={i} scenario={s} onVisualize={handleVisualize} onAskMitigation={handleAskMitigation} onAskRule={handleAskRule}/>)}
                                                </div>
                                            </div>
                                        ))}
                                    </div>
                                </div>
                            </div>
                        )}
                    </div>

                    {/* Chat Modal - ENLARGED */}
                    {isChatOpen && (
                        <div className={`fixed bottom-6 right-6 ${isChatMaximized ? 'inset-6 w-auto h-auto' : 'w-[550px] h-[750px]'} bg-white rounded-3xl shadow-2xl flex flex-col border border-slate-200 z-[100] transition-all animate-in slide-in-from-bottom-5 duration-300 overflow-hidden`}>
                            <div className="bg-slate-900 text-white p-5 flex justify-between items-center shrink-0">
                                <div className="flex items-center gap-3">
                                    <div className="p-2 bg-indigo-500 rounded-xl"><Sparkles size={20}/></div>
                                    <h3 className="font-bold">SOC Copilot 智能助手</h3>
                                </div>
                                <div className="flex gap-2">
                                    <button onClick={()=>setIsChatMaximized(!isChatMaximized)} className="p-1 hover:bg-slate-800 rounded">{isChatMaximized ? <Minimize2 size={18}/> : <Maximize2 size={18}/>}</button>
                                    <button onClick={()=>setIsChatOpen(false)} className="p-1 hover:bg-slate-800 rounded"><X size={18}/></button>
                                </div>
                            </div>
                            <div className="flex-1 overflow-y-auto p-6 space-y-6 bg-slate-50 chat-scroll">
                                {chatHistory.map((m, i) => (
                                    <div key={i} className={`flex ${m.role === 'user' ? 'justify-end' : 'justify-start'}`}>
                                        <div className={`max-w-[90%] p-4 rounded-2xl shadow-sm leading-relaxed ${m.role === 'user' ? 'bg-indigo-600 text-white rounded-tr-none' : 'bg-white text-slate-700 border border-slate-200 rounded-tl-none'}`}>
                                            {m.role === 'bot' ? <RenderMarkdown text={m.text}/> : <p className="text-sm">{m.text}</p>}
                                        </div>
                                    </div>
                                ))}
                                <div ref={chatEndRef}/>
                            </div>
                            <form onSubmit={handleChatSubmit} className="p-4 border-t bg-white flex gap-3">
                                <input className="flex-1 p-3 border border-slate-200 rounded-2xl text-sm outline-none focus:border-indigo-500 focus:ring-2 focus:ring-indigo-100" placeholder="詢問關於威脅、Log 或防禦建議..." value={chatInput} onChange={e=>setChatInput(e.target.value)} disabled={chatLoading}/>
                                <button type="submit" className="bg-indigo-600 text-white p-3 rounded-2xl hover:bg-indigo-700 disabled:opacity-50 transition-colors shadow-md">
                                    {chatLoading ? <Loader2 size={20} className="animate-spin"/> : <Send size={20}/>}
                                </button>
                            </form>
                        </div>
                    )}

                    {/* Visualize Modal */}
                    {visualizeModalOpen && selectedScenarioForVis && (
                        <div className="fixed inset-0 bg-slate-900/80 backdrop-blur-sm z-[110] flex items-center justify-center p-8 animate-in fade-in duration-300">
                            <div className="bg-white rounded-3xl w-full max-w-6xl h-[85vh] flex flex-col shadow-2xl overflow-hidden">
                                <div className="bg-slate-900 text-white p-5 flex justify-between items-center">
                                    <div>
                                        <h3 className="font-bold text-lg flex items-center gap-2"><Eye className="text-indigo-400"/> 攻擊流程視覺化分析</h3>
                                        <p className="text-xs text-slate-400 mt-1">{selectedScenarioForVis.title}</p>
                                    </div>
                                    <button onClick={()=>setVisualizeModalOpen(false)} className="p-2 hover:bg-slate-800 rounded-full"><X size={24}/></button>
                                </div>
                                <div className="flex-1 flex overflow-hidden">
                                    <div className="w-2/3 p-8 bg-slate-50 flex flex-col overflow-y-auto border-r">
                                        <div className="flex justify-between items-center mb-6">
                                            <h4 className="font-bold text-slate-600 uppercase tracking-widest text-xs flex items-center gap-2"><Waypoints size={16}/> 攻擊路徑圖 (Attack Flow)</h4>
                                            {!selectedScenarioForVis.mermaid_code && (
                                                <button onClick={handleRegenerateVis} disabled={visLoading} className="text-xs bg-indigo-600 text-white px-4 py-2 rounded-lg font-bold hover:bg-indigo-700 flex items-center gap-2 shadow-md disabled:opacity-50">
                                                    {visLoading ? <Loader2 size={14} className="animate-spin"/> : <Sparkles size={14}/>} ✨ AI 生成路徑圖
                                                </button>
                                            )}
                                        </div>
                                        <div className="flex-1 bg-white rounded-2xl border-2 border-slate-100 shadow-sm p-6 flex items-center justify-center min-h-[500px]">
                                            {selectedScenarioForVis.mermaid_code ? (
                                                <AttackGraph mermaidCode={selectedScenarioForVis.mermaid_code} />
                                            ) : (
                                                <div className="text-center text-slate-400">
                                                    <Waypoints size={64} className="mx-auto mb-4 opacity-20"/>
                                                    <p>目前沒有流程數據，點擊上方按鈕生成</p>
                                                </div>
                                            )}
                                        </div>
                                    </div>
                                    <div className="w-1/3 p-8 overflow-y-auto bg-white">
                                        <h4 className="font-bold text-slate-600 uppercase tracking-widest text-xs mb-6 flex items-center gap-2"><Database size={16}/> SIEM 數據監測對照表</h4>
                                        <div className="space-y-4">
                                            {selectedScenarioForVis.data_sources?.map((ds, idx) => (
                                                <div key={idx} className="p-4 border border-indigo-50 rounded-2xl bg-indigo-50/30 hover:bg-indigo-50 transition-colors group">
                                                    <div className="flex justify-between mb-2">
                                                        <span className="text-[10px] font-black text-indigo-500 uppercase">Device Type</span>
                                                        <span className="text-[10px] text-slate-400 font-bold">STEP {idx+1}</span>
                                                    </div>
                                                    <div className="font-bold text-slate-800 text-sm mb-3 group-hover:text-indigo-700">{ds.device}</div>
                                                    <div className="text-xs font-mono bg-white p-3 rounded-xl border border-indigo-100 text-indigo-900 shadow-inner">
                                                        {ds.event}
                                                    </div>
                                                </div>
                                            ))}
                                            {(!selectedScenarioForVis.data_sources || selectedScenarioForVis.data_sources.length === 0) && (
                                                <div className="py-20 text-center text-slate-300">
                                                    <Loader2 size={32} className="mx-auto mb-4 opacity-20"/>
                                                    <p className="text-xs italic">等待數據對照生成...</p>
                                                </div>
                                            )}
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    )}

                    {/* Toast Notification */}
                    {toast && (
                        <div className={`fixed bottom-8 left-1/2 -translate-x-1/2 px-6 py-3 rounded-full text-white text-sm font-bold shadow-2xl animate-fade-in-up z-[200] flex items-center gap-2 ${toast.type==='error'?'bg-red-500':'bg-emerald-600'}`}>
                            {toast.type==='success' ? <CheckCircle size={18}/> : <AlertTriangle size={18}/>}
                            {toast.message}
                        </div>
                    )}
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(React.createElement(WarRoom));
    </script>
</body>
</html>