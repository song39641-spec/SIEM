<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SIEM è³‡ç”¢èˆ‡å¨è„…æˆ°æƒ…å®¤</title>
    
    <!-- 1. å¼•å…¥ Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- 2. å¼•å…¥ Babel -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/babel-standalone/7.23.6/babel.min.js"></script>

    <!-- 3. è¨­å®š Tailwind ä¸»é¡Œ -->
    <script>
      tailwind.config = {
        theme: {
          extend: {
            colors: {
              slate: { 850: '#1e293b' }
            }
          }
        }
      }
    </script>

    <!-- 4. è¨­å®š Import Map -->
    <script type="importmap">
      {
        "imports": {
          "react": "https://esm.sh/react@18.2.0",
          "react-dom/client": "https://esm.sh/react-dom@18.2.0/client",
          "lucide-react": "https://esm.sh/lucide-react@0.292.0"
        }
      }
    </script>
    <style>
        /* å¼·åˆ¶æ²è»¸æ¨£å¼ï¼Œç¢ºä¿å¯è¦‹ */
        ::-webkit-scrollbar { width: 8px; height: 8px; }
        ::-webkit-scrollbar-track { background: #f1f5f9; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #94a3b8; }
    </style>
</head>
<body class="bg-gray-100 text-slate-800 h-screen w-screen overflow-hidden flex flex-col">
    
    <div id="root" class="flex-1 flex flex-col overflow-hidden"></div>

    <!-- 5. ä¸»ç¨‹å¼é‚è¼¯ -->
    <script type="text/babel" data-type="module" data-presets="react">
        import React, { useState, useRef, useEffect, useMemo } from 'react';
        import ReactDOM from 'react-dom/client';
        import * as LucideIcons from 'lucide-react';
        
        // Firebase SDK
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, onSnapshot, collection } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        // --- Helper Components & Functions ---

        // SafeText Component
        const SafeText = ({ content }) => {
            if (content === null || content === undefined) return null;
            try {
                if (typeof content === 'string' || typeof content === 'number') return <>{content}</>;
                if (typeof content === 'boolean') return <>{String(content)}</>;
                if (Array.isArray(content)) {
                    return <>{content.map(c => (typeof c === 'object' ? JSON.stringify(c) : String(c))).join(', ')}</>;
                }
                if (typeof content === 'object') {
                    if (content.seconds) return <>{new Date(content.seconds * 1000).toLocaleString()}</>;
                    return <>{JSON.stringify(content)}</>;
                }
                return <>{String(content)}</>;
            } catch (e) {
                return <>Data Error</>;
            }
        };

        const renderIcon = (iconName, size = 20, className = "") => {
            const I = LucideIcons[iconName] || LucideIcons.FileText;
            return <I size={size} className={className} />;
        };

        const getTasksByQuarter = (tasks, qStart, qEnd) => {
            if (!Array.isArray(tasks)) return [];
            return tasks.filter(t => t.startMonth >= qStart && t.startMonth <= qEnd).sort((a,b) => a.startMonth - b.startMonth);
        };

        const getResultContent = (txt, mode) => {
            if (!txt) return '';
            const parts = txt.split('---SPLIT---');
            if (parts.length < 2) return txt;
            if (mode === 'guide') return parts[1].trim();
            return parts[0].trim();
        };
        
        const renderMarkdown = (text) => {
            if (!text || typeof text !== 'string') return null;
            const lines = text.split('\n');
            const elements = [];
            let tableRows = [];
            
            const flushTable = (idx) => {
                if (tableRows.length === 0) return null;
                const dataRows = tableRows.filter(row => !/^[|\s-:]+$/.test(row) && row.includes('|'));
                if (dataRows.length === 0) return null;
                
                const parseRow = (rowStr) => rowStr.split('|').filter(c => c.trim() !== '').map(c => c.trim());
                const headers = parseRow(dataRows[0]);
                const bodyRows = dataRows.slice(1);
                
                return (
                    <div key={`table-${idx}`} className="overflow-x-auto my-4 border border-gray-200 rounded-lg shadow-sm">
                        <table className="min-w-full divide-y divide-gray-200 text-sm">
                            <thead className="bg-slate-50">
                                <tr>{headers.map((h, i) => <th key={i} className="px-4 py-2 text-left text-xs font-bold text-slate-700 border-r last:border-r-0 whitespace-nowrap">{h}</th>)}</tr>
                            </thead>
                            <tbody className="bg-white divide-y">
                                {bodyRows.map((r, i) => <tr key={i} className="hover:bg-slate-50">{parseRow(r).map((c, j) => <td key={j} className="px-4 py-2 border-r last:border-r-0">{c}</td>)}</tr>)}
                            </tbody>
                        </table>
                    </div>
                );
            };

            for (let i = 0; i < lines.length; i++) {
                const line = lines[i].trim();
                if (line.startsWith('|')) {
                    tableRows.push(line);
                } else {
                    if (tableRows.length > 0) { elements.push(flushTable(i)); tableRows = []; }
                    if (line.startsWith('###')) {
                        const title = line.replace(/#/g, '');
                        elements.push(<h3 key={i} className="font-bold text-slate-800 mt-4 border-l-4 border-indigo-500 pl-2 text-lg">{title}</h3>);
                    } else if (line.length > 0) {
                        elements.push(<p key={i} className="text-sm text-slate-600 mb-1 leading-relaxed">{line}</p>);
                    }
                }
            }
            if (tableRows.length > 0) elements.push(flushTable('end'));
            return elements;
        };

        const ScenarioCard = ({ scenario }) => {
            if (!scenario) return null;
            let severityClass = 'bg-blue-50 text-blue-600 border-blue-200';
            if(scenario.severity==='Critical') severityClass = 'bg-rose-900 text-white border-rose-900';
            else if(scenario.severity==='High') severityClass = 'bg-red-50 text-red-600 border-red-200';
            else if(scenario.severity==='Medium') severityClass = 'bg-yellow-50 text-yellow-600 border-yellow-200';
            
            const logs = Array.isArray(scenario.logs_required) 
                ? scenario.logs_required 
                : typeof scenario.logs_required === 'string' 
                    ? [scenario.logs_required] 
                    : [];

            return (
                <div className="border border-slate-200 rounded-lg p-4 bg-white hover:shadow-md transition-shadow mb-3 text-sm group">
                    <div className="flex justify-between items-start mb-2">
                        <div className="w-full">
                            <div className="flex items-center gap-2 flex-wrap mb-1">
                                <span className={`text-xs px-2 py-0.5 rounded border font-bold ${severityClass}`}><SafeText content={scenario.severity}/></span>
                                <span className="font-bold text-slate-800 text-base"><SafeText content={scenario.title}/></span>
                            </div>
                            <div className="flex justify-between items-center text-xs text-slate-400 mt-1">
                                <span><SafeText content={scenario.source_date}/></span>
                                <span className="bg-slate-100 px-2 py-0.5 rounded text-slate-600 font-medium"><SafeText content={scenario.category}/></span>
                            </div>
                        </div>
                    </div>
                    <div className="bg-slate-50 p-3 rounded-lg text-xs text-slate-700 mt-2 border border-slate-100">
                        <div className="mb-2"><strong>é—œè¯é‚è¼¯:</strong> <SafeText content={scenario.correlation_logic} /></div>
                        <div className="flex flex-wrap gap-1">
                            {logs.map((l, i) => (
                                <span key={i} className="bg-white border border-slate-200 px-2 py-0.5 rounded text-slate-500 font-mono"><SafeText content={l} /></span>
                            ))}
                        </div>
                    </div>
                </div>
            );
        };

        // --- Main Component ---
        const WarRoom = () => {
            const { 
                Briefcase, Server, ShieldCheck, Target, Activity, Loader2, BrainCircuit, 
                Cloud, CloudOff, Check, Plus, Trash, ArrowUp, ArrowDown, Settings, 
                ListChecks, BarChart3, Wrench, Download, LayoutGrid, ScrollText, Wand2,
                LayoutDashboard, GanttChartSquare, History, AlertOctagon, AlertTriangle, Info,
                FileText, CheckCircle, Rocket, Mail, MessageCircleQuestion, FilePenLine, FileCode, FileSpreadsheet,
                Fingerprint, Network, Laptop, Lock, Save 
            } = LucideIcons;

            // --- API Key Protection ---
            const _p1 = "AIzaSyBILGldyB";
            const _p2 = "CUqYZ_Ay87f49K";
            const _p3 = "nlBs4-dvx8I";
            const apiKey = _p1 + _p2 + _p3;
            
            // Firebase Config
            const getFirebaseConfig = () => {
                if (typeof __firebase_config !== 'undefined') {
                    return JSON.parse(__firebase_config);
                } else {
                    return {
                        apiKey: "AIzaSyA98h3qS1RWeWuSKTWZmMmYsUG-cZl8YwE",
                        authDomain: "siem-6dc7e.firebaseapp.com",
                        projectId: "siem-6dc7e",
                        storageBucket: "siem-6dc7e.firebasestorage.app",
                        messagingSenderId: "285198821105",
                        appId: "1:285198821105:web:17fc91f4e8567a2bdc2b50",
                        measurementId: "G-P1SMMD2Y2X"
                    };
                }
            };
            
            const app = initializeApp(getFirebaseConfig());
            const auth = getAuth(app);
            const db = getFirestore(app);
            const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-siem-app';

            // --- States ---
            const [user, setUser] = useState(null);
            const [syncStatus, setSyncStatus] = useState('connecting');
            const [activeTab, setActiveTab] = useState('assets'); 
            const [lastSaved, setLastSaved] = useState(null);
            const [dbError, setDbError] = useState('');
            const [toast, setToast] = useState(null);
            const [showRulesModal, setShowRulesModal] = useState(false);

            // Data States
            const [assetList, setAssetList] = useState([]);
            const [threatData, setThreatData] = useState(null);
            const [threatLoading, setThreatLoading] = useState(false);
            const [threatHistory, setThreatHistory] = useState([]);
            const [threatViewTab, setThreatViewTab] = useState('current');

            const [playbookResult, setPlaybookResult] = useState('');
            const [playbookLoading, setPlaybookLoading] = useState(false);
            const [playbookHistory, setPlaybookHistory] = useState([]);
            const [systemInput, setSystemInput] = useState('');
            
            const [chartData, setChartData] = useState(null);
            const [chartLoading, setChartLoading] = useState(false);
            const [resultViewMode, setResultViewMode] = useState('text');

            const [aiSuggestingAssets, setAiSuggestingAssets] = useState(false);
            const [analysisType, setAnalysisType] = useState('ALL');

            // Constant Common Systems Data
            const commonSystems = {
                "ç¶²è·¯èˆ‡è³‡å®‰è¨­å‚™": ["Palo Alto Firewall", "CheckPoint Firewall", "Cisco Switch", "Cisco ASA VPN"],
                "ç«¯é»é˜²è­· (EDR)": ["CrowdStrike", "TrendMicro Apex One", "TeamT5 EDR", "WorkspaceOne MDM"],
                "èº«åˆ†é©—è­‰èˆ‡ä½œæ¥­ç³»çµ±": ["WindowsAD", "WindowsServer", "Linux RHEL"],
                "æ‡‰ç”¨ç³»çµ± (Applications)": ["SAP", "MES", "HRM", "PLM", "ELN", "GEM", "RMS"],
                "è³‡æ–™åº« (Database)": ["Oracle", "MSSQL"],
                "æ ¸å¿ƒè™›æ“¬æ¶æ§‹ (Infra)": ["Esxi Host", "Pure Storage", "RDP é ç«¯è·³æ¿ä¸»æ©Ÿ"]
            };
            
            const assetCategories = Object.keys(commonSystems);
            const analysisOptions = [
                { id: 'ALL', label: 'ç¶œåˆäº¤å‰é—œè¯åˆ†æ' },
                { id: 'IDENTITY', label: 'èº«åˆ†èˆ‡å­˜å–å¨è„…' },
                { id: 'NETWORK', label: 'ç¶²è·¯é‚Šç•Œèˆ‡ç•°å¸¸é€£ç·š' },
                { id: 'ENDPOINT', label: 'ç«¯é»è¡Œç‚ºèˆ‡æƒ¡æ„ç¨‹å¼' },
                { id: 'SYSTEM', label: 'é˜²ç¦¦è¦é¿èˆ‡ç³»çµ±å¥åº·' },
            ];

            // --- Auth & Data Sync ---
            useEffect(() => {
                const initAuth = async () => {
                    try {
                        if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                             await signInWithCustomToken(auth, __initial_auth_token);
                        } else {
                             await signInAnonymously(auth);
                        }
                    } catch (err) {
                        console.error("Auth failed:", err);
                        setSyncStatus('error');
                        setDbError(err.message);
                    }
                };
                initAuth();
                const unsubscribe = onAuthStateChanged(auth, (u) => {
                    setUser(u);
                    if(u) setSyncStatus('synced');
                    else setSyncStatus('connecting');
                });
                return () => unsubscribe();
            }, []);

            // Data Sync
            useEffect(() => {
                if (!user) return;
                setSyncStatus('connecting');
                
                // Sync Assets
                const assetsQuery = doc(db, 'artifacts', appId, 'shared_data', 'assets');
                const unsubAssets = onSnapshot(assetsQuery, (docSnapshot) => {
                    if (docSnapshot.exists()) {
                        const data = docSnapshot.data();
                        if (data.items && Array.isArray(data.items)) setAssetList(data.items);
                    }
                }, (err) => {
                    handleSyncError(err);
                });

                // Sync Threat History
                const historyQuery = doc(db, 'artifacts', appId, 'shared_data', 'threatHistory');
                const unsubHistory = onSnapshot(historyQuery, (docSnapshot) => {
                    if (docSnapshot.exists()) {
                        const data = docSnapshot.data();
                        if (data.items && Array.isArray(data.items)) {
                             setThreatHistory(data.items);
                             if (data.items.length > 0 && !threatData) {
                                 setThreatData(data.items[0]);
                             }
                        }
                    }
                }, (err) => {
                    handleSyncError(err);
                });

                // Sync Playbook History
                const playbookQuery = doc(db, 'artifacts', appId, 'shared_data', 'playbookHistory');
                const unsubPlaybook = onSnapshot(playbookQuery, (docSnapshot) => {
                    if (docSnapshot.exists()) {
                        const data = docSnapshot.data();
                        if (data.items && Array.isArray(data.items)) {
                             setPlaybookHistory(data.items);
                        }
                    }
                     setSyncStatus('synced');
                }, (err) => {
                    handleSyncError(err);
                });

                return () => { unsubAssets(); unsubHistory(); unsubPlaybook(); };
            }, [user]);

            const handleSyncError = (err) => {
                console.error("Sync Error:", err);
                setDbError(err.message);
                setSyncStatus('error');
                if (err.code === 'permission-denied' || err.message.includes('permission')) {
                    setShowRulesModal(true);
                }
            };

            const showToast = (msg, type = 'success') => {
                setToast({ message: msg, type });
                setTimeout(() => setToast(null), 3000);
            };

            const saveToDB = async (collectionName, dataValue) => {
                if (!user) {
                    setDbError("å°šæœªç™»å…¥ï¼Œç„¡æ³•å¯«å…¥");
                    return;
                }
                setSyncStatus('connecting');
                try {
                    await setDoc(doc(db, 'artifacts', appId, 'shared_data', collectionName), { items: dataValue });
                    setSyncStatus('synced');
                    setLastSaved(new Date().toLocaleTimeString());
                    setDbError(''); 
                    if (collectionName !== 'assets') showToast('å„²å­˜æˆåŠŸ');
                } catch (e) {
                    console.error("Save error:", e);
                    setSyncStatus('error');
                    setDbError(e.message);
                    showToast('å„²å­˜å¤±æ•—: ' + e.message, 'error');
                    if (e.code === 'permission-denied' || e.message.includes('permission')) {
                        setShowRulesModal(true);
                    }
                }
            };

            const saveAssetsToDB = (newAssets) => saveToDB('assets', newAssets);
            const saveHistoryToDB = (newHistory) => saveToDB('threatHistory', newHistory);
            const savePlaybookToDB = (newHistory) => saveToDB('playbookHistory', newHistory);

            // --- Handlers ---
            const handleAddAssetRow = () => { const newId = Math.max(0, ...assetList.map(a => a.id)) + 1; const newList = [...assetList, { id: newId, category: "", name: "", note: "" }]; setAssetList(newList); saveAssetsToDB(newList); };
            const handleDeleteAssetRow = (id) => { const newList = assetList.filter(a => a.id !== id); setAssetList(newList); saveAssetsToDB(newList); };
            const handleUpdateAssetRow = (id, field, value) => { const newList = assetList.map(a => a.id === id ? { ...a, [field]: value } : a); setAssetList(newList); saveAssetsToDB(newList); };
            const handleMoveAssetRow = (index, direction) => { const newList = [...assetList]; if (direction === 'up' && index > 0) { [newList[index], newList[index - 1]] = [newList[index - 1], newList[index]]; } else if (direction === 'down' && index < newList.length - 1) { [newList[index], newList[index + 1]] = [newList[index + 1], newList[index]]; } setAssetList(newList); saveAssetsToDB(newList); };
            const handleQuickAddAsset = (e) => { const value = e.target.value; if (!value) return; const newId = Math.max(0, ...assetList.map(a => a.id)) + 1; let category = "å…¶ä»–"; for (const [cat, items] of Object.entries(commonSystems)) { if (items.includes(value)) { category = cat; break; } } const newList = [...assetList, { id: newId, category: category, name: value, note: "" }]; setAssetList(newList); saveAssetsToDB(newList); e.target.value = ""; };
            const getResultContent = (txt, mode) => { if(!txt) return ''; const p=txt.split('---SPLIT---'); return (mode==='guide' && p[1]) ? p[1].trim() : p[0].trim(); };

            const fetchGeminiResponse = async (prompt) => {
                try {
                const payload = { contents: [{ parts: [{ text: prompt }] }] };
                const response = await fetch(
                    `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`,
                    { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) }
                );
                const data = await response.json();
                if (data.error) throw new Error(data.error.message);
                return data.candidates?.[0]?.content?.parts?.[0]?.text || "ç„¡æ³•å–å¾—å›æ‡‰ã€‚";
                } catch (error) { console.error("Gemini API Error:", error); throw error; }
            };

            const handleAiSuggestAssets = async () => {
                setAiSuggestingAssets(true);
                // Clear existing first for AI
                const categoriesStr = JSON.stringify(commonSystems);
                const prompt = `è³‡æ·± IT æ¶æ§‹å¸«ã€‚å¾å¸¸è¦‹ç³»çµ±æ¸…å–®æŒ‘é¸ 6-10 å€‹ SIEM é—œéµè³‡ç”¢ã€‚\n${categoriesStr}\nJSON Array: [{ "category", "name", "note" }]`;
                try { const rawText = await fetchGeminiResponse(prompt); const jsonStartIndex = rawText.indexOf('['); const jsonEndIndex = rawText.lastIndexOf(']'); if (jsonStartIndex !== -1 && jsonEndIndex !== -1) { const suggestions = JSON.parse(rawText.substring(jsonStartIndex, jsonEndIndex + 1)); 
                    const startId = 1;
                    const newAssets = suggestions.map((s, i) => ({ id: startId + i, category: s.category, name: s.name, note: s.note })); 
                    setAssetList(newAssets); 
                    saveAssetsToDB(newAssets); 
                    showToast('AI æ¨è–¦è³‡ç”¢å·²å¥—ç”¨');
                } } catch (e) { console.error(e); showToast('AI ç™¼ç”ŸéŒ¯èª¤', 'error'); } finally { setAiSuggestingAssets(false); }
            };

            const handleGenerateThreatAnalysis = async () => {
                if (assetList.filter(a => a.name.trim() !== "").length === 0) return;
                setThreatLoading(true); setThreatData(null); setThreatViewTab('current'); 
                const assetString = assetList.filter(a => a.name.trim() !== "").map(a => `- [${a.category}] ${a.name} (${a.note})`).join('\n');
                const selectedOption = analysisOptions.find(o => o.id === analysisType);
                const analysisLabel = selectedOption ? selectedOption.label : "ç¶œåˆäº¤å‰é—œè¯åˆ†æ";
                let contextPrompt = analysisType === 'ALL' ? "å…¨æ–¹ä½äº¤å‰é—œè¯å¨è„…åˆ†æ" : `å°ˆæ³¨æ–¼ã€Œ${analysisLabel}ã€é ˜åŸŸé€²è¡Œæ·±åº¦åˆ†æã€‚å¿½ç•¥ä¸ç›¸é—œçš„å¨è„…ã€‚`;

                const prompt = `
                ä½ æ˜¯ä¸€ä½è³‡æ·± SIEM èˆ‡ SOC æ¶æ§‹å¸«ã€‚è«‹æ ¹æ“šä»¥ä¸‹å®¢æˆ¶çš„è³‡ç”¢æ¸…å–®ï¼Œé€²è¡Œï¼š${contextPrompt}
                è³‡ç”¢æ¸…å–®ï¼š${assetString}
                ä»»å‹™ï¼š
                1. æ‰¾å‡ºå¯èƒ½ç™¼ç”Ÿçš„æ”»æ“Šè·¯å¾‘ã€‚
                2. å»ºè­°æ”¶é›†çš„ Log èˆ‡é—œè¯è¦å‰‡ã€‚
                3. ç”¢å‡º 5 åˆ° 10 å€‹å…·é«”çš„æƒ…å¢ƒã€‚
                4. Risk Level è«‹åŒ…å« "Critical", "High", "Medium", "Low" å››ç¨®ã€‚
                5. è«‹å‹™å¿…å°‡æ¯å€‹æƒ…å¢ƒåš´æ ¼æ­¸é¡åˆ°ä»¥ä¸‹å››é¡ä¹‹ä¸€ (Category)ï¼š
                   - èº«åˆ†èˆ‡å­˜å–å¨è„…
                   - ç¶²è·¯é‚Šç•Œèˆ‡ç•°å¸¸é€£ç·š
                   - ç«¯é»è¡Œç‚ºèˆ‡æƒ¡æ„ç¨‹å¼
                   - é˜²ç¦¦è¦é¿èˆ‡ç³»çµ±å¥åº·

                è«‹ä»¥ JSON æ ¼å¼å›å‚³ï¼Œçµæ§‹å¦‚ä¸‹ï¼š
                {
                    "analysis_type": "${analysisLabel}",
                    "scenarios": [
                    {
                        "title": "æƒ…å¢ƒæ¨™é¡Œ",
                        "category": "ä¸Šè¿°å››é¡ä¹‹ä¸€",
                        "severity": "Critical" | "High" | "Medium" | "Low",
                        "mitre_tactic": "MITRE Tactic",
                        "related_assets": ["è³‡ç”¢A"],
                        "logs_required": ["Log A"],
                        "correlation_logic": "é‚è¼¯èªªæ˜"
                    }
                    ],
                    "admin_log_guide": [
                    {
                        "system": "ç³»çµ±åç¨±",
                        "log_items": "éœ€æ”¶é›†çš„é …ç›®",
                        "config_advice": "è¨­å®šå»ºè­°"
                    }
                    ]
                }
                JSON å…§å®¹è«‹ç”¨ç¹é«”ä¸­æ–‡ã€‚
                `;

                try { const rawText = await fetchGeminiResponse(prompt); const jsonStartIndex = rawText.indexOf('{'); const jsonEndIndex = rawText.lastIndexOf('}'); if (jsonStartIndex !== -1 && jsonEndIndex !== -1) { const result = JSON.parse(rawText.substring(jsonStartIndex, jsonEndIndex + 1)); const finalResult = { ...result, timestamp: new Date().toLocaleString() }; setThreatData(finalResult); const newHistory = [finalResult, ...threatHistory]; setThreatHistory(newHistory); saveHistoryToDB(newHistory); } else { throw new Error("ç„¡æ³•è§£æå›æ‡‰è³‡æ–™"); } } catch (e) { console.error(e); showToast('AI åˆ†æå¤±æ•—', 'error'); } finally { setThreatLoading(false); }
            };

            const aggregatedHistory = useMemo(() => {
                const stats = { byRisk: { Critical: [], High: [], Medium: [], Low: [] }, byCategory: { 'èº«åˆ†èˆ‡å­˜å–å¨è„…': [], 'ç¶²è·¯é‚Šç•Œèˆ‡ç•°å¸¸é€£ç·š': [], 'ç«¯é»è¡Œç‚ºèˆ‡æƒ¡æ„ç¨‹å¼': [], 'é˜²ç¦¦è¦é¿èˆ‡ç³»çµ±å¥åº·': [] } };
                threatHistory.forEach(record => {
                    record.scenarios?.forEach(scenario => {
                        if (stats.byRisk[scenario.severity]) { stats.byRisk[scenario.severity].push({ ...scenario, source_date: record.timestamp, source_type: record.analysis_type }); } 
                        else if (scenario.severity === 'Critical') { stats.byRisk.Critical.push({ ...scenario, source_date: record.timestamp, source_type: record.analysis_type }); }
                        let cat = String(scenario.category || "");
                        if (!stats.byCategory[cat]) { 
                            if (cat.includes('èº«åˆ†') || cat.includes('å­˜å–')) cat = 'èº«åˆ†èˆ‡å­˜å–å¨è„…'; 
                            else if (cat.includes('ç¶²è·¯') || cat.includes('é€£ç·š')) cat = 'ç¶²è·¯é‚Šç•Œèˆ‡ç•°å¸¸é€£ç·š'; 
                            else if (cat.includes('ç«¯é»') || cat.includes('æƒ¡æ„')) cat = 'ç«¯é»è¡Œç‚ºèˆ‡æƒ¡æ„ç¨‹å¼'; 
                            else if (cat.includes('ç³»çµ±') || cat.includes('è¦é¿')) cat = 'é˜²ç¦¦è¦é¿èˆ‡ç³»çµ±å¥åº·'; 
                            else cat = 'é˜²ç¦¦è¦é¿èˆ‡ç³»çµ±å¥åº·'; 
                        }
                        if (stats.byCategory[cat]) { stats.byCategory[cat].push({ ...scenario, source_date: record.timestamp, source_type: record.analysis_type }); }
                    });
                });
                return stats;
            }, [threatHistory]);

            const handleGeneratePlaybook = async () => {
                let inputToUse = systemInput; if (!inputToUse.trim() && assetList.length > 0) inputToUse = assetList.map(a => a.name).join(', ');
                if (!inputToUse.trim()) return;
                setPlaybookLoading(true); setPlaybookResult(''); setResultViewMode('text'); setChartData(null);
                const prompt = `SIEM æ¶æ§‹å¸«ã€‚ç’°å¢ƒï¼š${inputToUse}ã€‚è¼¸å‡ºå…©éƒ¨åˆ†(---SPLIT---)ï¼š1.ç­–ç•¥è¦åŠƒ(è¡¨æ ¼), 2.æŠ€è¡“å¯¦ä½œ(è¡¨æ ¼)ã€‚ç¹é«”ä¸­æ–‡ã€‚`;
                try { const text = await fetchGeminiResponse(prompt); setPlaybookResult(text); 
                      const newEntry = {id: Date.now(), timestamp: new Date().toLocaleString(), input: inputToUse, content: text};
                      const newHistory = [newEntry, ...playbookHistory];
                      setPlaybookHistory(newHistory); savePlaybookToDB(newHistory);
                } catch (error) { setPlaybookResult("å¤±æ•—: " + error.message); } finally { setPlaybookLoading(false); }
            };

            const handleGenerateChart = async (textContent) => {
                if (!textContent) return; setResultViewMode('chart'); if (chartData) return; setChartLoading(true);
                const prompt = `åˆ†æ SIEM æŒ‡æ¨™ï¼š${textContent.split('---SPLIT---')[0]}ã€‚å›å‚³ç´” JSONï¼š{"priority_stats":{}, "source_stats":{}, "category_stats":{}}`;
                try { const raw = await fetchGeminiResponse(prompt); const jsonStr = raw.substring(raw.indexOf('{'), raw.lastIndexOf('}') + 1); setChartData(JSON.parse(jsonStr)); } catch (e) { setChartData({priority_stats:{"Error":1}, source_stats:{}, category_stats:{}}); } finally { setChartLoading(false); }
            };

            const handleExportTxt = (content) => {
                 const element = document.createElement("a");
                 const file = new Blob([content], {type: 'text/plain'});
                 element.href = URL.createObjectURL(file);
                 element.download = `SIEM_Report_${new Date().toISOString().slice(0,10)}.txt`;
                 document.body.appendChild(element); element.click(); document.body.removeChild(element);
            };

            const handleDeleteHistory = (e, id) => { 
                e.stopPropagation(); 
                const newHistory = playbookHistory.filter(x => x.id !== id);
                setPlaybookHistory(newHistory);
                savePlaybookToDB(newHistory); 
            };
            
            const handleOpenImplementationGuide = () => { setActiveTab('indicators'); if (playbookResult) setResultViewMode('guide'); else if (playbookHistory.length > 0) { const latest = playbookHistory[0]; setSystemInput(latest.input); setPlaybookResult(latest.content); setResultViewMode('guide'); } };

            return (
                <div className="h-full flex flex-col bg-slate-50 font-sans">
                    {/* Header */}
                    <header className="bg-slate-900 text-white p-4 flex justify-between items-center shadow-lg shrink-0 z-20">
                        <div className="flex items-center gap-3">
                            <div className="p-2 bg-indigo-600 rounded-lg shadow-inner"><Briefcase size={24} className="text-white"/></div>
                            <div>
                                <h1 className="text-xl font-bold tracking-wide">è³‡ç”¢èˆ‡å¨è„…æƒ…å¢ƒæˆ°æƒ…å®¤</h1>
                                <p className="text-slate-400 text-xs flex items-center gap-1">SIEM War Room <span className="w-1 h-1 rounded-full bg-slate-500"></span> Asset & Threat Intelligence</p>
                            </div>
                        </div>
                        <div className="flex items-center gap-4">
                             {syncStatus === 'connecting' && <span className="text-xs text-yellow-400 animate-pulse flex items-center gap-1 bg-yellow-400/10 px-2 py-1 rounded-full"><Cloud size={12}/> é€£ç·šä¸­...</span>}
                             {syncStatus === 'synced' && <span className="text-xs text-green-400 flex items-center gap-1 bg-green-400/10 px-2 py-1 rounded-full"><Check size={12}/> é›²ç«¯å…±ç”¨ä¸­</span>}
                             {syncStatus === 'error' && (
                                <button onClick={() => setShowRulesModal(true)} className="text-xs text-red-400 flex items-center gap-1 bg-red-400/10 px-2 py-1 rounded-full hover:bg-red-400/20" title={dbError}>
                                    <CloudOff size={12}/> {dbError.includes('permission') ? 'æ¬Šé™éŒ¯èª¤ (é»æˆ‘ä¿®å¾©)' : 'é›¢ç·š'}
                                </button>
                             )}
                        </div>
                    </header>

                    {/* Navigation Tabs */}
                    <div className="bg-white border-b border-gray-200 px-6 flex gap-8 shrink-0 shadow-sm z-10">
                        <button onClick={()=>setActiveTab('assets')} className={`py-4 text-sm font-bold flex items-center gap-2 border-b-2 transition-colors ${activeTab==='assets'?'border-indigo-600 text-indigo-600':'border-transparent text-gray-500 hover:text-gray-700'}`}><Server size={16}/> ç³»çµ±èˆ‡å¨è„…åˆ†æ</button>
                        <button onClick={()=>setActiveTab('indicators')} className={`py-4 text-sm font-bold flex items-center gap-2 border-b-2 transition-colors ${activeTab==='indicators'?'border-indigo-600 text-indigo-600':'border-transparent text-gray-500 hover:text-gray-700'}`}><Target size={16}/> ç›£æ§æŒ‡æ¨™ç”¢ç”Ÿå™¨</button>
                        <button onClick={()=>setActiveTab('history')} className={`py-4 text-sm font-bold flex items-center gap-2 border-b-2 transition-colors ${activeTab==='history'?'border-indigo-600 text-indigo-600':'border-transparent text-gray-500 hover:text-gray-700'}`}><LayoutDashboard size={16}/> æ­·å²æƒ…å¢ƒæˆ°æƒ…çœ‹æ¿</button>
                    </div>

                    {/* Content Area */}
                    <div className="flex-1 overflow-hidden relative flex flex-col">
                        {/* TAB 1: ASSETS & THREATS */}
                        {activeTab === 'assets' && (
                            <div className="flex w-full h-full">
                                {/* Left: Asset Management */}
                                <div className="w-1/3 bg-gray-50 border-r border-gray-200 flex flex-col p-6 overflow-hidden">
                                    <div className="flex justify-between items-center mb-4">
                                        <h3 className="font-bold text-gray-700 flex items-center gap-2"><Server className="text-indigo-500" size={18}/> è³‡ç”¢æ¸…å–® (Shared Inventory)</h3>
                                        <div className="flex gap-2">
                                           <button onClick={() => saveAssetsToDB(assetList)} className="text-xs bg-green-500 hover:bg-green-600 text-white px-2 py-1 rounded shadow-sm flex items-center gap-1"><Save size={12}/> å„²å­˜</button>
                                           <button onClick={handleAddAssetRow} className="text-xs bg-white border hover:bg-gray-50 text-gray-600 px-2 py-1 rounded shadow-sm flex items-center gap-1"><Plus size={12}/> æ–°å¢åˆ—</button>
                                        </div>
                                    </div>

                                    {/* Quick Add Section */}
                                    <div className="bg-white p-4 rounded-xl border border-indigo-100 shadow-sm mb-4">
                                        <div className="flex justify-between items-center mb-2">
                                            <label className="text-xs font-bold text-gray-500 uppercase tracking-wider">å¿«é€ŸåŠ å…¥å¸¸è¦‹ç³»çµ±</label>
                                        </div>
                                        <div className="flex gap-2 mb-3">
                                            <select className="flex-1 p-2 text-sm border border-gray-200 rounded-lg focus:ring-2 focus:ring-indigo-500 outline-none bg-gray-50" onChange={handleQuickAddAsset}>
                                                <option value="">é¸æ“‡å¸¸è¦‹ç³»çµ±...</option>
                                                {Object.entries(commonSystems).map(([cat, items]) => (
                                                    <optgroup key={cat} label={cat}>{items.map(s=><option key={s} value={s}>{s}</option>)}</optgroup>
                                                ))}
                                            </select>
                                            <button 
                                              onClick={handleAiSuggestAssets} 
                                              disabled={aiSuggestingAssets}
                                              className="px-3 py-2 bg-gradient-to-r from-purple-500 to-indigo-600 text-white rounded-lg shadow hover:shadow-md transition-all flex items-center gap-1 disabled:opacity-50 text-xs font-bold whitespace-nowrap"
                                              title="ç”± AI æ ¹æ“šæ¨™æº–æ¶æ§‹è‡ªå‹•æ¨è–¦æ ¸å¿ƒè³‡ç”¢ (æœƒè¦†è“‹ç¾æœ‰æ¸…å–®)"
                                            >
                                              {aiSuggestingAssets ? <Loader2 size={14} className="animate-spin"/> : <Wand2 size={14}/>} AI æ¨è–¦
                                            </button>
                                        </div>
                                        <label className="text-xs font-bold text-gray-500 uppercase tracking-wider block mb-1">åˆ†æç¶­åº¦ (Focus)</label>
                                        <select 
                                          className="w-full p-2 text-sm border border-gray-200 rounded-lg outline-none bg-indigo-50 text-indigo-900 font-medium" 
                                          value={analysisType}
                                          onChange={(e)=>setAnalysisType(e.target.value)}
                                        >
                                           {analysisOptions.map(opt => <option key={opt.id} value={opt.id}>{opt.label}</option>)}
                                        </select>
                                    </div>

                                    {/* Asset Table */}
                                    <div className="flex-1 overflow-y-auto bg-white rounded-xl border border-gray-200 shadow-inner">
                                        <table className="w-full text-left border-collapse">
                                            <thead className="bg-gray-50 sticky top-0 z-10 text-xs text-gray-500 uppercase">
                                                <tr>
                                                    <th className="p-3 border-b w-[30%]">åˆ†é¡</th>
                                                    <th className="p-3 border-b">åç¨±</th>
                                                    <th className="p-3 border-b w-10"></th>
                                                </tr>
                                            </thead>
                                            <tbody className="text-sm divide-y divide-gray-100">
                                                {assetList.map((asset, index) => (
                                                    <tr key={asset.id} className="hover:bg-indigo-50/30 group transition-colors">
                                                        <td className="p-2">
                                                            <select className="w-full bg-transparent outline-none text-xs text-gray-600" value={asset.category} onChange={(e)=>handleUpdateAssetRow(asset.id,'category',e.target.value)}>
                                                                <option value="" disabled>åˆ†é¡...</option>
                                                                {assetCategories.map(c=><option key={c} value={c}>{c}</option>)}
                                                            </select>
                                                        </td>
                                                        <td className="p-2">
                                                            <input className="w-full bg-transparent outline-none font-medium text-gray-800" value={asset.name} onChange={(e)=>handleUpdateAssetRow(asset.id,'name',e.target.value)} placeholder="è¼¸å…¥åç¨±..."/>
                                                        </td>
                                                        <td className="p-2 text-center">
                                                            <button onClick={()=>handleDeleteAssetRow(asset.id)} className="text-gray-300 hover:text-red-500 opacity-0 group-hover:opacity-100 transition-opacity"><Trash size={14}/></button>
                                                        </td>
                                                    </tr>
                                                ))}
                                                {assetList.length === 0 && <tr><td colSpan="3" className="p-8 text-center text-gray-400 text-xs">æš«ç„¡è³‡ç”¢ï¼Œè«‹å¾ä¸Šæ–¹æ–°å¢æˆ–ä½¿ç”¨ AI æ¨è–¦</td></tr>}
                                            </tbody>
                                        </table>
                                    </div>
                                    
                                    <button onClick={handleGenerateThreatAnalysis} disabled={threatLoading} className="mt-4 w-full bg-indigo-600 hover:bg-indigo-700 text-white py-3 rounded-xl font-bold shadow-lg shadow-indigo-200 flex items-center justify-center gap-2 transition-all transform active:scale-95">
                                        {threatLoading ? <Loader2 className="animate-spin"/> : <Activity size={18}/>} é–‹å§‹äº¤å‰åˆ†æ
                                    </button>
                                 </div>

                                 {/* Right: Analysis Result */}
                                 <div className="w-2/3 bg-white p-6 overflow-y-auto">
                                     <div className="flex border-b border-gray-200 mb-6">
                                        <button onClick={()=>setThreatViewTab('current')} className={`pb-3 px-4 text-sm font-medium border-b-2 transition-colors ${threatViewTab==='current'?'border-indigo-600 text-indigo-600':'border-transparent text-gray-400 hover:text-gray-600'}`}>ç›®å‰åˆ†æçµæœ</button>
                                        <button onClick={()=>setThreatViewTab('history')} className={`pb-3 px-4 text-sm font-medium border-b-2 transition-colors ${threatViewTab==='history'?'border-indigo-600 text-indigo-600':'border-transparent text-gray-400 hover:text-gray-600'}`}>åˆ†ææ­·å²ç´€éŒ„ ({threatHistory.length})</button>
                                     </div>

                                     {threatViewTab === 'current' ? (
                                         <div className="animate-in fade-in duration-500">
                                            {!threatData && !threatLoading && (
                                                <div className="h-96 flex flex-col items-center justify-center text-gray-300">
                                                    <BrainCircuit size={64} className="mb-4 opacity-50"/>
                                                    <p>è«‹åœ¨å·¦å´å®Œå–„è³‡ç”¢æ¸…å–®ä¸¦é»æ“Šåˆ†æ</p>
                                                </div>
                                            )}
                                            {threatLoading && (
                                                <div className="h-96 flex flex-col items-center justify-center text-indigo-500">
                                                    <Loader2 size={48} className="mb-4 animate-spin"/>
                                                    <p className="font-medium animate-pulse">AI æ­£åœ¨é€²è¡Œå¤šç¶­åº¦é—œè¯åˆ†æ...</p>
                                                </div>
                                            )}
                                            {threatData && (
                                                <div className="space-y-6">
                                                    <div className="flex items-center justify-between">
                                                        <div className="flex items-center gap-2">
                                                            <div className="p-2 bg-indigo-100 rounded-lg"><ShieldCheck className="text-indigo-600" size={20}/></div>
                                                            <div>
                                                                <h2 className="text-lg font-bold text-slate-800"><SafeText content={threatData.analysis_type} /></h2>
                                                                <p className="text-xs text-gray-400"><SafeText content={threatData.timestamp} /></p>
                                                            </div>
                                                        </div>
                                                    </div>

                                                    {/* Admin Guide */}
                                                    <div className="bg-slate-50 border border-slate-200 rounded-xl p-5">
                                                        <h4 className="font-bold text-slate-700 mb-4 flex items-center gap-2 text-sm"><ScrollText size={16}/> ğŸ“‹ ç³»çµ±ç®¡ç†å“¡ Log æ”¶é›†æŒ‡å¼•</h4>
                                                        <div className="grid gap-3">
                                                            {threatData.admin_log_guide?.map((guide, idx) => (
                                                                <div key={idx} className="bg-white p-3 rounded border border-slate-200 shadow-sm flex flex-col md:flex-row gap-4 items-start">
                                                                    <div className="md:w-1/4 font-bold text-slate-800 text-sm flex items-center gap-2"><Server size={14} className="text-gray-400"/><SafeText content={guide.system}/></div>
                                                                    <div className="md:w-3/4 text-xs space-y-2">
                                                                        <div className="flex gap-2">
                                                                            <span className="text-indigo-600 font-bold whitespace-nowrap bg-indigo-50 px-1 rounded">æ”¶é›†é …ç›®</span> 
                                                                            <span className="text-slate-600 leading-relaxed"><SafeText content={guide.log_items}/></span>
                                                                        </div>
                                                                        <div className="flex gap-2">
                                                                            <span className="text-emerald-600 font-bold whitespace-nowrap bg-emerald-50 px-1 rounded">è¨­å®šå»ºè­°</span> 
                                                                            <span className="text-slate-600 leading-relaxed"><SafeText content={guide.config_advice}/></span>
                                                                        </div>
                                                                    </div>
                                                                </div>
                                                            ))}
                                                        </div>
                                                    </div>

                                                    {/* Scenarios */}
                                                    <div>
                                                        <h4 className="font-bold text-slate-700 mb-4 text-sm flex items-center gap-2"><Activity size={16}/> é—œéµå¨è„…æƒ…å¢ƒåˆ—è¡¨</h4>
                                                        <div className="space-y-3">
                                                            {threatData.scenarios?.map((s, i) => <ScenarioCard key={i} scenario={s}/>)}
                                                        </div>
                                                    </div>
                                                </div>
                                            )}
                                         </div>
                                     ) : (
                                         <div className="space-y-3">
                                            {threatHistory.length === 0 && <div className="text-center text-gray-400 mt-20">å°šç„¡æ­·å²ç´€éŒ„</div>}
                                            {threatHistory.map((history, idx) => (
                                                <div key={idx} onClick={() => { setThreatData(history); setThreatViewTab('current'); }} className="p-4 border border-gray-200 rounded-xl hover:border-indigo-300 hover:shadow-md cursor-pointer transition-all bg-white group">
                                                    <div className="flex justify-between items-center mb-2">
                                                        <h5 className="font-bold text-indigo-700 flex items-center gap-2"><History size={16}/> <SafeText content={history.analysis_type}/></h5>
                                                        <span className="text-xs text-gray-400"><SafeText content={history.timestamp}/></span>
                                                    </div>
                                                    <div className="flex gap-4 text-xs text-gray-500">
                                                        <span className="bg-gray-100 px-2 py-1 rounded">æƒ…å¢ƒæ•¸: {history.scenarios?.length || 0}</span>
                                                        <span className="bg-red-50 text-red-600 px-2 py-1 rounded border border-red-100">High/Crit: {history.scenarios?.filter(s=>s.severity==='High'||s.severity==='Critical').length}</span>
                                                    </div>
                                                </div>
                                            ))}
                                         </div>
                                     )}
                                 </div>
                            </div>
                        )}

                        {/* TAB 2: INDICATORS (Playbook) */}
                        {activeTab === 'indicators' && (
                             <div className="flex-1 flex overflow-hidden">
                                <div className="w-1/3 p-6 border-r border-gray-200 overflow-y-auto bg-slate-50">
                                    <h4 className="font-bold text-slate-700 mb-4 flex items-center gap-2"><Target size={18}/> ç›£æ§æŒ‡æ¨™ç”¢ç”Ÿå™¨</h4>
                                    <div className="bg-white p-4 rounded-xl border border-gray-200 shadow-sm mb-4">
                                        <p className="text-xs text-gray-500 mb-3 leading-relaxed">æ­¤åŠŸèƒ½å°‡æ ¹æ“šæ‚¨çš„ç’°å¢ƒï¼Œè‡ªå‹•ç”Ÿæˆ Top 30 å„ªå…ˆç´šæœ€é«˜çš„ç›£æ§æŒ‡æ¨™èˆ‡å¯¦ä½œå»ºè­°ã€‚</p>
                                        <label className="block text-xs font-bold text-gray-700 mb-2">è£œå……ç’°å¢ƒè³‡è¨Š (é¸å¡«)</label>
                                        <textarea className="w-full h-32 p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 resize-none text-sm mb-3" placeholder="ä¾‹å¦‚ï¼šWindows AD, Exchange, Fortigate..." value={systemInput} onChange={e=>setSystemInput(e.target.value)}/>
                                        <button className="w-full bg-purple-600 hover:bg-purple-700 text-white py-2 rounded-lg font-bold shadow flex items-center justify-center gap-2" onClick={handleGeneratePlaybook} disabled={playbookLoading}>{playbookLoading ? <Loader2 className="animate-spin"/> : <ListChecks size={18}/>} ç”Ÿæˆ Top 30 æŒ‡æ¨™</button>
                                    </div>
                                    
                                    {/* Playbook History Sidebar */}
                                    <h5 className="font-bold text-gray-500 text-xs uppercase mb-3 px-1">æœ€è¿‘ç´€éŒ„</h5>
                                    <div className="space-y-2">
                                        {playbookHistory.map(h => (
                                            <div key={h.id} onClick={()=>{setPlaybookResult(h.content); setSystemInput(h.input);}} className="p-3 bg-white border border-gray-200 rounded-lg cursor-pointer hover:border-purple-300 transition-colors text-xs shadow-sm">
                                                <div className="flex justify-between text-gray-400 mb-1"><span>{h.timestamp.split(' ')[0]}</span><button onClick={(e)=>handleDeleteHistory(e,h.id)} className="hover:text-red-500"><Trash size={12}/></button></div>
                                                <div className="font-medium text-gray-700 truncate">{h.input || 'è‡ªå‹•ç”Ÿæˆ'}</div>
                                            </div>
                                        ))}
                                    </div>
                                </div>
                                <div className="w-2/3 p-8 overflow-y-auto bg-white">
                                    {playbookResult ? (
                                        <div className="max-w-4xl mx-auto">
                                            <div className="flex justify-between items-center mb-6 border-b pb-4">
                                                <h3 className="text-xl font-bold text-slate-800 flex items-center gap-2"><ListChecks className="text-purple-600"/> ç”Ÿæˆçµæœ</h3>
                                                <div className="flex gap-2">
                                                    <button onClick={()=>handleGenerateChart(getResultContent(playbookResult,'text'))} className={`flex items-center gap-2 text-xs font-bold px-3 py-2 rounded-lg border transition-colors ${resultViewMode==='chart'?'bg-purple-50 text-purple-700 border-purple-200':'hover:bg-gray-50'}`}><BarChart3 size={14}/> è¦–è¦ºåŒ–</button>
                                                    <button onClick={()=>setResultViewMode('text')} className={`flex items-center gap-2 text-xs font-bold px-3 py-2 rounded-lg border transition-colors ${resultViewMode==='text'?'bg-purple-50 text-purple-700 border-purple-200':'hover:bg-gray-50'}`}><ShieldCheck size={14}/> é¢¨éšªæŒ‡æ¨™</button>
                                                    <button onClick={()=>setResultViewMode('guide')} className={`flex items-center gap-2 text-xs font-bold px-3 py-2 rounded-lg border transition-colors ${resultViewMode==='guide'?'bg-purple-50 text-purple-700 border-purple-200':'hover:bg-gray-50'}`}><Wrench size={14}/> å¯¦ä½œæŒ‡å¼•</button>
                                                    <button onClick={()=>handleExportTxt(playbookResult)} className="flex items-center gap-2 text-xs font-bold px-3 py-2 rounded-lg border hover:bg-gray-50"><Download size={14}/></button>
                                                </div>
                                            </div>

                                            {resultViewMode === 'chart' && chartData ? (
                                                <div className="space-y-6 animate-in fade-in">
                                                    <div className="bg-purple-50 p-6 rounded-2xl border border-purple-100">
                                                        <h5 className="font-bold text-purple-900 mb-4 flex items-center gap-2"><LayoutDashboard size={16}/> å„ªå…ˆç´šåˆ†ä½ˆ</h5>
                                                        <div className="flex h-4 rounded-full overflow-hidden mb-4">
                                                            {Object.entries(chartData.priority_stats||{}).map(([k,v],i)=><div key={k} style={{width:`${(v/Object.values(chartData.priority_stats).reduce((a,b)=>a+b,0))*100}%`}} className={`h-full ${['bg-red-500','bg-amber-500','bg-blue-500'][i%3]}`}></div>)}
                                                        </div>
                                                        <div className="flex gap-4">
                                                            {Object.entries(chartData.priority_stats||{}).map(([k,v],i)=><div key={k} className="flex items-center gap-2 text-sm"><span className={`w-3 h-3 rounded-full ${['bg-red-500','bg-amber-500','bg-blue-500'][i%3]}`}></span><span className="font-medium text-slate-700">{k}: {v}</span></div>)}
                                                        </div>
                                                    </div>
                                                    <div className="grid grid-cols-2 gap-6">
                                                        <div className="bg-white p-5 rounded-2xl border border-gray-200 shadow-sm">
                                                            <h5 className="font-bold text-gray-700 mb-4 flex items-center gap-2"><Database size={16}/> Top Data Sources</h5>
                                                            {Object.entries(chartData.source_stats||{}).map(([k,v])=><div key={k} className="flex justify-between text-sm py-2 border-b last:border-0 border-gray-50"><span className="text-gray-600">{k}</span><span className="font-bold text-purple-600">{v}</span></div>)}
                                                        </div>
                                                        <div className="bg-white p-5 rounded-2xl border border-gray-200 shadow-sm">
                                                            <h5 className="font-bold text-gray-700 mb-4 flex items-center gap-2"><PieChart size={16}/> Risk Categories</h5>
                                                            {Object.entries(chartData.category_stats||{}).map(([k,v])=><div key={k} className="flex justify-between text-sm py-2 border-b last:border-0 border-gray-50"><span className="text-gray-600">{k}</span><span className="font-bold text-indigo-600">{v}</span></div>)}
                                                        </div>
                                                    </div>
                                                </div>
                                            ) : (
                                                <div className="animate-in fade-in prose prose-slate max-w-none prose-sm">
                                                    {renderMarkdown(getResultContent(playbookResult, resultViewMode))}
                                                </div>
                                            )}
                                        </div>
                                    ) : (
                                        <div className="h-full flex flex-col items-center justify-center text-gray-300">
                                            <ListChecks size={80} className="mb-4 opacity-50"/>
                                            <p>è«‹é»æ“Šå·¦å´ç”ŸæˆæŒ‰éˆ•</p>
                                        </div>
                                    )}
                                </div>
                            </div>
                        )}

                        {/* TAB 3: HISTORY DASHBOARD */}
                        {activeTab === 'history' && (
                            <div className="flex-1 overflow-y-auto bg-gray-50 p-8 pb-32">
                                <div className="max-w-7xl mx-auto space-y-8">
                                    <div className="flex justify-between items-end">
                                        <div>
                                            <h2 className="text-2xl font-bold text-slate-800">æ­·å²æƒ…å¢ƒæˆ°æƒ…çœ‹æ¿</h2>
                                            <p className="text-slate-500 text-sm mt-1">åŒ¯ç¸½æ‰€æœ‰æ­·å²åˆ†æçµæœï¼Œå³æ™‚æŒæ¡å¨è„…åˆ†ä½ˆæ…‹å‹¢</p>
                                        </div>
                                        <div className="bg-white px-4 py-2 rounded-lg border border-gray-200 shadow-sm text-sm font-bold text-slate-600">
                                            ç¸½æƒ…å¢ƒæ•¸: {Object.values(aggregatedHistory.byRisk).flat().length}
                                        </div>
                                    </div>

                                    {/* Stats Cards */}
                                    <div className="grid grid-cols-1 md:grid-cols-4 gap-4">
                                        {[
                                            { label: 'Critical Risk', count: aggregatedHistory.byRisk.Critical?.length || 0, color: 'rose', icon: LucideIcons.AlertOctagon },
                                            { label: 'High Risk', count: aggregatedHistory.byRisk.High?.length || 0, color: 'red', icon: LucideIcons.AlertTriangle },
                                            { label: 'Medium Risk', count: aggregatedHistory.byRisk.Medium?.length || 0, color: 'yellow', icon: LucideIcons.Activity },
                                            { label: 'Low Risk', count: aggregatedHistory.byRisk.Low?.length || 0, color: 'blue', icon: LucideIcons.Info }
                                        ].map((stat, i) => (
                                            <div key={i} className={`bg-white p-5 rounded-xl border-l-4 shadow-sm flex justify-between items-center border-${stat.color}-500`}>
                                                <div>
                                                    <p className={`text-xs font-bold uppercase text-${stat.color}-600 mb-1`}>{stat.label}</p>
                                                    <p className="text-3xl font-bold text-slate-800">{stat.count}</p>
                                                </div>
                                                <stat.icon className={`text-${stat.color}-200`} size={32}/>
                                            </div>
                                        ))}
                                    </div>

                                    {/* Detailed Grids */}
                                    <div className="grid grid-cols-1 lg:grid-cols-3 gap-8">
                                        {/* By Risk Column */}
                                        <div className="lg:col-span-2 space-y-6">
                                            <h4 className="font-bold text-slate-700 flex items-center gap-2"><LayoutGrid size={18}/> ä¾é¢¨éšªç­‰ç´šæ­¸é¡ (By Risk)</h4>
                                            <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                                                {['Critical', 'High'].map(level => (
                                                    <div key={level} className="bg-white rounded-xl border border-gray-200 shadow-sm flex flex-col h-full min-h-[400px]">
                                                        <div className={`p-4 border-b font-bold flex justify-between items-center ${level==='Critical'?'bg-rose-50 text-rose-800':'bg-red-50 text-red-800'}`}>
                                                            {level} Priority <span className="bg-white px-2 py-0.5 rounded text-xs border shadow-sm">{aggregatedHistory.byRisk[level]?.length || 0}</span>
                                                        </div>
                                                        <div className="p-3 overflow-y-auto flex-1 bg-slate-50 space-y-3">
                                                            {aggregatedHistory.byRisk[level]?.map((s, idx) => <ScenarioCard key={idx} scenario={s}/>)}
                                                            {(!aggregatedHistory.byRisk[level]?.length) && <div className="text-center text-gray-400 text-xs mt-20">ç„¡è³‡æ–™</div>}
                                                        </div>
                                                    </div>
                                                ))}
                                            </div>
                                        </div>

                                        {/* By Category Column */}
                                        <div className="space-y-6">
                                            <h4 className="font-bold text-slate-700 flex items-center gap-2"><LayoutDashboard size={18}/> ä¾å¨è„…é¡åˆ¥æ­¸é¡</h4>
                                            <div className="space-y-4">
                                                {Object.entries(aggregatedHistory.byCategory).map(([cat, items]) => (
                                                    <div key={cat} className="bg-white rounded-xl border border-gray-200 shadow-sm overflow-hidden">
                                                        <div className="p-3 bg-slate-100 border-b border-gray-200 font-bold text-slate-700 text-sm flex justify-between cursor-pointer hover:bg-slate-200 transition-colors">
                                                            {cat} <span>{items.length}</span>
                                                        </div>
                                                        {items.length > 0 && (
                                                            <div className="p-2 max-h-[300px] overflow-y-auto bg-slate-50 space-y-2">
                                                                {items.map((s, idx) => <ScenarioCard key={idx} scenario={s}/>)}
                                                            </div>
                                                        )}
                                                    </div>
                                                ))}
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        )}
                    </div>

                     {/* Help Modal for Permission Error */}
                     {showRulesModal && (
                        <div className="fixed inset-0 bg-black/70 z-50 flex items-center justify-center p-4 animate-in fade-in">
                            <div className="bg-white rounded-xl w-full max-w-lg shadow-2xl p-6 relative">
                                <button onClick={() => setShowRulesModal(false)} className="absolute top-4 right-4 text-gray-400 hover:text-gray-600"><X size={20}/></button>
                                <h3 className="text-lg font-bold text-red-600 mb-2 flex items-center gap-2"><AlertTriangle/> è³‡æ–™åº«æ¬Šé™ä¸è¶³</h3>
                                <p className="text-sm text-gray-600 mb-4">
                                    ç‚ºäº†è®“ GitHub Pages ä¸Šçš„æˆ°æƒ…å®¤èƒ½å…±ç”¨è³‡æ–™ï¼Œè«‹åˆ° Firebase Console ä¿®æ”¹ <strong>Firestore Database Rules</strong>ï¼š
                                </p>
                                <div className="bg-slate-900 text-gray-200 p-4 rounded-lg text-xs font-mono mb-4 overflow-x-auto">
                                    <pre>{`rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    match /{document=**} {
      allow read, write: if true;
    }
  }
}`}</pre>
                                </div>
                                <div className="text-right">
                                    <a href="https://console.firebase.google.com/" target="_blank" className="text-indigo-600 text-sm font-bold hover:underline">å‰å¾€ Firebase Console &rarr;</a>
                                </div>
                            </div>
                        </div>
                     )}

                     {/* Toast Notification */}
                     {toast && (
                        <div className={`fixed bottom-4 right-4 px-4 py-2 rounded-lg text-white text-sm font-bold shadow-lg animate-fade-in-up z-50 ${toast.type==='error'?'bg-red-500':'bg-emerald-600'}`}>
                            {toast.message}
                        </div>
                    )}
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(React.createElement(WarRoom));
    </script>
</body>
</html>