<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SIEM 資產與威脅戰情總部 (Visual Ops Pro)</title>
    
    <!-- 1. 引入 Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- 2. 引入 Babel Standalone -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/babel-standalone/7.23.6/babel.min.js"></script>

    <!-- 3. 引入 Mermaid.js (用於攻擊路徑視覺化) -->
    <script src="https://cdn.jsdelivr.net/npm/mermaid/dist/mermaid.min.js"></script>

    <!-- 4. 設定 Import Map -->
    <script type="importmap">
      {
        "imports": {
          "react": "https://esm.sh/react@18.2.0",
          "react-dom/client": "https://esm.sh/react-dom@18.2.0/client",
          "lucide-react": "https://esm.sh/lucide-react@0.292.0"
        }
      }
    </script>

    <script>
      tailwind.config = {
        theme: {
          extend: {
            colors: {
              slate: { 850: '#1e293b' }
            },
            animation: {
                'fade-in-up': 'fadeInUp 0.3s ease-out forwards',
            },
            keyframes: {
                fadeInUp: {
                    '0%': { opacity: '0', transform: 'translateY(10px)' },
                    '100%': { opacity: '1', transform: 'translateY(0)' },
                }
            }
          }
        }
      }
    </script>
    <style>
        ::-webkit-scrollbar { width: 6px; height: 6px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 10px; }
        ::-webkit-scrollbar-thumb:hover { background: #94a3b8; }

        .mermaid-container svg { max-width: 100%; height: auto; }

        .prose pre { 
            background: #0f172a !important; 
            border: 1px solid #1e293b;
            color: #38bdf8 !important;
            padding: 1.25rem !important;
            border-radius: 0.75rem !important;
            overflow-x: auto;
        }
        .chat-scroll::-webkit-scrollbar { width: 4px; }
    </style>
</head>
<body class="bg-gray-100 text-slate-800 h-screen w-screen overflow-hidden flex flex-col">
    
    <div id="root" class="flex-1 flex flex-col overflow-hidden"></div>

    <script type="text/babel" data-type="module">
        import React, { useState, useRef, useEffect, useMemo } from 'react';
        import ReactDOM from 'react-dom/client';
        import * as LucideIcons from 'lucide-react';
        
        // Firebase SDK
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, onSnapshot, collection } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- Mermaid Initialization ---
        mermaid.initialize({ 
            startOnLoad: false, 
            theme: 'base',
            securityLevel: 'loose',
            themeVariables: {
                primaryColor: '#eef2ff',
                lineColor: '#6366f1',
                secondaryColor: '#f8fafc',
                tertiaryColor: '#ffffff',
                fontSize: '14px',
                fontFamily: 'system-ui'
            }
        });

        // --- Helper: Safe String ---
        const safeString = (content) => {
            if (content === null || content === undefined) return '';
            if (typeof content === 'string') return content;
            if (typeof content === 'object' && content.seconds) return new Date(content.seconds * 1000).toLocaleString();
            try { return JSON.stringify(content); } catch(e) { return String(content); }
        };

        // --- Component: Attack Visualization Chart ---
        const AttackGraph = ({ mermaidCode }) => {
            const containerRef = useRef(null);
            const [error, setError] = useState(null);

            useEffect(() => {
                if (!mermaidCode || !containerRef.current) return;
                const renderChart = async () => {
                    setError(null);
                    containerRef.current.innerHTML = '<div class="flex items-center gap-2 text-slate-400 animate-pulse text-xs">渲染圖表中...</div>';
                    try {
                        const id = `mermaid-${Math.random().toString(36).substr(2, 9)}`;
                        await mermaid.parse(mermaidCode);
                        const { svg } = await mermaid.render(id, mermaidCode);
                        containerRef.current.innerHTML = svg;
                    } catch (e) {
                        setError("圖表語法錯誤");
                        containerRef.current.innerHTML = "";
                    }
                };
                renderChart();
            }, [mermaidCode]);

            return (
                <div className="w-full flex flex-col items-center justify-center min-h-[300px]">
                    <div ref={containerRef} className="mermaid-container w-full flex justify-center p-4"></div>
                    {error && <div className="text-red-500 text-[10px] mt-2 bg-red-50 px-2 py-1 rounded border border-red-100">{error}</div>}
                </div>
            );
        };

        // --- Component: Markdown Renderer ---
        const RenderMarkdown = ({ text }) => {
            if (!text) return null;
            const lines = text.split('\n');
            const elements = [];
            let inCodeBlock = false;
            let codeLines = [];

            lines.forEach((line, i) => {
                if (line.trim().startsWith('```')) {
                    if (inCodeBlock) {
                        elements.push(<pre key={`code-${i}`} className="bg-slate-900 text-blue-300 p-4 rounded-lg text-xs overflow-x-auto font-mono my-3 shadow-inner"><code>{codeLines.join('\n')}</code></pre>);
                        codeLines = [];
                    }
                    inCodeBlock = !inCodeBlock;
                    return;
                }
                if (inCodeBlock) { codeLines.push(line); return; }
                const trimmed = line.trim();
                if (trimmed.startsWith('###')) {
                    elements.push(<h3 key={i} className="font-bold text-slate-800 mt-5 mb-2 border-l-4 border-indigo-500 pl-3 text-lg">{trimmed.replace(/#/g, '')}</h3>);
                } else if (trimmed.startsWith('- ') || trimmed.startsWith('* ')) {
                    elements.push(<li key={i} className="ml-4 text-sm text-slate-600 mb-1 list-disc">{trimmed.substring(2)}</li>);
                } else if (trimmed.length > 0) {
                    elements.push(<p key={i} className="text-sm text-slate-600 mb-2 leading-relaxed">{trimmed}</p>);
                }
            });
            return <div className="prose prose-sm max-w-none">{elements}</div>;
        };

        // --- Component: Scenario Card ---
        const ScenarioCard = ({ scenario, onAction }) => {
            if (!scenario) return null;
            const severityColors = {
                'Critical': 'bg-rose-900 text-white border-rose-950',
                'High': 'bg-red-50 text-red-700 border-red-200',
                'Medium': 'bg-yellow-50 text-yellow-700 border-yellow-200',
                'Low': 'bg-emerald-50 text-emerald-700 border-emerald-200'
            };
            const sevClass = severityColors[scenario.severity] || severityColors['Low'];

            return (
                <div className="bg-white border border-slate-200 rounded-2xl p-4 shadow-sm hover:shadow-md transition-all group animate-in slide-in-from-bottom-2">
                    <div className="flex justify-between items-start mb-3">
                        <div className="flex items-center gap-3">
                            <span className={`text-[10px] px-2 py-0.5 rounded-full border font-black uppercase tracking-widest ${sevClass}`}>{scenario.severity}</span>
                            <h4 className="font-bold text-slate-800 text-sm leading-tight">{scenario.title}</h4>
                        </div>
                    </div>
                    <div className="bg-slate-50 p-3 rounded-xl border border-slate-100 text-xs text-slate-500 leading-relaxed mb-4">
                        <div className="flex gap-2 mb-1"><LucideIcons.BrainCircuit size={14} className="text-indigo-500 shrink-0 mt-0.5"/> <span>{scenario.correlation_logic}</span></div>
                    </div>
                    <div className="flex flex-wrap gap-2 justify-end">
                         <button onClick={() => onAction('VISUALIZE', scenario)} className="flex items-center gap-1.5 text-[10px] font-bold bg-slate-900 text-white px-3 py-1.5 rounded-lg shadow-sm hover:bg-black transition-all active:scale-95"><LucideIcons.Eye size={12}/> 攻擊視覺化</button>
                         <button onClick={() => onAction('MITIGATE', scenario)} className="flex items-center gap-1.5 text-[10px] font-bold border border-slate-300 text-slate-600 px-3 py-1.5 rounded-lg hover:bg-slate-50 transition-all active:scale-95">應變緩解</button>
                         <button onClick={() => onAction('RULE', scenario)} className="flex items-center gap-1.5 text-[10px] font-bold border border-slate-300 text-slate-600 px-3 py-1.5 rounded-lg hover:bg-slate-50 transition-all active:scale-95">SIEM 語法</button>
                    </div>
                </div>
            );
        };

        // --- Main App ---
        const WarRoom = () => {
            const { 
                Briefcase, Server, ShieldCheck, Activity, Loader2, BrainCircuit, Check, Plus, Trash, ArrowUp, ArrowDown, Settings, 
                ListChecks, BarChart3, Wrench, Download, LayoutGrid, ScrollText, Wand2, MessageSquare, Send, X, Code2, 
                ShieldAlert, FileJson, Bug, Microscope, Footprints, Globe, Scale, Terminal, BookOpen, Eye, Waypoints, Maximize2, Minimize2, Save, Sparkles, Database, Mail, AlertTriangle, RefreshCw, ClipboardList
            } = LucideIcons;

            const apiKey = "AIzaSyBILGldyB" + "CUqYZ_Ay87f49K" + "nlBs4-dvx8I"; 
            
            const aid = typeof __app_id !== 'undefined' ? __app_id : 'default-siem-app';
            const config = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {
                apiKey: "AIzaSyA98h3qS1RWeWuSKTWZmMmYsUG-cZl8YwE",
                authDomain: "siem-6dc7e.firebaseapp.com",
                projectId: "siem-6dc7e",
                storageBucket: "siem-6dc7e.firebasestorage.app",
                messagingSenderId: "285198821105",
                appId: "1:285198821105:web:17fc91f4e8567a2bdc2b50"
            };
            const fApp = initializeApp(config);
            const auth = getAuth(fApp);
            const db = getFirestore(fApp);

            const commonSystems = {
                "網路資安": ["Palo Alto Firewall", "CheckPoint Firewall", "Fortigate", "Cisco ASA"],
                "端點防護": ["CrowdStrike", "SentinelOne", "TrendMicro ApexOne"],
                "系統身分": ["Windows AD", "Azure AD", "Linux RHEL", "vCenter"],
                "關鍵應用": ["SAP", "Oracle DB", "HRM System", "MES System"]
            };
            const assetCategories = Object.keys(commonSystems);

            // States
            const [user, setUser] = useState(null);
            const [syncStatus, setSyncStatus] = useState('connecting');
            const [activeTab, setActiveTab] = useState('assets'); 
            const [toast, setToast] = useState(null);
            const [troubleshootType, setTroubleshootType] = useState(null); 

            const [assetList, setAssetList] = useState([]);
            const [threatData, setThreatData] = useState(null);
            const [threatLoading, setThreatLoading] = useState(false);
            const [threatHistory, setThreatHistory] = useState([]);

            const [isChatOpen, setIsChatOpen] = useState(false);
            const [isChatMaximized, setIsChatMaximized] = useState(false);
            const [chatInput, setChatInput] = useState("");
            const [chatHistory, setChatHistory] = useState([{ role: 'bot', text: '您好！我是您的 SOC Copilot。偵測到異常時我會為您提供防禦建議。' }]);
            const [chatLoading, setChatLoading] = useState(false);
            const chatEndRef = useRef(null);

            const [visualizeModalOpen, setVisualizeModalOpen] = useState(false);
            const [selectedScenarioForVis, setSelectedScenarioForVis] = useState(null);
            const [visLoading, setVisLoading] = useState(false);

            const [activeModal, setActiveModal] = useState(null); 
            const [toolInput, setToolInput] = useState('');
            const [toolResult, setToolResult] = useState('');
            const [toolLoading, setToolLoading] = useState(false);
            const [aiSuggestingAssets, setAiSuggestingAssets] = useState(false);

            // Memos
            const visGallery = useMemo(() => {
                const list = [];
                threatHistory.forEach(h => h.scenarios?.forEach(s => s.mermaid_code && list.push({ ...s, ts: h.timestamp })));
                return list;
            }, [threatHistory]);

            const logGuideGallery = useMemo(() => {
                const guides = [];
                threatHistory.forEach(h => {
                    if (h.admin_log_guide && Array.isArray(h.admin_log_guide)) {
                        h.admin_log_guide.forEach(g => {
                            guides.push({ ...g, source_type: h.analysis_type, source_date: h.timestamp });
                        });
                    }
                });
                return guides;
            }, [threatHistory]);

            const aggregated = useMemo(() => {
                const s = { Critical: [], High: [], Medium: [], Low: [] };
                threatHistory.forEach(h => h.scenarios?.forEach(sc => { if (s[sc.severity]) s[sc.severity].push({ ...sc, date: h.timestamp }); }));
                return s;
            }, [threatHistory]);

            // Sync Logic
            useEffect(() => {
                const authInit = async () => { try { await signInAnonymously(auth); } catch (e) { setSyncStatus('error'); } };
                authInit();
                onAuthStateChanged(auth, (u) => { if(u) { setUser(u); setSyncStatus('synced'); } });
            }, []);

            useEffect(() => {
                if (!user) return;
                const unsubA = onSnapshot(doc(db, 'artifacts', aid, 'public', 'data', 'assets', 'main'), (s) => s.exists() && setAssetList(s.data().items || []), (e) => e.code === 'permission-denied' && setTroubleshootType('FIREBASE_PERMISSION'));
                const unsubH = onSnapshot(doc(db, 'artifacts', aid, 'public', 'data', 'history', 'main'), (s) => {
                    if (s.exists()) {
                        const items = s.data().items || [];
                        setThreatHistory(items);
                        if (items.length > 0 && !threatData) setThreatData(items[0]);
                    }
                }, (e) => e.code === 'permission-denied' && setTroubleshootType('FIREBASE_PERMISSION'));
                return () => { unsubA(); unsubH(); };
            }, [user]);

            const saveToDB = async (coll, val) => {
                if (!user) return;
                try {
                    await setDoc(doc(db, 'artifacts', aid, 'public', 'data', coll, 'main'), { items: val });
                    setToast({ message: "數據已雲端同步", type: 'success' });
                    setTimeout(() => setToast(null), 3000);
                } catch (e) { if(e.code === 'permission-denied') setTroubleshootType('FIREBASE_PERMISSION'); }
            };

            const fetchGemini = async (prompt) => {
                try {
                    const payload = { contents: [{ parts: [{ text: prompt }] }] };
                    const res = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`, {
                        method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload)
                    });
                    if (res.status === 403) { setTroubleshootType('GOOGLE_REFERER'); throw new Error("Referer Blocked"); }
                    const data = await res.json();
                    return data.candidates?.[0]?.content?.parts?.[0]?.text;
                } catch (e) { throw e; }
            };

            const handleAnalyze = async () => {
                if (!assetList.length) return;
                setThreatLoading(true); setThreatData(null);
                const assetStr = assetList.map(a => `- [${a.category}] ${a.name}: ${a.note}`).join('\n');
                const prompt = `你是一位資深 SOC 分析師。針對資產：\n${assetStr}\n進行交叉分析。回傳格式純 JSON: { "analysis_type": "綜合交叉分析", "scenarios": [ { "title", "category", "severity", "correlation_logic", "mermaid_code": "graph LR;...", "data_sources": [{"device", "event", "priority": "High"}] } ], "admin_log_guide": [{"system", "log_items", "config_advice"}] }。
                severity 選項: Critical, High, Medium, Low。mermaid_code 請使用 graph LR 並標註攻擊色彩。請用繁體中文。`;
                try {
                    const raw = await fetchGemini(prompt);
                    const json = JSON.parse(raw.match(/\{[\s\S]*\}/)[0]);
                    const res = { ...json, timestamp: new Date().toLocaleString() };
                    setThreatData(res);
                    const nh = [res, ...threatHistory];
                    setThreatHistory(nh);
                    saveToDB('history', nh);
                } catch (e) { console.error(e); } finally { setThreatLoading(false); }
            };

            const handleRegenVis = async () => {
                if(!selectedScenarioForVis) return;
                setVisLoading(true);
                try {
                    const raw = await fetchGemini(`為此威脅情境：『${selectedScenarioForVis.title}』產生 Mermaid (graph LR) 圖表與詳細 SIEM 監控對照表。JSON: { "mermaid_code": "...", "data_sources": [{"device", "event", "priority"}] }`);
                    const data = JSON.parse(raw.match(/\{[\s\S]*\}/)[0]);
                    const updated = { ...selectedScenarioForVis, ...data };
                    setSelectedScenarioForVis(updated);
                    const nh = threatHistory.map(h => ({ ...h, scenarios: h.scenarios?.map(s => s.title === updated.title ? updated : s) }));
                    setThreatHistory(nh); saveToDB('history', nh);
                } catch (e) {} finally { setVisLoading(false); }
            };

            const handleChatSubmit = async (e) => {
                e.preventDefault(); if (!chatInput.trim()) return;
                const msg = chatInput; setChatInput("");
                setChatHistory(p => [...p, { role: 'user', text: msg }]);
                setChatLoading(true);
                try {
                    const r = await fetchGemini(`你是一位專家級 SOC 分析師。請詳細解答：${msg}`);
                    setChatHistory(p => [...p, { role: 'bot', text: r }]);
                } catch (e) {} finally { setChatLoading(false); }
            };

            const handleAction = async (type, scenario) => {
                if(type === 'VISUALIZE') { setSelectedScenarioForVis(scenario); setVisualizeModalOpen(true); return; }
                setIsChatOpen(true);
                const task = type === 'MITIGATE' ? `請為『${scenario.title}』提供緩解措施。` : `請為『${scenario.title}』產生 SIEM 規則語法。`;
                setChatHistory(p => [...p, { role: 'user', text: task }]);
                setChatLoading(true);
                try {
                    const r = await fetchGemini(`扮演 SOC 工程師。情境是：${scenario.title}。任務：${task}。請詳細回答並提供技術範例。繁體中文。`);
                    setChatHistory(p => [...p, { role: 'bot', text: r }]);
                } catch (e) {} finally { setChatLoading(false); }
            };

            const handleToolAction = async (type) => {
                setToolLoading(true); setToolResult('');
                let p = "";
                if(type === 'RACI') p = `為此任務建立 RACI 矩陣：${toolInput}`;
                if(type === 'PARSER') p = `解析這段 Log 並轉為 JSON：${toolInput}`;
                if(type === 'QUERY') p = `將此描述轉為 Splunk SPL 查詢：${toolInput}`;
                if(type === 'SCRIPT') p = `分析此腳本是否惡意：${toolInput}`;
                try { const r = await fetchGemini(p); setToolResult(r); } finally { setToolLoading(false); }
            };

            useEffect(() => { if (chatEndRef.current) chatEndRef.current.scrollIntoView({ behavior: "smooth" }); }, [chatHistory, isChatOpen]);

            return (
                <div className="h-full flex flex-col bg-slate-50 relative overflow-hidden font-sans">
                    {/* Header */}
                    <header className="bg-slate-900 text-white p-4 flex justify-between items-center shadow-lg shrink-0 z-20">
                        <div className="flex items-center gap-3">
                            <div className="p-2 bg-indigo-600 rounded-xl shadow-inner"><Briefcase size={22}/></div>
                            <div>
                                <h1 className="text-xl font-bold tracking-tight">SIEM 戰情核心總部</h1>
                                <p className="text-slate-400 text-[9px] uppercase tracking-widest">Enterprise Visual Ops</p>
                            </div>
                        </div>
                        <div className="flex items-center gap-2">
                             <button onClick={()=>setActiveModal('RACI')} className="text-[10px] bg-slate-800 hover:bg-slate-700 px-2 py-1 rounded border border-slate-700">RACI</button>
                             <button onClick={()=>setActiveModal('PARSER')} className="text-[10px] bg-slate-800 hover:bg-slate-700 px-2 py-1 rounded border border-slate-700">Log 解析</button>
                             <button onClick={()=>setActiveModal('QUERY')} className="text-[10px] bg-slate-800 hover:bg-slate-700 px-2 py-1 rounded border border-slate-700">查詢生成</button>
                             <button onClick={()=>setActiveModal('SCRIPT')} className="text-[10px] bg-slate-800 hover:bg-slate-700 px-2 py-1 rounded border border-slate-700">腳本分析</button>
                             <div className="h-4 w-px bg-slate-700 mx-2"></div>
                             <button onClick={() => setIsChatOpen(true)} className="p-2 bg-indigo-600 hover:bg-indigo-500 rounded-full transition-transform hover:scale-105"><MessageSquare size={18}/></button>
                        </div>
                    </header>

                    {/* Navbar */}
                    <div className="bg-white border-b border-gray-200 px-6 flex gap-8 shrink-0 shadow-sm z-10">
                        <button onClick={()=>setActiveTab('assets')} className={`py-4 text-sm font-bold border-b-2 transition-all ${activeTab==='assets'?'border-indigo-600 text-indigo-600':'border-transparent text-gray-500 hover:text-gray-700'}`}>分析中心</button>
                        <button onClick={()=>setActiveTab('history')} className={`py-4 text-sm font-bold border-b-2 transition-all ${activeTab==='history'?'border-indigo-600 text-indigo-600':'border-transparent text-gray-500 hover:text-gray-700'}`}>戰情看板</button>
                        <button onClick={()=>setActiveTab('visual_gallery')} className={`py-4 text-sm font-bold border-b-2 transition-all flex items-center gap-2 ${activeTab==='visual_gallery'?'border-indigo-600 text-indigo-600':'border-transparent text-gray-500 hover:text-gray-700'}`}><Waypoints size={16}/> 視覺化庫 <span className="bg-indigo-100 text-indigo-600 px-1.5 rounded-full text-[10px] font-mono">{visGallery.length}</span></button>
                        <button onClick={()=>setActiveTab('log_guides')} className={`py-4 text-sm font-bold border-b-2 transition-all flex items-center gap-2 ${activeTab==='log_guides'?'border-indigo-600 text-indigo-600':'border-transparent text-gray-500 hover:text-gray-700'}`}><ClipboardList size={16}/> Log 收集指引庫 <span className="bg-indigo-100 text-indigo-600 px-1.5 rounded-full text-[10px] font-mono">{logGuideGallery.length}</span></button>
                    </div>

                    {/* Content Area */}
                    <div className="flex-1 overflow-hidden relative">
                        {/* TAB: ASSETS */}
                        {activeTab === 'assets' && (
                            <div className="flex w-full h-full">
                                <div className="w-5/12 bg-gray-50 border-r border-gray-200 flex flex-col p-6 overflow-hidden">
                                    <div className="flex justify-between items-center mb-4">
                                        <h3 className="font-bold text-gray-700 flex items-center gap-2"><Server size={18} className="text-indigo-500"/> 資產管理</h3>
                                        <div className="flex gap-2">
                                            <button onClick={() => saveToDB('assets', assetList)} className="text-[10px] bg-green-600 text-white px-2 py-1 rounded shadow-sm hover:bg-green-700">儲存</button>
                                            <button onClick={() => setAssetList([...assetList, { id: Date.now(), name: "新資產", category: "系統身分", note: "" }])} className="text-[10px] bg-white border px-2 py-1 rounded shadow-sm hover:bg-gray-100"><Plus size={10}/></button>
                                        </div>
                                    </div>
                                    <div className="flex gap-2 mb-4">
                                        <select className="flex-1 p-2 border rounded bg-white text-xs outline-none" onChange={(e)=>{if(e.target.value) setAssetList([...assetList, {id: Date.now(), name: e.target.value, category: "關鍵設備", note: ""}]); e.target.value="";}}>
                                            <option value="">快速加入常見系統...</option>
                                            {Object.entries(commonSystems).map(([k,v]) => <optgroup key={k} label={k}>{v.map(s => <option key={s} value={s}>{s}</option>)}</optgroup>)}
                                        </select>
                                        <button onClick={async ()=>{setAiSuggestingAssets(true); try { const r=await fetchGemini("列出8個企業SIEM核心監測資產。回傳JSON Array: [{'category', 'name', 'note'}]"); const j=JSON.parse(r.match(/\[[\s\S]*\]/)[0]); setAssetList(j.map(x=>({...x, id:Math.random()}))); } finally { setAiSuggestingAssets(false); }}} className="text-[10px] bg-indigo-50 text-indigo-700 border border-indigo-200 px-3 py-1 rounded font-bold">{aiSuggestingAssets?'推薦中...':'AI 推薦'}</button>
                                    </div>
                                    <div className="flex-1 overflow-y-auto mb-4 border rounded-xl bg-white shadow-inner">
                                        <table className="w-full text-left border-collapse">
                                            <thead className="bg-slate-50 sticky top-0 text-[10px] uppercase font-bold text-slate-400">
                                                <tr><th className="p-2 border-b">分類</th><th className="p-2 border-b">名稱</th><th className="p-2 border-b">備註</th><th className="p-2 border-b"></th></tr>
                                            </thead>
                                            <tbody className="text-xs divide-y divide-slate-100">
                                                {assetList.map(a => (
                                                    <tr key={a.id} className="group hover:bg-slate-50 transition-colors">
                                                        <td className="p-2"><input className="w-full bg-transparent outline-none" value={a.category} onChange={e=>setAssetList(assetList.map(x=>x.id===a.id?{...x, category:e.target.value}:x))}/></td>
                                                        <td className="p-2 font-bold text-slate-700"><input className="w-full bg-transparent outline-none" value={a.name} onChange={e=>setAssetList(assetList.map(x=>x.id===a.id?{...x, name:e.target.value}:x))}/></td>
                                                        <td className="p-2 italic text-slate-400"><input className="w-full bg-transparent outline-none" value={a.note} placeholder="備註..." onChange={e=>setAssetList(assetList.map(x=>x.id===a.id?{...x, note:e.target.value}:x))}/></td>
                                                        <td className="p-2 text-right"><button onClick={()=>setAssetList(assetList.filter(x=>x.id!==a.id))} className="text-red-300 opacity-0 group-hover:opacity-100 hover:text-red-600 transition-all"><Trash size={12}/></button></td>
                                                    </tr>
                                                ))}
                                            </tbody>
                                        </table>
                                    </div>
                                    <button onClick={handleAnalyze} disabled={threatLoading} className="w-full bg-indigo-600 text-white py-4 rounded-2xl font-bold shadow-lg hover:bg-indigo-700 transition-all disabled:opacity-50">
                                        {threatLoading ? <Loader2 className="animate-spin m-auto"/> : <Activity size={18} className="inline mr-2"/> + '開始交叉關聯分析'}
                                    </button>
                                </div>
                                <div className="w-7/12 p-6 overflow-y-auto bg-white">
                                    {threatData ? (
                                        <div className="space-y-6 animate-in fade-in">
                                            <div className="flex justify-between items-center border-b pb-3">
                                                <h2 className="text-xl font-black text-slate-800 flex items-center gap-2 font-mono"><ShieldCheck className="text-emerald-500"/> {threatData.timestamp} 分析</h2>
                                            </div>
                                            {threatData.scenarios?.map((s,i) => <ScenarioCard key={i} scenario={s} onAction={handleAction}/>)}
                                        </div>
                                    ) : <div className="h-full flex flex-col items-center justify-center text-slate-300 opacity-40 italic"><BrainCircuit size={100} className="mb-6"/>等待分析指令...</div>}
                                </div>
                            </div>
                        )}

                        {activeTab === 'history' && (
                            <div className="flex-1 h-full overflow-y-auto bg-slate-50 p-8 pb-32">
                                <div className="max-w-7xl mx-auto space-y-8">
                                    <div className="flex justify-between items-end">
                                        <h2 className="text-2xl font-bold">全域威脅態勢看板</h2>
                                        <div className="bg-white px-4 py-2 rounded-xl shadow-sm border font-bold text-slate-600 text-xs">總偵測項目: {Object.values(aggregated).flat().length}</div>
                                    </div>
                                    <div className="grid grid-cols-4 gap-4">
                                        {['Critical', 'High', 'Medium', 'Low'].map(l => (
                                            <div key={l} className="bg-white p-5 rounded-2xl shadow-sm border-l-4" style={{borderColor: l==='Critical'?'#9f1239':l==='High'?'#ef4444':l==='Medium'?'#f59e0b':'#3b82f6'}}>
                                                <span className="text-[10px] font-black uppercase text-slate-400">{l} Risk</span>
                                                <span className={`block text-3xl font-black ${l==='Critical'?'text-rose-900':l==='High'?'text-red-600':l==='Medium'?'text-yellow-600':'text-blue-600'}`}>{aggregated[l].length}</span>
                                            </div>
                                        ))}
                                    </div>
                                    <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">
                                        {['Critical', 'High', 'Medium', 'Low'].map(l => (
                                            <div key={l} className="bg-white rounded-3xl shadow-sm border overflow-hidden flex flex-col h-[650px]">
                                                <div className={`p-4 border-b font-black text-xs uppercase flex justify-between items-center ${l==='Critical'?'bg-rose-900 text-white':l==='High'?'bg-red-50 text-red-700':l==='Medium'?'bg-yellow-50 text-yellow-700':'bg-blue-50 text-blue-700'}`}>
                                                    <span>{l} LIST</span>
                                                    <span className="bg-white/20 px-2 rounded-full font-mono">{aggregated[l].length}</span>
                                                </div>
                                                <div className="p-3 overflow-y-auto flex-1 space-y-3 bg-slate-50/50">
                                                    {aggregated[l].map((s,i) => (
                                                        <div key={i} className="p-4 bg-white rounded-2xl border shadow-sm text-xs group relative hover:border-indigo-300 transition-all">
                                                            <div className="font-bold text-slate-800 mb-1 leading-tight">{s.title}</div>
                                                            <div className="text-[9px] text-slate-400 font-mono mb-2">{s.date}</div>
                                                            <button onClick={()=>handleAction('VISUALIZE', s)} className="absolute top-2 right-2 opacity-0 group-hover:opacity-100 text-indigo-500 hover:scale-110"><Eye size={14}/></button>
                                                        </div>
                                                    ))}
                                                </div>
                                            </div>
                                        ))}
                                    </div>
                                </div>
                            </div>
                        )}

                        {activeTab === 'visual_gallery' && (
                            <div className="flex-1 h-full overflow-y-auto bg-slate-50 p-8 pb-32">
                                <div className="max-w-7xl mx-auto space-y-8">
                                    <h2 className="text-2xl font-bold">攻擊視覺化資料庫</h2>
                                    <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                                        {visGallery.map((v, i) => (
                                            <div key={i} className="bg-white rounded-2xl shadow-sm border border-slate-200 overflow-hidden flex flex-col hover:shadow-xl transition-all cursor-pointer group" onClick={() => handleAction('VISUALIZE', v)}>
                                                <div className="p-3 border-b bg-slate-50 flex justify-between items-center">
                                                    <h4 className="font-bold text-xs truncate flex-1">{v.title}</h4>
                                                    <span className="text-[9px] text-slate-400 font-mono ml-2">{v.ts}</span>
                                                </div>
                                                <div className="p-4 bg-white flex-1 min-h-[200px] flex items-center justify-center relative overflow-hidden">
                                                    <div className="pointer-events-none transform scale-75 origin-center"><AttackGraph mermaidCode={v.mermaid_code} /></div>
                                                </div>
                                            </div>
                                        ))}
                                        {visGallery.length === 0 && <div className="col-span-full py-20 text-center text-slate-400 bg-white rounded-3xl border-2 border-dashed font-bold">尚未產生任何圖表紀錄</div>}
                                    </div>
                                </div>
                            </div>
                        )}

                        {/* TAB: LOG GUIDES */}
                        {activeTab === 'log_guides' && (
                            <div className="flex-1 h-full overflow-y-auto bg-slate-50 p-8 pb-32 animate-in fade-in">
                                <div className="max-w-7xl mx-auto space-y-8">
                                    <div><h2 className="text-2xl font-bold flex items-center gap-3"><ClipboardList className="text-indigo-600"/> Log 收集指引知識庫</h2><p className="text-slate-500 text-sm mt-1">從所有歷史威脅情境分析中提取出的系統級日誌採集指南</p></div>
                                    <div className="grid grid-cols-1 gap-6">
                                        {logGuideGallery.map((g, i) => (
                                            <div key={i} className="bg-white rounded-3xl shadow-sm border border-slate-200 overflow-hidden flex flex-col hover:border-indigo-300 transition-all p-6">
                                                <div className="flex flex-col md:flex-row justify-between md:items-center mb-6 gap-4 border-b border-slate-100 pb-4">
                                                    <div className="flex items-center gap-4">
                                                        <div className="p-3 bg-indigo-100 text-indigo-600 rounded-2xl"><Server size={24}/></div>
                                                        <div>
                                                            <h4 className="font-black text-xl text-slate-800 tracking-tight">{g.system}</h4>
                                                            <p className="text-xs text-slate-400 font-bold uppercase tracking-widest">來源: {g.source_type}</p>
                                                        </div>
                                                    </div>
                                                    <div className="bg-slate-50 px-4 py-2 rounded-xl border text-[10px] font-mono text-slate-400 flex items-center gap-2"><History size={12}/> {g.source_date}</div>
                                                </div>
                                                <div className="grid md:grid-cols-2 gap-8">
                                                    <div className="space-y-3">
                                                        <h5 className="flex items-center gap-2 text-indigo-600 font-black text-xs uppercase tracking-wider"><Database size={14}/> 應收集項目 (Logging Items)</h5>
                                                        <div className="p-4 bg-slate-50 rounded-2xl border border-slate-100 text-sm text-slate-700 leading-relaxed min-h-[100px] shadow-inner">
                                                            {g.log_items}
                                                        </div>
                                                    </div>
                                                    <div className="space-y-3">
                                                        <h5 className="flex items-center gap-2 text-emerald-600 font-black text-xs uppercase tracking-wider"><RefreshCw size={14}/> 設定與調校建議 (Config Advice)</h5>
                                                        <div className="p-4 bg-emerald-50/30 rounded-2xl border border-emerald-100 text-sm text-slate-700 leading-relaxed min-h-[100px] shadow-inner">
                                                            {g.config_advice}
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                        ))}
                                        {logGuideGallery.length === 0 && (
                                            <div className="col-span-full py-24 text-center text-slate-400 bg-white rounded-[2.5rem] border-2 border-dashed border-slate-200 font-bold flex flex-col items-center gap-4 opacity-50">
                                                <ClipboardList size={64} className="opacity-20"/>
                                                <div className="text-lg">目前無 Log 收集指引紀錄</div>
                                                <p className="text-sm font-normal">請先執行威脅分析，系統會自動將指引存放於此。</p>
                                            </div>
                                        )}
                                    </div>
                                </div>
                            </div>
                        )}
                    </div>

                    {/* Modal: Visualize */}
                    {visualizeModalOpen && selectedScenarioForVis && (
                        <div className="fixed inset-0 bg-slate-900/95 backdrop-blur-md z-[110] flex items-center justify-center p-8 animate-in fade-in duration-300">
                            <div className="bg-white rounded-3xl w-full max-w-7xl h-[90vh] flex flex-col shadow-2xl overflow-hidden ring-1 ring-white/10">
                                <div className="bg-slate-900 text-white p-6 flex justify-between items-center shrink-0 border-b border-white/5">
                                    <div><h3 className="font-bold text-xl flex items-center gap-3"><Eye className="text-indigo-400"/> 攻擊鏈路徑深度分析儀</h3><p className="text-xs text-slate-400 mt-1 font-mono">{selectedScenarioForVis.title}</p></div>
                                    <button onClick={()=>setVisualizeModalOpen(false)} className="p-2 hover:bg-slate-800 rounded-full transition-colors"><X size={28}/></button>
                                </div>
                                <div className="flex-1 flex overflow-hidden">
                                    <div className="w-8/12 p-8 bg-slate-50 flex flex-col overflow-y-auto border-r border-slate-200 relative">
                                        <div className="flex justify-between items-center mb-6">
                                            <h4 className="font-black text-slate-600 uppercase tracking-widest text-[10px] flex items-center gap-2"><Waypoints size={16}/> ATTACK PATH TOPOLOGY</h4>
                                            {!selectedScenarioForVis.mermaid_code && (
                                                <button onClick={handleRegenVis} disabled={visLoading} className="text-xs bg-indigo-600 text-white px-5 py-2 rounded-xl font-bold shadow-lg hover:bg-indigo-700 disabled:opacity-50 flex items-center gap-2 transition-all active:scale-95">
                                                    {visLoading ? <Loader2 size={14} className="animate-spin"/> : <Sparkles size={14}/>} AI 重新繪製
                                                </button>
                                            )}
                                        </div>
                                        <div className="flex-1 bg-white rounded-3xl border shadow-xl p-8 flex items-center justify-center min-h-[500px] overflow-auto">
                                            {selectedScenarioForVis.mermaid_code ? <AttackGraph mermaidCode={selectedScenarioForVis.mermaid_code} /> : <div className="text-slate-300 italic">無流程數據</div>}
                                        </div>
                                    </div>
                                    <div className="w-4/12 p-8 overflow-y-auto bg-white">
                                        <h4 className="font-black text-slate-600 uppercase tracking-widest text-[10px] mb-8">SIEM 數據監測矩陣</h4>
                                        <div className="space-y-5">
                                            {(selectedScenarioForVis.data_sources || []).map((ds, idx) => (
                                                <div key={idx} className="p-5 border border-indigo-50 rounded-3xl bg-indigo-50/20 group">
                                                    <div className="flex justify-between mb-3 font-black text-[9px] uppercase tracking-widest text-indigo-500"><span>Device Type</span><span>STAGE {idx+1}</span></div>
                                                    <div className="font-bold text-slate-800 text-base mb-3 leading-tight">{ds.device}</div>
                                                    <div className="text-xs font-mono bg-white p-3 rounded-xl border border-indigo-100 text-indigo-900 shadow-inner break-all select-all">{ds.event}</div>
                                                </div>
                                            ))}
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    )}

                    {/* Tool Modals */}
                    {activeModal && (
                        <div className="fixed inset-0 bg-slate-900/90 z-[120] flex items-center justify-center p-8 animate-in fade-in backdrop-blur-sm">
                             <div className="bg-white rounded-[2rem] w-full max-w-5xl h-[80vh] flex flex-col shadow-2xl overflow-hidden">
                                <div className="bg-slate-800 text-white p-6 flex justify-between items-center shrink-0">
                                    <h3 className="font-black uppercase tracking-widest flex items-center gap-3"><Wrench size={20} className="text-indigo-400"/> SOC Pro Tool: {activeModal}</h3>
                                    <button onClick={()=>setActiveModal(null)} className="hover:bg-slate-700 p-2 rounded-full transition-all"><X size={24}/></button>
                                </div>
                                <div className="flex-1 flex overflow-hidden">
                                    <div className="w-1/3 p-8 bg-slate-50 border-r border-slate-200">
                                        <label className="text-[10px] font-black text-slate-500 uppercase block mb-3 tracking-widest">Input Data</label>
                                        <textarea className="w-full h-4/5 p-4 border border-slate-200 rounded-2xl text-xs font-mono resize-none focus:ring-4 focus:ring-indigo-100 outline-none transition-all" value={toolInput} onChange={e=>setToolInput(e.target.value)} placeholder="在此貼上分析內容..."/>
                                        <button onClick={()=>handleToolAction(activeModal)} disabled={toolLoading} className="mt-5 w-full bg-indigo-600 text-white py-3.5 rounded-2xl font-black text-sm shadow-xl hover:bg-indigo-700 transition-all disabled:opacity-50">
                                            {toolLoading ? <Loader2 size={20} className="animate-spin m-auto"/> : '啟動 AI 分析執行'}
                                        </button>
                                    </div>
                                    <div className="w-2/3 p-10 overflow-y-auto bg-white">
                                        {toolResult ? <RenderMarkdown text={toolResult}/> : <div className="h-full flex items-center justify-center text-slate-300 italic flex-col gap-4 opacity-40 font-bold"><Microscope size={60}/>等待 AI 計算處理中...</div>}
                                    </div>
                                </div>
                             </div>
                        </div>
                    )}

                    {/* Chat Modal (GIANT PRO 800x850) */}
                    {isChatOpen && (
                        <div className={`fixed bottom-6 right-6 ${isChatMaximized ? 'inset-6 w-auto h-auto' : 'w-[800px] h-[850px]'} bg-white rounded-[2.5rem] shadow-2xl flex flex-col border border-slate-200 z-[100] transition-all animate-in slide-in-from-bottom-5 duration-300 overflow-hidden ring-1 ring-black/5 shadow-2xl`}>
                            <div className="bg-slate-900 text-white p-6 flex justify-between items-center shrink-0 shadow-xl border-b border-white/5">
                                <div className="flex items-center gap-5"><div className="p-3 bg-indigo-500 rounded-2xl shadow-inner animate-pulse-slow"><Sparkles size={28}/></div><div><h3 className="font-black text-xl m-0 leading-none text-white">SOC Copilot AI</h3><p className="text-[10px] text-slate-400 font-bold uppercase tracking-[0.2em] mt-2">Enterprise Defense Assistant</p></div></div>
                                <div className="flex gap-2"><button onClick={()=>setIsChatMaximized(!isChatMaximized)} className="p-2.5 hover:bg-slate-800 rounded-xl transition-all">{isChatMaximized ? <Minimize2 size={22}/> : <Maximize2 size={22}/>}</button><button onClick={()=>setIsChatOpen(false)} className="p-2.5 hover:bg-slate-800 rounded-xl transition-all"><X size={22}/></button></div>
                            </div>
                            <div className="flex-1 overflow-y-auto p-10 space-y-8 bg-slate-50 chat-scroll">
                                {chatHistory.map((m, i) => (
                                    <div key={i} className={`flex ${m.role === 'user' ? 'justify-end' : 'justify-start'}`}>
                                        <div className={`max-w-[90%] p-6 rounded-3xl shadow-sm leading-relaxed ${m.role === 'user' ? 'bg-indigo-600 text-white rounded-tr-none' : 'bg-white text-slate-700 border border-slate-100 rounded-tl-none'}`}>
                                            {m.role === 'bot' ? <RenderMarkdown text={m.text}/> : <p className="text-sm font-medium">{m.text}</p>}
                                        </div>
                                    </div>
                                ))}
                                <div ref={chatEndRef}/>
                            </div>
                            <form onSubmit={handleChatSubmit} className="p-8 border-t bg-white flex gap-5">
                                <input className="flex-1 p-5 border border-slate-200 rounded-3xl text-base outline-none focus:border-indigo-500 focus:ring-4 focus:ring-indigo-50 transition-all font-medium" placeholder="詢問威脅情資、查詢語法、應變劇本..." value={chatInput} onChange={e=>setChatInput(e.target.value)} disabled={chatLoading}/>
                                <button type="submit" disabled={chatLoading} className="bg-indigo-600 text-white p-5 rounded-3xl hover:bg-indigo-700 disabled:opacity-50 transition-all shadow-xl flex items-center justify-center hover:scale-105 active:scale-95">
                                    {chatLoading ? <Loader2 size={32} className="animate-spin"/> : <Send size={32}/>}
                                </button>
                            </form>
                        </div>
                    )}

                    {/* Troubleshooting Modal */}
                    {troubleshootType && (
                        <div className="fixed inset-0 bg-slate-900/95 z-[300] flex items-center justify-center p-8 animate-in fade-in duration-200">
                             <div className="bg-white rounded-[2.5rem] w-full max-w-2xl shadow-2xl overflow-hidden p-10 flex flex-col items-center text-center">
                                <div className="p-5 bg-red-50 rounded-full mb-6 animate-pulse"><AlertTriangle size={64} className="text-red-500"/></div>
                                <h3 className="text-2xl font-black text-slate-800 mb-3">{troubleshootType === 'FIREBASE_PERMISSION' ? '資料庫權限不足' : 'Google API 網域封鎖'}</h3>
                                <p className="text-slate-600 mb-10 leading-relaxed text-sm">
                                    {troubleshootType === 'FIREBASE_PERMISSION' ? 
                                        '偵測到 Firestore 被拒絕。請前往 Firebase Console > Firestore Database > Rules，將規則改為：allow read, write: if true;' : 
                                        '您的 API Key 有網域限制。請前往 Google Cloud Console > Credentials，將 Application Restrictions 設為 None。'}
                                </p>
                                <button onClick={()=>setTroubleshootType(null)} className="bg-slate-900 text-white px-10 py-4 rounded-2xl font-black shadow-xl hover:bg-black transition-all">關閉重試</button>
                             </div>
                        </div>
                    )}

                    {/* Toast */}
                    {toast && (
                        <div className={`fixed bottom-10 left-1/2 -translate-x-1/2 px-8 py-4 rounded-3xl text-white text-sm font-black shadow-2xl animate-fade-in-up z-[200] flex items-center gap-3 ${toast.type==='error'?'bg-red-600':'bg-emerald-600'}`}>
                            {toast.type==='success' ? <LucideIcons.CheckCircle size={20}/> : <LucideIcons.AlertTriangle size={20}/>}
                            {toast.message}
                        </div>
                    )}
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(React.createElement(WarRoom));
    </script>
</body>
</html>